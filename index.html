<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Varsha Fruits and Goods</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (Cloud Sync) - compat build for simple usage in plain script -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

  <style>
    :root { color-scheme: light; }
    .promo-marquee {
      --speed: 18s;
      overflow: hidden;
      position: relative;
      mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
    }
    .promo-track { display: flex; width: max-content; animation: marquee var(--speed) linear infinite; }
    @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(-50%); } }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.75); }
    .no-spin::-webkit-outer-spin-button, .no-spin::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .no-spin { -moz-appearance: textfield; }
    .fade-in { animation: fadeIn .25s ease-out; }
    @keyframes fadeIn { from { opacity: .25; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }

    /* When customer footer is visible we add body.pb-24; lift toast a bit */
    body.pb-24 #toast { bottom: 5.5rem; }

    /* Active route (header + sidebar) */
    .route-btn.active-route { background: #0f172a; color: white; }
    .route-btn.active-route:hover { background: #1e293b; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Top Nav -->
  <header class="sticky top-0 z-40 border-b bg-white/80 glass">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between gap-3">
        <button id="brandBtn" type="button" class="flex items-center gap-3 text-left select-none" title="Double click untuk Maintain Profile (Admin)">
          <div class="h-9 w-9 rounded-xl overflow-hidden border border-slate-200 bg-white">
            <div id="storeLogoFallback" class="h-full w-full bg-gradient-to-br from-emerald-500 to-lime-400"></div>
            <img id="storeLogoImg" alt="Logo" class="hidden h-full w-full object-cover" />
          </div>
          <div>
            <div id="storeNameHeader" class="text-sm font-semibold leading-4">Varsha</div>
            <div id="storeTaglineHeader" class="text-xs text-slate-500 leading-4">Fruits and Goods</div>
          </div>
        </button>

        <nav class="hidden md:flex items-center gap-1">
          <button data-route="market" class="route-btn rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100">Marketplace</button>
          <button data-route="customer.shipping" class="route-btn customer-only rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100">Status Pengiriman</button>
          <button data-route="admin.dashboard" class="route-btn admin-only rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100">Admin ‚Ä¢ Dashboard</button>
        </nav>

        <div class="flex items-center gap-2">
          <button id="mobileMenuBtn" class="admin-only md:hidden rounded-lg p-2 hover:bg-slate-100" aria-label="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>

          <button id="cloudNavStatus" type="button" class="inline-flex items-center gap-2 rounded-full border bg-white px-3 py-2 text-xs font-semibold hover:bg-slate-50" title="Cloud Sync (klik untuk buka pengaturan)">
            <span id="cloudNavDot" class="h-2 w-2 rounded-full bg-slate-300"></span>
            <span id="cloudNavText">Cloud: Offline</span>
          </button>

          <button id="reloadBtn" class="rounded-lg p-2 hover:bg-slate-100" title="Reload data (Pull dari Cloud jika tersedia)" aria-label="Reload">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9c2.2 0 4.2.8 5.8 2.1"/><path d="M21 3v6h-6"/></svg>
          </button>

          <button id="openAuthBtn" class="rounded-lg px-3 py-2 text-sm font-semibold border hover:bg-slate-100">Masuk</button>

          <div id="userNav" class="hidden items-center gap-2">
            <div id="userChip" class="hidden sm:inline-flex items-center gap-2 rounded-full border bg-white px-3 py-2 text-xs font-semibold">
              <span id="userNameLabel" class="max-w-[140px] truncate">User</span>
              <span id="userRoleLabel" class="rounded-full bg-slate-900 px-2 py-0.5 text-[10px] font-extrabold text-white">CUSTOMER</span>
            </div>
            <!-- Logout (default position, for Admin). For Customer, this will be hidden and shown in the row below. -->
            <button id="logoutBtn" class="rounded-lg px-3 py-2 text-sm font-semibold border hover:bg-slate-100">Keluar</button>
          </div>

          <button id="openCartBtn" class="relative rounded-lg px-3 py-2 text-sm font-semibold bg-emerald-600 text-white hover:bg-emerald-700">
            Keranjang
            <span id="cartCountBadge" class="absolute -right-2 -top-2 hidden min-w-5 rounded-full bg-rose-600 px-1.5 text-xs leading-5 text-white text-center">0</span>
          </button>
        </div>
      </div>


      <div id="mobileNav" class="md:hidden hidden pb-3">
        <div class="grid grid-cols-2 gap-2">
          <button data-route="market" class="route-btn rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100 border">Marketplace</button>
          <button data-route="customer.shipping" class="route-btn customer-only rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100 border">Status Pengiriman</button>
          <button data-route="admin.dashboard" class="route-btn admin-only rounded-lg px-3 py-2 text-sm font-medium hover:bg-slate-100 border">Admin ‚Ä¢ Dashboard</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    <!-- MARKETPLACE -->
    <section id="view-market" class="view fade-in">
      <!-- Hero -->
      <div class="relative overflow-hidden rounded-3xl border bg-gradient-to-br from-emerald-600 via-emerald-500 to-lime-400">
        <div class="absolute inset-0 opacity-25" style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,.6), transparent 45%), radial-gradient(circle at 80% 30%, rgba(255,255,255,.45), transparent 55%), radial-gradient(circle at 50% 90%, rgba(255,255,255,.35), transparent 50%);"></div>
        <div class="relative p-6 sm:p-10">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
            <div class="max-w-2xl text-white">
              <div id="heroBadge" class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-xs font-semibold">Marketplace ‚Ä¢ Buah Segar Harian</div>
              <h1 id="heroHeadline" class="mt-4 text-3xl sm:text-4xl font-extrabold leading-tight">Belanja buah segar, cepat, dan hemat di <span class="underline decoration-white/60">Varsha Fruits and Goods</span></h1>
              <p id="heroSubheadline" class="mt-3 text-white/90">Pilih buah lokal, impor, musiman, dan tropis. Promo berjalan otomatis, stok real-time, checkout sederhana.</p>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="rounded-xl bg-white text-emerald-700 px-4 py-2 text-sm font-bold hover:bg-white/95" id="heroCtaBtn">Lihat Produk</button>
                <button class="admin-only rounded-xl bg-white/15 text-white px-4 py-2 text-sm font-semibold hover:bg-white/20" data-route="admin.dashboard">Masuk Admin</button>
              </div>
            </div>
            <div class="w-full lg:w-[420px]">
              <div class="rounded-2xl bg-white/15 border border-white/25 p-4">
                <div class="flex items-center justify-between">
                  <div class="text-white">
                    <div class="text-sm font-semibold">Keunggulan</div>
                    <div class="text-xs text-white/85">Harga transparan & profit tercatat</div>
                  </div>
                  <div class="h-10 w-10 rounded-xl bg-white/20"></div>
                </div>
                <ul class="mt-3 space-y-2 text-sm text-white/95">
                  <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-white"></span><span>Badge diskon untuk produk promo</span></li>
                  <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-white"></span><span>Keranjang & checkout + riwayat transaksi</span></li>
                  <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-white"></span><span>Dashboard admin: omzet, keuntungan, grafik penjualan</span></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Promo marquee -->
      <div class="mt-6 rounded-2xl border bg-white p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">Promo Berjalan</div>
            <div class="text-xs text-slate-500">Banner animasi (otomatis menampilkan promo aktif)</div>
          </div>
          <button id="managePromosQuickBtn" class="admin-only text-sm font-semibold text-emerald-700 hover:underline" data-route="admin.promos">Kelola Promo</button>
        </div>
        <div class="mt-3 promo-marquee rounded-xl bg-gradient-to-r from-emerald-50 to-lime-50 border">
          <div id="promoTrack" class="promo-track py-2"></div>
        </div>
      </div>

      <!-- Filters / Categories -->
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-8">
          <div class="rounded-2xl border bg-white p-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Kategori Buah</div>
                <div class="text-xs text-slate-500">Lokal ‚Ä¢ Impor ‚Ä¢ Musiman ‚Ä¢ Tropis</div>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs text-slate-500">Filter</label>
                <select id="categoryFilter" class="rounded-xl border px-3 py-2 text-sm bg-white">
                  <option value="">Semua</option>
                  <option value="Lokal">Lokal</option>
                  <option value="Impor">Impor</option>
                  <option value="Musiman">Musiman</option>
                  <option value="Tropis">Tropis</option>
                </select>
              </div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              <button data-cat="" class="cat-pill rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Semua</button>
              <button data-cat="Lokal" class="cat-pill rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Lokal</button>
              <button data-cat="Impor" class="cat-pill rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Impor</button>
              <button data-cat="Musiman" class="cat-pill rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Musiman</button>
              <button data-cat="Tropis" class="cat-pill rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Tropis</button>
            </div>
          </div>
        </div>
        <div class="lg:col-span-4">
          <div class="rounded-2xl border bg-white p-4">
            <div class="text-sm font-semibold">Pencarian</div>
            <div class="mt-2 flex gap-2">
              <input id="searchInput" class="w-full rounded-xl border px-3 py-2 text-sm" placeholder="Cari buah..." />
              <button id="resetSearchBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
            </div>
            <div class="mt-3 text-xs text-slate-500">Tips: gunakan kata seperti ‚Äúapel‚Äù, ‚Äúpisang‚Äù, ‚Äúmangga‚Äù.</div>
          </div>
        </div>
      </div>

      <!-- Products -->
      <div id="productsAnchor" class="mt-6"></div>
      <div class="flex items-end justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold">Daftar Produk</h2>
          <p class="text-sm text-slate-500">Klik ‚ÄúTambah‚Äù untuk memasukkan ke keranjang.</p>
        </div>
        <div class="text-sm text-slate-500">Menampilkan <span id="productCount">0</span> produk</div>
      </div>

      <div id="productGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

      <div id="emptyProducts" class="mt-8 hidden rounded-2xl border bg-white p-8 text-center">
        <div class="text-base font-semibold">Tidak ada produk yang cocok</div>
        <div class="mt-1 text-sm text-slate-500">Coba ganti kategori atau kata kunci.</div>
      </div>
    </section>

    <!-- CUSTOMER: STATUS PENGIRIMAN -->
    <section id="view-customer-shipping" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Status Pengiriman</h2>
          <p class="text-sm text-slate-500">Cek status order kamu (Pending/Diproses/Dikirim/Selesai). Data diambil dari transaksi yang dibuat saat checkout.</p>
        </div>
        <div class="text-xs text-slate-500">Tips: Pastikan login memakai email yang sama seperti saat checkout.</div>
      </div>

      <div id="custShipLoginHint" class="mt-4 hidden rounded-2xl border bg-white p-5">
        <div class="font-extrabold">Silakan login untuk melihat status pengiriman</div>
        <div class="mt-1 text-sm text-slate-500">Status pengiriman ditampilkan berdasarkan email akun customer.</div>
        <div class="mt-1 text-xs text-slate-500">Catatan: order lama (sebelum update) yang belum punya email mungkin tidak muncul.</div>
        <div class="mt-3">
          <button id="custShipLoginBtn" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-bold text-white hover:bg-slate-800">Masuk</button>
        </div>
      </div>

      <div id="custShipMain" class="mt-4 rounded-2xl border bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div class="flex items-center gap-2">
            <input id="custShipSearch" class="w-full md:w-96 rounded-xl border px-3 py-2 text-sm" placeholder="Cari ID order..." />
            <button id="custShipSearchReset" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Status</label>
            <select id="custShipStatusFilter" class="rounded-xl border bg-white px-3 py-2 text-sm">
              <option value="">Semua</option>
              <option value="pending">Pending</option>
              <option value="processing">Diproses</option>
              <option value="shipped">Dikirim</option>
              <option value="delivered">Selesai</option>
              <option value="canceled">Batal</option>
            </select>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left font-semibold">ID</th>
                <th class="py-2 text-left font-semibold">Tanggal</th>
                <th class="py-2 text-left font-semibold">Total</th>
                <th class="py-2 text-left font-semibold">Ongkir</th>
                <th class="py-2 text-left font-semibold">Tagihan</th>
                <th class="py-2 text-left font-semibold">Status</th>
                <th class="py-2 text-left font-semibold">Update</th>
              </tr>
            </thead>
            <tbody id="custShipBody"></tbody>
          </table>
        </div>

        <div id="custShipEmpty" class="hidden mt-6 rounded-xl border bg-slate-50 p-6 text-center">
          <div class="font-semibold">Belum ada order</div>
          <div class="text-sm text-slate-500 mt-1">Silakan order dari Marketplace untuk melihat status pengiriman.</div>
        </div>
      </div>
    </section>

    <!-- ADMIN LAYOUT (Admin Views) -->
    <div id="adminLayout" class="admin-only hidden">
      <div>

    <!-- ADMIN HERO (Maintain Hero Section) -->
    <section id="view-admin-hero" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Maintain Hero Section</h2>
          <p class="text-sm text-slate-500">Ubah konten banner utama Marketplace (headline, subheadline, badge) tanpa mengubah kode.</p>
        </div>
        <div class="flex gap-2">
          <button id="resetHeroBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Reset Hero</button>
          <button id="saveHeroBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Simpan</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-6 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Form Hero</div>
          <div class="mt-3 space-y-3">
            <div>
              <label class="text-xs text-slate-500">Badge (teks kecil)</label>
              <input id="heroBadgeInput" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Marketplace ‚Ä¢ Buah Segar Harian" />
            </div>
            <div>
              <label class="text-xs text-slate-500">Headline</label>
              <textarea id="heroHeadlineInput" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Belanja buah segar, cepat, dan hemat di Varsha Fruits and Goods"></textarea>
              <div class="mt-1 text-xs text-slate-500">Tips: gunakan <span class="font-mono">Varsha Fruits and Goods</span> untuk branding.</div>
            </div>
            <div>
              <label class="text-xs text-slate-500">Subheadline</label>
              <textarea id="heroSubheadlineInput" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Pilih buah lokal, impor, musiman, dan tropis..." ></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500">Label Tombol CTA</label>
                <input id="heroCtaLabelInput" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Lihat Produk" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Aksi Tombol CTA</label>
                <select id="heroCtaActionInput" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm">
                  <option value="scroll_products">Scroll ke Produk</option>
                  <option value="open_cart">Buka Keranjang</option>
                </select>
              </div>
            </div>
            <div class="rounded-xl border bg-slate-50 p-3 text-xs text-slate-600">
              Perubahan hero akan langsung terlihat di Marketplace dan ikut tersinkron jika Cloud Sync aktif.
            </div>
          </div>
        </div>

        <div class="lg:col-span-6 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Preview</div>
              <div class="text-xs text-slate-500">Pratinjau ringkas tampilan hero</div>
            </div>
            <button id="applyHeroPreviewBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Preview</button>
          </div>

          <div class="mt-3 rounded-3xl border bg-gradient-to-br from-emerald-600 via-emerald-500 to-lime-400 overflow-hidden">
            <div class="p-6">
              <div id="heroPreviewBadge" class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-xs font-semibold text-white">Marketplace ‚Ä¢ Buah Segar Harian</div>
              <div id="heroPreviewHeadline" class="mt-4 text-2xl sm:text-3xl font-extrabold leading-tight text-white">Belanja buah segar, cepat, dan hemat di Varsha Fruits and Goods</div>
              <div id="heroPreviewSubheadline" class="mt-2 text-sm text-white/90">Pilih buah lokal, impor, musiman, dan tropis. Promo berjalan otomatis, stok real-time, checkout sederhana.</div>
              <div class="mt-4">
                <span id="heroPreviewCta" class="inline-flex rounded-xl bg-white text-emerald-700 px-4 py-2 text-sm font-bold">Lihat Produk</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN PROFILE (Maintain Store Profile) -->
    <section id="view-admin-profile" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Maintain Profile Toko</h2>
          <p class="text-sm text-slate-500">Ubah logo, nama toko, rekening pembayaran, dan alamat toko. Akses: double click logo (khusus Admin + kode referensi).</p>
        </div>
        <div class="flex gap-2">
          <button id="resetProfileBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
          <button id="saveProfileBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Simpan</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-6 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Form Profile</div>

          <div class="mt-3 space-y-3">
            <div>
              <label class="text-xs text-slate-500">Nama Toko</label>
              <input id="profileStoreName" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Varsha" />
            </div>
            <div>
              <label class="text-xs text-slate-500">Tagline (opsional)</label>
              <input id="profileTagline" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Fruits and Goods" />
            </div>

            <div>
              <label class="text-xs text-slate-500">Alamat Toko</label>
              <textarea id="profileAddress" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="Alamat lengkap toko..."></textarea>
            </div>

            <div class="rounded-xl border bg-slate-50 p-3">
              <div class="text-xs font-bold text-slate-700">Informasi Rekening (untuk pembayaran)</div>
              <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-500">Bank</label>
                  <input id="profileBankName" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm" placeholder="cth: BCA" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">No. Rekening</label>
                  <input id="profileBankAccount" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm font-mono" placeholder="cth: 1234567890" />
                </div>
                <div class="sm:col-span-2">
                  <label class="text-xs text-slate-500">Atas Nama</label>
                  <input id="profileBankHolder" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm" placeholder="cth: Varsha Fruits" />
                </div>
              </div>
            </div>

            <div class="rounded-2xl border p-3">
              <div class="text-xs font-bold text-slate-700">Logo Toko</div>
              <div class="mt-2 flex items-start gap-3">
                <img id="profileLogoPreview" class="h-16 w-16 rounded-xl object-cover border bg-slate-50" alt="Preview" src="https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=200&q=60" />
                <div class="flex-1">
                  <div class="flex flex-col sm:flex-row gap-2">
                    <input id="profileLogoFile" type="file" accept="image/*" class="block w-full text-sm file:mr-3 file:rounded-xl file:border-0 file:bg-slate-900 file:px-4 file:py-2 file:text-sm file:font-bold file:text-white hover:file:bg-slate-800" />
                    <button id="uploadProfileLogoBtn" type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Upload</button>
                    <button id="saveProfileLogoBtn" type="button" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Simpan Logo</button>
                  </div>
                  <div id="profileUploadProgressWrap" class="hidden mt-2">
                    <div class="h-2 w-full rounded-full bg-slate-100 overflow-hidden">
                      <div id="profileUploadProgressBar" class="h-2 bg-emerald-600" style="width:0%"></div>
                    </div>
                    <div id="profileUploadProgressText" class="mt-1 text-xs text-slate-500">0%</div>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Upload disimpan di <b>Firebase Storage</b> pada Shop ID yang sama (butuh Cloud Sync tersambung). Setelah upload, klik <b>Simpan Logo</b> untuk menerapkan di toko. Atau tempel URL logo di bawah lalu klik <b>Simpan Logo</b>.</div>
                </div>
              </div>
              <div class="mt-3">
                <label class="text-xs text-slate-500">URL Logo (opsional)</label>
                <input id="profileLogoUrl" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm font-mono" placeholder="https://..." />
              </div>
            </div>

            <div class="rounded-xl border bg-amber-50 p-3 text-xs text-amber-900">
              <div class="font-extrabold">Catatan</div>
              <div class="mt-1">Perubahan profile akan tampil di header & modal login. Jika Cloud Sync aktif, profile ikut tersinkron antar gadget.</div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-6 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Preview</div>
              <div class="text-xs text-slate-500">Pratinjau tampilan brand di header</div>
            </div>
            <button id="applyProfilePreviewBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Preview</button>
          </div>

          <div class="mt-3 rounded-2xl border bg-slate-50 p-4">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl overflow-hidden border bg-white">
                <div id="profilePreviewLogoFallback" class="h-full w-full bg-gradient-to-br from-emerald-500 to-lime-400"></div>
                <img id="profilePreviewLogoImg" class="hidden h-full w-full object-cover" alt="Logo" />
              </div>
              <div>
                <div id="profilePreviewName" class="text-sm font-extrabold">Varsha</div>
                <div id="profilePreviewTagline" class="text-xs text-slate-500">Fruits and Goods</div>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div class="rounded-xl border bg-white p-3">
                <div class="text-xs text-slate-500">Rekening</div>
                <div id="profilePreviewBank" class="mt-1 font-semibold">-</div>
              </div>
              <div class="rounded-xl border bg-white p-3">
                <div class="text-xs text-slate-500">Alamat</div>
                <div id="profilePreviewAddress" class="mt-1 text-slate-700">-</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN DASHBOARD -->
    <section id="view-admin-dashboard" class="view hidden fade-in">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">üìä Dashboard Admin</h2>
          <p class="text-sm text-slate-500">Ringkasan omzet, transaksi, produk terjual, keuntungan + grafik.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 sm:items-end">
          <div>
            <label class="text-xs text-slate-500">Periode</label>
            <select id="periodSelect" class="mt-1 w-full sm:w-auto rounded-xl border bg-white px-3 py-2 text-sm">
              <option value="today">Hari ini</option>
              <option value="week">Minggu ini</option>
              <option value="month" selected>Bulan ini</option>
              <option value="year">Tahun ini</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Dari</label>
            <input id="dateFrom" type="date" class="mt-1 rounded-xl border bg-white px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="text-xs text-slate-500">Sampai</label>
            <input id="dateTo" type="date" class="mt-1 rounded-xl border bg-white px-3 py-2 text-sm" />
          </div>
          <button id="applyPeriodBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Terapkan</button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-xs text-slate-500">Omzet</div>
          <div id="sumRevenue" class="mt-1 text-2xl font-extrabold">Rp0</div>
          <div id="sumRevenueSub" class="mt-1 text-xs text-slate-500">Total pendapatan dalam periode</div>
        </div>
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-xs text-slate-500">Transaksi</div>
          <div id="sumTransactions" class="mt-1 text-2xl font-extrabold">0</div>
          <div class="mt-1 text-xs text-slate-500">Jumlah order checkout</div>
        </div>
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-xs text-slate-500">Produk Terjual</div>
          <div id="sumUnits" class="mt-1 text-2xl font-extrabold">0</div>
          <div class="mt-1 text-xs text-slate-500">Total item (qty) terjual</div>
        </div>
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-xs text-slate-500">Keuntungan</div>
          <div id="sumProfit" class="mt-1 text-2xl font-extrabold">Rp0</div>
          <div class="mt-1 text-xs text-slate-500">Revenue - biaya beli</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-8 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Grafik Penjualan</div>
              <div class="text-xs text-slate-500">Line chart omzet per hari</div>
            </div>
            <button id="resetDemoDataBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50" title="Reset data demo (produk, transaksi, pembelian, promo)">Reset Data Demo</button>
          </div>
          <div class="mt-3 h-72">
            <canvas id="salesLine"></canvas>
          </div>
        </div>
        <div class="lg:col-span-4 rounded-2xl border bg-white p-4">
          <div>
            <div class="text-sm font-semibold">Produk Terlaris</div>
            <div class="text-xs text-slate-500">Doughnut chart (qty)</div>
          </div>
          <div class="mt-3 h-72">
            <canvas id="topDoughnut"></canvas>
          </div>
        </div>
      </div>

      <div class="mt-6 rounded-2xl border bg-white p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">Transaksi Terbaru</div>
            <div class="text-xs text-slate-500">Maks. 8 transaksi terakhir</div>
          </div>
          <div class="flex items-center gap-3">
            <button class="text-sm font-semibold text-sky-700 hover:underline" data-route="admin.shipping">Kelola Pengiriman</button>
            <button class="text-sm font-semibold text-emerald-700 hover:underline" data-route="admin.transactions">Lihat semua</button>
          </div>
        </div>
        <div class="mt-3 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left font-semibold">ID</th>
                <th class="py-2 text-left font-semibold">Tanggal</th>
                <th class="py-2 text-left font-semibold">Pembeli</th>
                <th class="py-2 text-left font-semibold">Total</th>
                <th class="py-2 text-left font-semibold">Profit</th>
                <th class="py-2 text-left font-semibold">Item</th>
              </tr>
            </thead>
            <tbody id="latestTxBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ADMIN PRODUCTS -->
    <section id="view-admin-products" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Kelola Produk</h2>
          <p class="text-sm text-slate-500">Tambah/edit/hapus produk, set harga beli & jual, dan stok.</p>
        </div>
        <div class="flex gap-2">
          <button id="addProductBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">+ Tambah Produk</button>
          <button id="seedStockLowBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Filter Stok &lt; 10</button>
        </div>
      </div>

      <!-- Panduan -->
      <div class="mt-4 rounded-2xl border bg-white p-4">
        <details class="group">
          <summary class="cursor-pointer list-none select-none flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-extrabold">Panduan Kelola Produk</div>
              <div class="text-xs text-slate-500">Klik untuk melihat cara tambah/edit/hapus, stok, dan harga.</div>
            </div>
            <div class="rounded-xl border px-3 py-1.5 text-sm font-semibold group-open:bg-slate-900 group-open:text-white">Lihat</div>
          </summary>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-slate-700">
            <div class="rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">1) Tambah Produk</div>
              <ol class="mt-2 list-decimal pl-5 space-y-1 text-slate-600">
                <li>Klik <b>+ Tambah Produk</b>.</li>
                <li>Isi <b>Nama</b>, <b>Kategori</b>, <b>Stok</b>, <b>Harga Beli (HPP)</b>, <b>Harga Jual</b>.</li>
                <li>(Opsional) Isi <b>URL Gambar</b>.</li>
                <li>Klik <b>Simpan</b>.</li>
              </ol>
            </div>
            <div class="rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">2) Edit / Hapus Produk</div>
              <ol class="mt-2 list-decimal pl-5 space-y-1 text-slate-600">
                <li>Di tabel produk, klik tombol <b>Edit</b>.</li>
                <li>Ubah data yang diperlukan lalu <b>Simpan</b>.</li>
                <li>Untuk menghapus: klik <b>Hapus</b> di form edit (konfirmasi akan muncul).</li>
              </ol>
            </div>
            <div class="rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">3) Kelola Stok</div>
              <ul class="mt-2 list-disc pl-5 space-y-1 text-slate-600">
                <li><b>Stok bertambah</b> paling rapi lewat menu <b>Pembelian dari Agen</b> (otomatis tercatat).</li>
                <li>Stok juga bisa diubah manual dari menu <b>Edit Produk</b>.</li>
                <li>Gunakan tombol <b>Filter Stok &lt; 10</b> untuk cek stok rendah.</li>
              </ul>
            </div>
            <div class="rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">4) Harga & Keuntungan</div>
              <ul class="mt-2 list-disc pl-5 space-y-1 text-slate-600">
                <li><b>Harga Beli (HPP)</b> dipakai untuk menghitung profit saat checkout.</li>
                <li><b>Harga Jual</b> adalah harga normal (sebelum promo).</li>
                <li>Promo (diskon) diatur di menu <b>Promo</b> dan otomatis memunculkan badge diskon di marketplace.</li>
              </ul>
            </div>
          </div>
        </details>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex items-center gap-2">
            <input id="adminProductSearch" class="w-full md:w-80 rounded-xl border px-3 py-2 text-sm" placeholder="Cari produk..." />
            <button id="adminProductSearchClear" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Kategori</label>
            <select id="adminCategoryFilter" class="rounded-xl border bg-white px-3 py-2 text-sm">
              <option value="">Semua</option>
              <option value="Lokal">Lokal</option>
              <option value="Impor">Impor</option>
              <option value="Musiman">Musiman</option>
              <option value="Tropis">Tropis</option>
            </select>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left font-semibold">Produk</th>
                <th class="py-2 text-left font-semibold">Kategori</th>
                <th class="py-2 text-left font-semibold">Harga Beli</th>
                <th class="py-2 text-left font-semibold">Harga Jual</th>
                <th class="py-2 text-left font-semibold">Stok</th>
                <th class="py-2 text-left font-semibold">Promo</th>
                <th class="py-2 text-right font-semibold">Aksi</th>
              </tr>
            </thead>
            <tbody id="adminProductsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ADMIN PURCHASES -->
    <section id="view-admin-purchases" class="view hidden fade-in">
      <div>
        <h2 class="text-2xl font-extrabold">Pembelian dari Agen / Supplier</h2>
        <p class="text-sm text-slate-500">Catat pembelian, update stok otomatis, dan bisa set harga jual.</p>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-5 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Form Pembelian</div>
          <form id="purchaseForm" class="mt-3 space-y-3">
            <div>
              <label class="text-xs text-slate-500">Produk</label>
              <select id="purchaseProduct" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm"></select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500">Qty</label>
                <input id="purchaseQty" type="number" min="1" value="1" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Harga Beli/unit</label>
                <input id="purchaseBuyPrice" type="number" min="0" step="100" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: 12000" />
              </div>
            </div>
            <div>
              <label class="text-xs text-slate-500">(Opsional) Set Harga Jual/unit</label>
              <input id="purchaseSellPrice" type="number" min="0" step="100" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: 18000" />
              <div class="mt-1 text-xs text-slate-500">Jika diisi, harga jual produk akan diupdate.</div>
            </div>
            <div class="flex gap-2">
              <button class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700" type="submit">Simpan Pembelian</button>
              <button id="purchaseFormReset" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" type="button">Reset</button>
            </div>
          </form>
        </div>

        <div class="lg:col-span-7 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Riwayat Pembelian</div>
              <div class="text-xs text-slate-500">Maks. 12 terakhir (untuk laporan lengkap, gunakan menu Laporan)</div>
            </div>
            <button id="exportPurchasesCsv" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Ekspor CSV</button>
          </div>
          <div class="mt-3 overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-xs text-slate-500">
                <tr class="border-b">
                  <th class="py-2 text-left font-semibold">Tanggal</th>
                  <th class="py-2 text-left font-semibold">Produk</th>
                  <th class="py-2 text-left font-semibold">Qty</th>
                  <th class="py-2 text-left font-semibold">Harga Beli</th>
                  <th class="py-2 text-left font-semibold">Update Harga Jual</th>
                </tr>
              </thead>
              <tbody id="purchaseHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN PROMOS -->
    <section id="view-admin-promos" class="view hidden fade-in">
      <div>
        <h2 class="text-2xl font-extrabold">Kelola Promo</h2>
        <p class="text-sm text-slate-500">Tambah diskon per produk, set tanggal mulai/berakhir, aktif/nonaktifkan promo.</p>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-5 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Set Promo Produk</div>
          <form id="promoForm" class="mt-3 space-y-3">
            <div>
              <label class="text-xs text-slate-500">Produk</label>
              <select id="promoProduct" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm"></select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500">Diskon (%)</label>
                <input id="promoDiscount" type="number" min="0" max="90" step="1" value="10" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" />
              </div>
              <div class="flex items-end">
                <label class="inline-flex items-center gap-2 text-sm">
                  <input id="promoActive" type="checkbox" class="h-4 w-4" checked />
                  <span class="font-semibold">Aktif</span>
                </label>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500">Mulai</label>
                <input id="promoStart" type="date" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Berakhir</label>
                <input id="promoEnd" type="date" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm" />
              </div>
            </div>
            <div class="flex gap-2">
              <button class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700" type="submit">Simpan Promo</button>
              <button id="clearPromoBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" type="button">Hapus Promo</button>
            </div>
          </form>
        </div>

        <div class="lg:col-span-7 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Daftar Promo</div>
              <div class="text-xs text-slate-500">Hanya promo aktif dalam jadwal akan tampil di marketplace</div>
            </div>
            <button id="refreshPromoBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Refresh</button>
          </div>
          <div class="mt-3 overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-xs text-slate-500">
                <tr class="border-b">
                  <th class="py-2 text-left font-semibold">Produk</th>
                  <th class="py-2 text-left font-semibold">Diskon</th>
                  <th class="py-2 text-left font-semibold">Mulai</th>
                  <th class="py-2 text-left font-semibold">Berakhir</th>
                  <th class="py-2 text-left font-semibold">Status</th>
                  <th class="py-2 text-right font-semibold">Aksi</th>
                </tr>
              </thead>
              <tbody id="promoTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN TRANSACTIONS -->
    <section id="view-admin-transactions" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Transaksi</h2>
          <p class="text-sm text-slate-500">Lihat semua riwayat transaksi checkout.</p>
        </div>
        <div class="flex gap-2">
          <button id="exportSalesCsv" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Ekspor Penjualan CSV</button>
          <button id="clearTransactionsBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Hapus Semua Transaksi</button>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex items-center gap-2">
            <input id="txSearch" class="w-full md:w-96 rounded-xl border px-3 py-2 text-sm" placeholder="Cari ID / nama pembeli / produk..." />
            <button id="txSearchReset" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Dari</label>
            <input id="txFrom" type="date" class="rounded-xl border bg-white px-3 py-2 text-sm" />
            <label class="text-xs text-slate-500">Sampai</label>
            <input id="txTo" type="date" class="rounded-xl border bg-white px-3 py-2 text-sm" />
            <button id="txApply" class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-bold text-white hover:bg-emerald-700">Terapkan</button>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left font-semibold">ID</th>
                <th class="py-2 text-left font-semibold">Tanggal</th>
                <th class="py-2 text-left font-semibold">Pembeli</th>
                <th class="py-2 text-left font-semibold">Total</th>
                <th class="py-2 text-left font-semibold">Profit</th>
                <th class="py-2 text-left font-semibold">Detail Item</th>
              </tr>
            </thead>
            <tbody id="txBody"></tbody>
          </table>
        </div>

        <div id="txEmpty" class="hidden mt-6 rounded-xl border bg-slate-50 p-6 text-center">
          <div class="font-semibold">Belum ada transaksi</div>
          <div class="text-sm text-slate-500 mt-1">Silakan checkout dari Marketplace untuk menghasilkan transaksi.</div>
        </div>
      </div>
    </section>

    <!-- ADMIN SHIPPING -->
    <section id="view-admin-shipping" class="view hidden fade-in">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-extrabold">Pengelolaan Pengiriman</h2>
          <p class="text-sm text-slate-500">Kelola status pengiriman, biaya ongkir, dan kirim konfirmasi total tagihan ke customer (via WhatsApp).</p>
        </div>
        <div class="flex gap-2">
          <button id="exportShippingCsv" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Ekspor Pengiriman CSV</button>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div class="flex items-center gap-2">
            <input id="shipSearch" class="w-full md:w-96 rounded-xl border px-3 py-2 text-sm" placeholder="Cari ID / nama / WA / alamat..." />
            <button id="shipSearchReset" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Reset</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Status</label>
            <select id="shipStatusFilter" class="rounded-xl border bg-white px-3 py-2 text-sm">
              <option value="">Semua</option>
              <option value="pending">Pending</option>
              <option value="processing">Diproses</option>
              <option value="shipped">Dikirim</option>
              <option value="delivered">Selesai</option>
              <option value="canceled">Batal</option>
            </select>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left font-semibold">ID</th>
                <th class="py-2 text-left font-semibold">Tanggal</th>
                <th class="py-2 text-left font-semibold">Pembeli</th>
                <th class="py-2 text-left font-semibold">Alamat</th>
                <th class="py-2 text-left font-semibold">Total Item</th>
                <th class="py-2 text-left font-semibold">Ongkir</th>
                <th class="py-2 text-left font-semibold">Tagihan</th>
                <th class="py-2 text-left font-semibold">Status</th>
                <th class="py-2 text-right font-semibold">Aksi</th>
              </tr>
            </thead>
            <tbody id="shipBody"></tbody>
          </table>
        </div>

        <div id="shipEmpty" class="hidden mt-6 rounded-xl border bg-slate-50 p-6 text-center">
          <div class="font-semibold">Belum ada order</div>
          <div class="text-sm text-slate-500 mt-1">Order berasal dari checkout customer di Marketplace.</div>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <div class="text-sm font-semibold">Catatan</div>
        <ul class="mt-2 list-disc pl-5 text-sm text-slate-600 space-y-1">
          <li>Status pengiriman dan ongkir disimpan di transaksi (field <span class="font-mono">shipping</span>), sehingga ikut tersinkron via Cloud Sync.</li>
          <li>Gunakan tombol <b>Kirim Tagihan</b> untuk mengirim konfirmasi total tagihan (total item + ongkir) ke WhatsApp customer.</li>
          <li>Waktu konfirmasi (WA) akan tercatat dan ikut masuk laporan (CSV).</li>
        </ul>
      </div>
    </section>

    <!-- ADMIN REPORTS -->
    <section id="view-admin-reports" class="view hidden fade-in">
      <div>
        <h2 class="text-2xl font-extrabold">Ekspor Laporan ke Excel</h2>
        <p class="text-sm text-slate-500">Ekspor dalam format CSV (dibuka di Excel/Google Sheets).</p>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-4 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Laporan Penjualan</div>
          <div class="mt-2 text-xs text-slate-500">Berisi transaksi + item (flatten).</div>
          <button id="reportSalesBtn" class="mt-3 w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Download Penjualan.csv</button>
        </div>
        <div class="lg:col-span-4 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Laporan Pembelian</div>
          <div class="mt-2 text-xs text-slate-500">Berisi pembelian dari supplier/agen.</div>
          <button id="reportPurchasesBtn" class="mt-3 w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Download Pembelian.csv</button>
        </div>
        <div class="lg:col-span-4 rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold">Laporan Stok</div>
          <div class="mt-2 text-xs text-slate-500">Snapshot stok + harga beli/jual + status promo.</div>
          <button id="reportStockBtn" class="mt-3 w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Download Stok.csv</button>
        </div>

        <div class="lg:col-span-12 rounded-2xl border bg-white p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">Backup / Sinkronisasi (antar gadget)</div>
              <div class="mt-1 text-xs text-slate-500">Karena data tersimpan di browser (localStorage), perangkat lain tidak otomatis ikut berubah. Gunakan fitur backup/restore ini untuk memindahkan data.</div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2">
              <button id="exportAllDataBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Download Backup.json</button>
              <button id="importAllDataBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Import Backup.json</button>
              <input id="importDataInput" type="file" accept="application/json" class="hidden" />
            </div>
          </div>
          <div class="mt-3 rounded-xl border bg-slate-50 p-3 text-xs text-slate-600">
            <b>Cara pakai:</b> di gadget A klik <b>Download Backup.json</b> ‚Üí pindahkan file (WhatsApp/Email/Drive) ‚Üí di gadget B buka menu ini lalu klik <b>Import</b>.
          </div>
        </div>

        <div class="lg:col-span-12 rounded-2xl border bg-white p-4">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">Cloud Sync (Firebase)</div>
              <div class="mt-1 text-xs text-slate-500">Pengaturan Cloud Sync ada di tombol <b>Cloud: ...</b> di header (klik untuk membuka). Bisa juga dibuka dari tombol di samping.</div>
            </div>
            <button id="openCloudSyncBtnReports" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-bold text-white hover:bg-slate-800">Buka Cloud Sync</button>
          </div>
        </div>

        <div class="lg:col-span-12 rounded-2xl border bg-white p-4">
          <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
            <div class="max-w-2xl">
              <div class="text-sm font-semibold">Alternatif selain Firebase</div>
              <div class="mt-1 text-xs text-slate-500">Jika tidak ingin Firebase, kamu bisa pakai backend lain untuk sinkron multi-gadget dan order real-time.</div>
              <ul class="mt-3 list-disc pl-5 text-sm text-slate-600 space-y-1">
                <li><b>Supabase</b> (Postgres + Auth + Storage + Realtime) ‚Äî mirip Firebase, cocok untuk web app.</li>
                <li><b>Appwrite</b> / <b>PocketBase</b> ‚Äî bisa self-host, kontrol penuh (butuh server/VPS).</li>
                <li><b>Google Sheets + Apps Script</b> ‚Äî cocok untuk toko kecil, data masuk ke Sheet (seperti ‚Äúserver‚Äù sederhana).</li>
                <li><b>Custom API</b> (Node/Express, Laravel, dll) + database ‚Äî paling fleksibel.</li>
              </ul>
              <details class="mt-3">
                <summary class="cursor-pointer text-sm font-semibold text-emerald-700">Tips memilih (klik)</summary>
                <div class="mt-2 text-xs text-slate-600 space-y-1">
                  <div><b>Paling mudah (tanpa coding backend):</b> Webhook ke Pipedream/Make/n8n/Apps Script.</div>
                  <div><b>Paling mirip Firebase:</b> Supabase.</div>
                  <div><b>Paling murah & kontrol penuh:</b> PocketBase/Appwrite self-host (tapi perlu server).</div>
                </div>
              </details>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-8 rounded-2xl border bg-slate-50 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-extrabold">Order Webhook (kirim order ke server)</div>
                  <div class="mt-1 text-xs text-slate-600">Saat customer checkout, aplikasi akan <b>POST JSON</b> ke URL ini. Cocok untuk integrasi ke Pipedream/Make/n8n/Apps Script/Server kamu.</div>
                </div>
                <label class="inline-flex items-center gap-2 text-sm font-semibold">
                  <input id="orderWebhookEnabled" type="checkbox" class="h-4 w-4" />
                  Aktif
                </label>
              </div>
              <div class="mt-3">
                <label class="text-xs text-slate-500">Webhook URL</label>
                <input id="orderWebhookUrl" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm font-mono" placeholder="https://..." />
                <div class="mt-2 text-xs text-slate-500">Endpoint harus menerima <span class="font-mono">Content-Type: application/json</span> dan mengizinkan CORS.</div>
              </div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="testOrderWebhookBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-white">Test Webhook</button>
                <button id="saveOrderWebhookBtn" class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-bold text-white hover:bg-emerald-700">Simpan Setting</button>
              </div>
              <div id="orderWebhookStatus" class="mt-3 text-xs text-slate-600">Status: <span class="font-semibold">Nonaktif</span></div>

              <div class="mt-4 rounded-xl border bg-white p-3">
                <div class="text-sm font-extrabold">Nomor WhatsApp Admin (opsional)</div>
                <div class="mt-2">
                  <label class="text-xs text-slate-500">Nomor WA</label>
                  <input id="adminWhatsAppInput" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm font-mono" placeholder="cth: 0812xxxx atau +62812xxxx" />
                </div>
                <div class="mt-2 flex gap-2">
                  <button id="saveAdminWhatsAppBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Simpan Nomor</button>
                  <button id="clearAdminWhatsAppBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Hapus</button>
                </div>
                <div class="mt-2 text-xs text-slate-500">Nomor ini disimpan di perangkat (localStorage). Jika kosong, sistem akan meminta saat checkout.</div>
              </div>

              <details class="mt-3 rounded-xl border bg-white p-3">
                <summary class="cursor-pointer text-sm font-extrabold text-slate-900">Contoh Webhook URL & cara membuat (klik)</summary>
                <div class="mt-2 space-y-3 text-xs text-slate-700">
                  <div class="rounded-lg border bg-slate-50 p-3">
                    <div class="font-bold">Webhook URL itu apa?</div>
                    <div class="mt-1">Isilah dengan <b>URL endpoint server</b> (HTTPS) yang kamu miliki / kamu buat, yang bisa menerima <span class="font-mono">POST</span> JSON dan mengizinkan <b>CORS</b>. Saat customer checkout, web akan mengirim payload order ke URL ini.</div>
                  </div>

                  <div class="rounded-lg border bg-slate-50 p-3">
                    <div class="font-bold">Opsi 1 (paling cepat): Pipedream Webhook</div>
                    <ol class="mt-1 list-decimal pl-5 space-y-1">
                      <li>Buka <a class="font-semibold text-emerald-700 underline" target="_blank" href="https://pipedream.com/new">pipedream.com/new</a></li>
                      <li>Pilih trigger <b>HTTP / Webhook</b></li>
                      <li>Pipedream akan memberi URL seperti <span class="font-mono">https://eo....m.pipedream.net</span></li>
                      <li>Paste URL itu ke field <b>Webhook URL</b> di sini</li>
                      <li>Klik <b>Test Webhook</b> lalu <b>Aktif</b></li>
                    </ol>
                  </div>

                  <div class="rounded-lg border bg-slate-50 p-3">
                    <div class="font-bold">Opsi 2: Make.com (Integromat) Custom Webhook</div>
                    <ol class="mt-1 list-decimal pl-5 space-y-1">
                      <li>Buat scenario baru di Make</li>
                      <li>Tambahkan module <b>Webhooks ‚Üí Custom webhook</b></li>
                      <li>Copy webhook URL yang diberikan Make</li>
                      <li>Paste ke field <b>Webhook URL</b> di sini</li>
                    </ol>
                  </div>

                  <div class="rounded-lg border bg-slate-50 p-3">
                    <div class="font-bold">Opsi 3: n8n Webhook</div>
                    <ol class="mt-1 list-decimal pl-5 space-y-1">
                      <li>Buat workflow baru di n8n</li>
                      <li>Tambah node <b>Webhook</b> (method: POST)</li>
                      <li>Gunakan <b>Production URL</b> dari node webhook</li>
                      <li>Paste ke field <b>Webhook URL</b> di sini</li>
                    </ol>
                  </div>

                  <div class="rounded-lg border bg-slate-50 p-3">
                    <div class="font-bold">Opsi 4: Server sendiri (contoh Node/Express)</div>
                    <div class="mt-1 text-slate-600">Kalau kamu punya hosting/VPS, URL-nya biasanya seperti <span class="font-mono">https://domainkamu.com/api/order</span>.</div>
                    <pre class="mt-2 overflow-auto rounded-lg border bg-white p-2 text-[11px]"><code>import express from 'express';
const app = express();
app.use(express.json());

app.post('/api/order', (req, res) => {
  console.log('order masuk:', req.body);
  res.set('Access-Control-Allow-Origin', '*');
  res.json({ ok: true });
});

app.options('/api/order', (req, res) => {
  res.set('Access-Control-Allow-Origin', '*');
  res.set('Access-Control-Allow-Headers', 'Content-Type');
  res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.sendStatus(204);
});

app.listen(3000);</code></pre>
                  </div>

                  <div class="rounded-lg border border-amber-200 bg-amber-50 p-3 text-amber-900">
                    <div class="font-extrabold">Catatan penting: CORS</div>
                    <div class="mt-1">Jika Webhook URL kamu tidak mengizinkan CORS, tombol <b>Test Webhook</b> atau kirim order saat checkout akan gagal. Pipedream/Make/n8n biasanya sudah aman untuk CORS.</div>
                  </div>
                </div>
              </details>
            </div>

            <div class="lg:col-span-4 rounded-2xl border bg-slate-50 p-4">
              <div class="text-sm font-extrabold">Format payload (ringkas)</div>
              <pre class="mt-2 overflow-auto rounded-xl border bg-white p-3 text-xs text-slate-800"><code>{
  "event": "order.created",
  "shopId": "varsha-shop-01",
  "deviceId": "DEV-...",
  "sentAt": "2025-...",
  "tx": { "id": "TX-...", "buyerName": "...", "total": 12345, "items": [...] }
}</code></pre>
              <div class="mt-2 text-xs text-slate-500">Catatan: Webhook ini <b>tidak otomatis sinkron</b> semua data antar gadget, tapi cocok untuk ‚Äúmasuk server‚Äù dan diproses admin lewat sistem lain.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <details class="group">
          <summary class="cursor-pointer list-none select-none flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-extrabold">Deploy ke GitHub Pages</div>
              <div class="text-xs text-slate-500">Panduan upload ke GitHub + setting Firebase agar Cloud Sync & upload gambar tetap jalan.</div>
            </div>
            <div class="rounded-xl border px-3 py-1.5 text-sm font-semibold group-open:bg-slate-900 group-open:text-white">Lihat</div>
          </summary>

          <div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-4 text-sm text-slate-700">
            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">1) Upload project ke GitHub</div>
              <ol class="mt-2 list-decimal pl-5 space-y-1 text-slate-600">
                <li>Buat repository baru di GitHub (mis: <b>varsha-store</b>).</li>
                <li>Pastikan file <b>index.html</b> ada di root repository.</li>
                <li>Commit & push ke branch <b>main</b>.</li>
              </ol>
              <div class="mt-3 text-xs text-slate-500">
                Tips: karena ini single file, kamu cukup upload <b>index.html</b> saja.
              </div>
            </div>

            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">2) Aktifkan GitHub Pages</div>
              <ol class="mt-2 list-decimal pl-5 space-y-1 text-slate-600">
                <li>Buka repo ‚Üí <b>Settings</b> ‚Üí <b>Pages</b>.</li>
                <li>Pilih: <b>Build and deployment</b> ‚Üí <b>Deploy from a branch</b>.</li>
                <li>Branch: <b>main</b>, folder: <b>/ (root)</b> ‚Üí Save.</li>
                <li>Tunggu 1‚Äì2 menit sampai muncul URL <span class="font-mono">https://USERNAME.github.io/REPO/</span>.</li>
              </ol>
              <div class="mt-3 text-xs">
                <a class="font-semibold text-emerald-700 hover:underline" target="_blank" href="https://pages.github.com/">Buka dokumentasi GitHub Pages</a>
              </div>
            </div>

            <div class="lg:col-span-12 rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">2.5) Deployment Helper (cek domain & URL)</div>
              <div class="mt-2 text-xs text-slate-600">Domain yang perlu ditambahkan ke <b>Firebase Authorized domains</b>:</div>
              <div class="mt-1 text-sm font-mono" id="currentHost">-</div>
              <div class="mt-2 text-xs text-slate-600">URL website saat ini:</div>
              <div class="mt-1 text-sm font-mono break-all" id="currentOrigin">-</div>
              <div id="fileProtocolWarn" class="hidden mt-3 rounded-xl border bg-amber-50 p-3 text-xs text-amber-900">
                Kamu sedang membuka dari <b>file://</b>. Firebase Auth/Cloud Sync biasanya tidak jalan dari file lokal. Deploy dulu ke GitHub Pages (https), lalu buka dari URL GitHub Pages.
              </div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="copyAuthorizedDomainBtn" class="rounded-xl border px-3 py-2 text-xs font-bold hover:bg-white">Copy Domain</button>
                <button id="copySiteUrlBtn" class="rounded-xl border px-3 py-2 text-xs font-bold hover:bg-white">Copy URL</button>
              </div>
              <div class="mt-2 text-xs text-slate-500">Tips: untuk GitHub Pages biasanya domainnya <span class="font-mono">USERNAME.github.io</span> (tanpa path repo).</div>
            </div>

            <div class="lg:col-span-12 rounded-xl border bg-amber-50 p-3">
              <div class="font-bold text-amber-900">3) Setting Firebase agar berjalan di domain GitHub Pages</div>
              <ul class="mt-2 list-disc pl-5 space-y-1 text-amber-900">
                <li><b>Cloud Sync tidak akan jalan jika dibuka dari file lokal</b> (<span class="font-mono">file://</span>). Gunakan URL GitHub Pages (https).</li>
                <li>Firebase Console ‚Üí <b>Authentication</b> ‚Üí <b>Settings</b> ‚Üí <b>Authorized domains</b> ‚Üí tambahkan domain: <span class="font-mono">USERNAME.github.io</span>.</li>
                <li>Jika pakai custom domain, tambahkan juga domain custom tersebut.</li>
              </ul>
              <div class="mt-3 text-xs">
                <a class="font-semibold text-emerald-700 hover:underline" target="_blank" href="https://console.firebase.google.com/">Buka Firebase Console</a>
              </div>
            </div>

            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="flex items-center justify-between gap-2">
                <div class="font-bold">Contoh Firestore Rules (demo)</div>
                <button id="copyFirestoreRulesBtn" class="rounded-xl border px-3 py-1.5 text-xs font-bold hover:bg-white">Copy</button>
              </div>
              <pre class="mt-2 overflow-auto rounded-xl border bg-white p-3 text-xs text-slate-800"><code id="firestoreRulesSample">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow Varsha Cloud Sync doc
    match /varsha_shops/{shopId} {
      // Anonymous auth counts as authenticated
      allow read, write: if request.auth != null;
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}</code></pre>
              <div class="mt-2 text-xs text-slate-500">Untuk produksi, rules sebaiknya membatasi akses per user/toko.</div>
            </div>

            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="flex items-center justify-between gap-2">
                <div class="font-bold">Contoh Storage Rules (upload gambar)</div>
                <button id="copyStorageRulesBtn" class="rounded-xl border px-3 py-1.5 text-xs font-bold hover:bg-white">Copy</button>
              </div>
              <pre class="mt-2 overflow-auto rounded-xl border bg-white p-3 text-xs text-slate-800"><code id="storageRulesSample">rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /varsha_shops/{shopId}/product_images/{fileName} {
      // Read needed so marketplace can show images
      allow read: if true;
      // Upload only for authenticated users (anonymous auth counts as authenticated)
      allow write: if request.auth != null;
    }
  }
}</code></pre>
              <div class="mt-2 text-xs text-slate-500">Jika ingin gambar tidak publik, read harus dibatasi dan tampilan gambar perlu mekanisme auth.</div>
            </div>
          </div>
        </details>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <details class="group">
          <summary class="cursor-pointer list-none select-none flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-extrabold">Mode Produksi: Auth & Role yang aman (Firebase Auth)</div>
              <div class="text-xs text-slate-500">Panduan agar login/role admin-customer aman (bukan sekadar pembatasan UI).</div>
            </div>
            <div class="rounded-xl border px-3 py-1.5 text-sm font-semibold group-open:bg-slate-900 group-open:text-white">Lihat</div>
          </summary>

          <div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-4 text-sm text-slate-700">
            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">1) Aktifkan Firebase Auth (Email/Password)</div>
              <ol class="mt-2 list-decimal pl-5 space-y-1 text-slate-600">
                <li>Firebase Console ‚Üí <b>Authentication</b> ‚Üí <b>Sign-in method</b></li>
                <li>Enable <b>Email/Password</b></li>
                <li>(Opsional) tetap enable <b>Anonymous</b> jika ingin mode guest.</li>
              </ol>
              <div class="mt-2 text-xs text-slate-500">Catatan: login berbasis localStorage di web ini cocok untuk demo, tapi tidak aman untuk produksi.</div>
            </div>

            <div class="lg:col-span-6 rounded-xl border bg-slate-50 p-3">
              <div class="font-bold">2) Role admin/customer yang aman = Custom Claims</div>
              <div class="mt-2 text-slate-600 text-sm">
                Untuk produksi, role <b>tidak boleh</b> disimpan dan dipercaya dari browser. Cara umum:
                <ul class="mt-2 list-disc pl-5 space-y-1">
                  <li>Tentukan admin dari server (Cloud Functions / server kamu).</li>
                  <li>Set <b>Custom Claims</b> pada user admin (mis. <span class="font-mono">{ admin: true }</span>).</li>
                  <li>Firestore Rules memeriksa claim tersebut.</li>
                </ul>
              </div>
            </div>

            <div class="lg:col-span-12 rounded-xl border bg-white p-3">
              <div class="flex items-center justify-between gap-2">
                <div class="font-bold">Contoh Firestore Rules produksi (role admin via Custom Claims)</div>
              </div>
              <pre class="mt-2 overflow-auto rounded-xl border bg-slate-50 p-3 text-xs text-slate-800"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null &amp;&amp; request.auth.token.admin == true;
    }

    // Contoh: hanya admin boleh write data toko
    match /varsha_shops/{shopId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}</code></pre>
              <div class="mt-2 text-xs text-slate-500">Catatan: aturan ini contoh. Sesuaikan kebutuhan (mis. customer boleh read katalog, admin write stok/transaksi).</div>
            </div>

            <div class="lg:col-span-12 rounded-xl border bg-amber-50 p-3 text-amber-900">
              <div class="font-extrabold">Kenapa perlu ini?</div>
              <div class="mt-1 text-xs">Karena pembatasan menu di UI saja bisa dibypass. Yang benar: batasi akses di <b>Rules</b> atau server.</div>
            </div>
          </div>
        </details>
      </div>

      <div class="mt-4 rounded-2xl border bg-white p-4">
        <div class="text-sm font-semibold">Catatan</div>
        <ul class="mt-2 list-disc pl-5 text-sm text-slate-600 space-y-1">
          <li>CSV kompatibel dengan Excel (gunakan delimiter koma). Jika Excel regional memakai titik-koma, gunakan fitur import CSV.</li>
          <li>Data tersimpan di browser (localStorage). Untuk produksi, hubungkan ke backend/database.</li>
          <li>Fitur <b>Cloud Sync</b> membutuhkan project Firebase + Firestore + Anonymous Auth.</li>
          <li>Jika memakai <b>Upload Gambar</b>, file tersimpan di <b>Firebase Storage</b>. Pastikan rules Storage mengizinkan upload/read sesuai kebutuhan toko Anda.</li>
        </ul>
      </div>
    </section>

      </div>
    </div>


  </main>

  <!-- Cart Drawer -->
  <div id="cartOverlay" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-black/40" id="closeCartArea"></div>
    <aside class="absolute right-0 top-0 h-full w-full sm:w-[420px] bg-white shadow-2xl border-l fade-in">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <div class="text-base font-extrabold">Keranjang Belanja</div>
          <div id="cartSub" class="text-xs text-slate-500">0 item</div>
        </div>
        <button id="closeCartBtn" class="rounded-lg p-2 hover:bg-slate-100" aria-label="Tutup">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-4 overflow-auto" style="height: calc(100% - 170px);">
        <div id="cartItems" class="space-y-3"></div>
        <div id="cartEmpty" class="hidden mt-8 rounded-2xl border bg-slate-50 p-6 text-center">
          <div class="font-semibold">Keranjang kosong</div>
          <div class="text-sm text-slate-500 mt-1">Tambahkan produk dari marketplace.</div>
        </div>
      </div>
      <div class="p-4 border-t bg-white">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-500">Total</div>
          <div id="cartTotal" class="text-lg font-extrabold">Rp0</div>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="clearCartBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Kosongkan</button>
          <button id="checkoutBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Checkout</button>
        </div>
        <div id="checkoutHint" class="mt-2 text-xs text-slate-500">Stok akan berkurang setelah checkout.</div>
      </div>
    </aside>
  </div>

  <!-- Product Modal (Add/Edit) -->
  <div id="productModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-black/40" data-close="productModal"></div>
    <div class="absolute left-1/2 top-1/2 w-[95vw] max-w-xl -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl border fade-in">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <div id="productModalTitle" class="text-base font-extrabold">Tambah Produk</div>
          <div class="text-xs text-slate-500">Kelola data produk untuk marketplace</div>
        </div>
        <button class="rounded-lg p-2 hover:bg-slate-100" data-close="productModal" aria-label="Tutup">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="productForm" class="p-4 space-y-3">
        <input type="hidden" id="productId" />
        <div>
          <label class="text-xs text-slate-500">Nama Produk</label>
          <input id="productName" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: Mangga Harum Manis" required />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">Kategori</label>
            <select id="productCategory" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm" required>
              <option value="Lokal">Lokal</option>
              <option value="Impor">Impor</option>
              <option value="Musiman">Musiman</option>
              <option value="Tropis">Tropis</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Stok</label>
            <input id="productStock" type="number" min="0" value="0" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" required />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-500">Harga Beli (HPP)</label>
            <input id="productBuy" type="number" min="0" step="100" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: 12000" required />
          </div>
          <div>
            <label class="text-xs text-slate-500">Harga Jual</label>
            <input id="productSell" type="number" min="0" step="100" class="no-spin mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: 18000" required />
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Gambar Produk</label>
          <div class="mt-1 flex items-start gap-3">
            <img id="productImagePreview" class="h-16 w-16 rounded-xl object-cover border bg-slate-50" alt="Preview" src="https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=200&q=60" />
            <div class="flex-1">
              <div class="flex flex-col sm:flex-row gap-2">
                <input id="productImageFile" type="file" accept="image/*" class="block w-full text-sm file:mr-3 file:rounded-xl file:border-0 file:bg-slate-900 file:px-4 file:py-2 file:text-sm file:font-bold file:text-white hover:file:bg-slate-800" />
                <button id="uploadProductImageBtn" type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Upload</button>
              </div>
              <div id="uploadProgressWrap" class="hidden mt-2">
                <div class="h-2 w-full rounded-full bg-slate-100 overflow-hidden">
                  <div id="uploadProgressBar" class="h-2 bg-emerald-600" style="width:0%"></div>
                </div>
                <div id="uploadProgressText" class="mt-1 text-xs text-slate-500">0%</div>
              </div>
              <div class="mt-2">
                <div class="text-xs text-slate-500">Opsi 1: Upload (disimpan di <b>Firebase Storage</b>) ‚Äî butuh <b>Cloud Sync</b> tersambung.</div>
                <div class="mt-1 text-xs text-slate-500">Opsi 2: Tempel URL gambar di bawah (tanpa upload).</div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-xs text-slate-500">URL Gambar (opsional)</label>
            <input id="productImage" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="https://..." />
            <div class="mt-1 text-xs text-slate-500">Kosongkan untuk memakai gambar default.</div>
          </div>
        </div>
        <div class="flex items-center justify-between gap-2 pt-2">
          <div class="flex items-center gap-2">
            <button id="deleteProductBtn" type="button" class="hidden rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm font-bold text-rose-700 hover:bg-rose-100">Hapus</button>
            <button id="pushProductCloudBtn" type="button" class="hidden rounded-xl border border-sky-200 bg-sky-50 px-4 py-2 text-sm font-bold text-sky-700 hover:bg-sky-100" title="Kirim snapshot data ke Cloud Sync">Push (Kirim ke Cloud)</button>
          </div>
          <div class="ml-auto flex gap-2">
            <button type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" data-close="productModal">Batal</button>
            <button type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Simpan</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Cloud Sync Modal (Firebase) - Accessible for all roles -->
  <div id="cloudSyncModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-black/40" data-close="cloudSyncModal"></div>
    <div class="absolute left-1/2 top-1/2 w-[95vw] max-w-3xl -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl border fade-in">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <div class="text-base font-extrabold">Cloud Sync (Firebase)</div>
          <div class="text-xs text-slate-500">Multi gadget ‚Ä¢ Sinkron real-time via Firestore + Storage (upload gambar)</div>
        </div>
        <button class="rounded-lg p-2 hover:bg-slate-100" data-close="cloudSyncModal" aria-label="Tutup">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="p-4">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div class="max-w-xl">
            <div class="text-sm font-semibold">Penting</div>
            <div class="mt-1 text-xs text-slate-600">Semua gadget harus memakai <b>Shop ID</b> dan <b>Firebase Config</b> yang sama. Auth yang dipakai adalah <b>Anonymous Auth</b>.</div>
            <div class="mt-2 rounded-xl border bg-amber-50 p-3 text-xs text-amber-900">
              <div class="font-extrabold">Setup wajib di Firebase Console</div>
              <ul class="mt-2 list-disc pl-5 space-y-1">
                <li>Build ‚Üí <b>Authentication</b> ‚Üí Sign-in method ‚Üí enable <b>Anonymous</b></li>
                <li>Build ‚Üí <b>Firestore Database</b> ‚Üí aktifkan + set Rules</li>
                <li>Build ‚Üí <b>Storage</b> ‚Üí Get started + set Rules (kalau mau upload gambar)</li>
              </ul>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="cloudConnectBtn" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-bold text-white hover:bg-slate-800">Connect</button>
            <button id="cloudDisconnectBtn" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Disconnect</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="lg:col-span-4">
            <label class="text-xs text-slate-500">Shop ID (harus sama di semua gadget)</label>
            <input id="cloudShopId" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="cth: varsha-shop-01" />
            <div class="mt-2 text-xs text-slate-500">Shop ID memisahkan data antar toko. Gunakan ID yang sama agar sinkron.</div>
          </div>
          <div class="lg:col-span-8">
            <label class="text-xs text-slate-500">Firebase Config (tempel JSON <span class="font-semibold">atau</span> snippet <span class="font-mono">const firebaseConfig = {...};</span>)</label>
            <textarea id="cloudConfigJson" rows="6" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm font-mono" placeholder='{"apiKey":"...","authDomain":"...","projectId":"..."}'></textarea>

            <div class="mt-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div id="cloudStatus" class="text-xs text-slate-600">Status: <span class="font-semibold">Offline</span></div>
              <div class="flex flex-wrap gap-2">
                <button id="cloudFillDefaultBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50" title="Isi otomatis config default">Gunakan Config Default</button>
                <button id="cloudClearConfigBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50" title="Kosongkan field config">Clear</button>
                <button id="cloudPullBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Pull</button>
                <button id="cloudPushBtn" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">Push</button>
              </div>
            </div>

            <div id="cloudErrorWrap" class="hidden mt-3 rounded-xl border border-rose-200 bg-rose-50 p-3 text-xs text-rose-900">
              <div class="font-extrabold">Cloud Error / Troubleshooting</div>
              <div id="cloudErrorText" class="mt-1 font-mono break-all"></div>
              <div id="cloudErrorHints" class="mt-2 text-rose-900"></div>
            </div>

            <div class="mt-2 text-xs text-slate-500">Tips: Jika awal setup di beberapa gadget, lakukan <b>Push</b> dari gadget yang datanya paling benar, lalu <b>Pull</b> di gadget lain.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal (Login/Register) -->
  <div id="authModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-black/40" data-close="authModal"></div>
    <div class="absolute left-1/2 top-1/2 w-[95vw] max-w-lg -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl border fade-in">
      <div class="flex items-center justify-between p-4 border-b">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl overflow-hidden border border-slate-200 bg-white">
            <div id="storeLogoAuthFallback" class="h-full w-full bg-gradient-to-br from-emerald-500 to-lime-400"></div>
            <img id="storeLogoAuthImg" alt="Logo" class="hidden h-full w-full object-cover" />
          </div>
          <div>
            <div id="storeNameAuth" class="text-sm font-extrabold leading-4">Varsha</div>
            <div id="storeTaglineAuth" class="text-xs text-slate-500 leading-4">Fruits and Goods</div>
          </div>
        </div>
        <button class="rounded-lg p-2 hover:bg-slate-100" data-close="authModal" aria-label="Tutup">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="p-4">
        <div class="flex items-center gap-2 rounded-xl border bg-slate-50 p-2">
          <button id="authTabLogin" class="flex-1 rounded-lg px-3 py-2 text-sm font-extrabold bg-white border">Login</button>
          <button id="authTabRegister" class="flex-1 rounded-lg px-3 py-2 text-sm font-extrabold hover:bg-white/60">Registrasi</button>
        </div>

        <!-- Login -->
        <form id="loginForm" class="mt-4 space-y-3">
          <div>
            <label class="text-xs text-slate-500">Email</label>
            <input id="loginEmail" type="email" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="nama@email.com" required />
          </div>
          <div>
            <label class="text-xs text-slate-500">Password</label>
            <input id="loginPassword" type="password" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          </div>
          <div class="rounded-xl border bg-emerald-50 p-3 text-xs text-emerald-900">
            <div class="font-semibold">Halo! Yuk masuk dan temukan produk favoritmu dengan harga terbaik hari ini</div>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" data-close="authModal">Batal</button>
            <button type="submit" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-bold text-white hover:bg-slate-800">Login</button>
          </div>
        </form>

        <!-- Register -->
        <form id="registerForm" class="mt-4 space-y-3 hidden">
          <div>
            <label class="text-xs text-slate-500">Nama</label>
            <input id="regName" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="Nama lengkap" required />
          </div>
          <div>
            <label class="text-xs text-slate-500">Email</label>
            <input id="regEmail" type="email" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="nama@email.com" required />
          </div>
          <div>
            <label class="text-xs text-slate-500">Nomor WhatsApp</label>
            <input id="regWhatsApp" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm font-mono" placeholder="cth: 0812xxxx atau +62812xxxx" />
            <div class="mt-1 text-xs text-slate-500">Wajib untuk Customer (agar otomatis terisi saat Checkout).</div>
          </div>
          <div>
            <label class="text-xs text-slate-500">Password</label>
            <input id="regPassword" type="password" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="Min 6 karakter" minlength="6" required />
          </div>
          <div>
            <label class="text-xs text-slate-500">Role</label>
            <select id="regRole" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm">
              <option value="customer" selected>Customer</option>
              <option value="admin">Admin</option>
            </select>
            <div class="mt-1 text-xs text-slate-500">Customer hanya bisa Marketplace & Keranjang. Admin bisa akses semua menu.</div>
          </div>

          <!-- Admin reference code (required for Admin role) -->
          <div id="adminRefWrap" class="hidden">
            <label class="text-xs text-slate-500">Kode Referensi (khusus Admin)</label>
            <input id="regAdminCode" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm font-mono" placeholder="Masukkan kode referensi admin" />
            <div class="mt-1 text-xs text-slate-500">Kode diberikan oleh pemilik toko. Tanpa kode yang benar, akun Admin tidak bisa dibuat.</div>
          </div>

          <div class="rounded-xl border bg-rose-50 p-3 text-xs text-rose-900">
            <div class="font-extrabold">Penting</div>
            <div class="mt-1">Role admin di sini hanya pembatasan UI. Untuk keamanan produksi, role harus divalidasi di server.</div>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" data-close="authModal">Batal</button>
            <button type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Buat Akun</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-black/40" data-close="checkoutModal"></div>
    <div class="absolute left-1/2 top-1/2 w-[95vw] max-w-lg -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl border fade-in max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b shrink-0">
        <div>
          <div class="text-base font-extrabold">Checkout</div>
          <div class="text-xs text-slate-500">Masukkan data pembeli lalu konfirmasi pembayaran</div>
        </div>
        <button class="rounded-lg p-2 hover:bg-slate-100" data-close="checkoutModal" aria-label="Tutup">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="checkoutForm" class="p-4 space-y-3 flex-1 min-h-0 overflow-y-auto">
        <div>
          <label class="text-xs text-slate-500">Nama Pembeli</label>
          <input id="buyerName" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" required placeholder="cth: Varsha" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Nomor WhatsApp</label>
          <input id="buyerWhatsApp" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm font-mono" required placeholder="cth: 0812xxxx atau +62812xxxx" />
          <div class="mt-1 text-xs text-slate-500">Nomor ini dipakai untuk identitas pembeli dan konfirmasi.</div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Alamat</label>
          <textarea id="buyerAddress" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" rows="3" required placeholder="Alamat lengkap..."></textarea>
        </div>
        <div>
          <label class="text-xs text-slate-500">Catatan (opsional)</label>
          <textarea id="buyerNote" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" rows="2" placeholder="Catatan untuk admin (mis: patokan rumah, minta buah matang, jam kirim, dll)..."></textarea>
        </div>
        <div class="rounded-xl border bg-slate-50 p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm text-slate-600">Total Bayar</div>
            <div id="checkoutTotal" class="text-lg font-extrabold">Rp0</div>
          </div>
          <div class="mt-1 text-xs text-slate-500 italic">Harap menunggu konfirmasi Admin untuk pembayaran</div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50" data-close="checkoutModal">Batal</button>
          <button type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-bold text-white hover:bg-emerald-700">Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div id="orderSuccessModal" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 bg-black/40" data-close="orderSuccessModal"></div>
    <div class="absolute left-1/2 top-1/2 w-[92vw] max-w-sm -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl border fade-in">
      <div class="p-5 text-center">
        <div class="mx-auto h-12 w-12 rounded-2xl bg-emerald-50 border border-emerald-200 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>
        </div>
        <div class="mt-3 text-lg font-extrabold tracking-wide">ORDER TERKIRIM</div>
        <div id="orderSuccessSub" class="mt-1 text-xs text-slate-500">-</div>
        <div class="mt-5">
          <button class="w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-extrabold text-white hover:bg-slate-800" data-close="orderSuccessModal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Footer Nav (fixed bottom, only for ADMIN role) -->
  <footer id="adminFooter" class="admin-only hidden fixed bottom-0 inset-x-0 w-full z-[55] border-t bg-white/90 glass">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-2">
      <div class="grid grid-cols-4 sm:grid-cols-8 gap-2">
        <button data-route="admin.dashboard" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Dashboard</button>
        <button data-route="admin.products" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Produk</button>
        <button data-route="admin.purchases" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Pembelian</button>
        <button data-route="admin.promos" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Promo</button>
        <button data-route="admin.hero" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Kelola Hero</button>
        <button data-route="admin.shipping" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Pengiriman</button>
        <button data-route="admin.transactions" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Transaksi</button>
        <button data-route="admin.reports" class="route-btn rounded-xl border bg-white px-2 py-2 text-xs font-extrabold hover:bg-slate-50">Laporan</button>
      </div>
      <div class="mt-2 text-[11px] text-slate-500">Menu admin ada di footer agar navigasi konsisten di mobile & desktop.</div>
    </div>
  </footer>

  <!-- Customer Footer (fixed bottom, only for CUSTOMER role) -->
  <footer id="customerFooter" class="hidden fixed bottom-0 inset-x-0 w-full z-[55] border-t bg-white/90 glass">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
      <div class="rounded-2xl border bg-white/95 p-3 flex items-center justify-between gap-3">
        <div class="text-xs text-slate-600">Anda masuk sebagai <span class="font-semibold">Customer</span></div>
        <div class="flex items-center gap-2">
          <button data-route="customer.shipping" class="route-btn rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Status Pengiriman</button>
          <button id="logoutBtnCustomer" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50">Keluar</button>
        </div>
      </div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] hidden">
    <div class="rounded-full bg-slate-900 text-white px-4 py-2 text-sm shadow-lg"></div>
  </div>

  <script>
    /**********************
     * Utilities
     **********************/
    const rupiah = (n) => {
      const num = Number(n || 0);
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
    };
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const uid = (prefix='ID') => `${prefix}-${Math.random().toString(16).slice(2, 8).toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;
    const toISODate = (d) => {
      const dt = (d instanceof Date) ? d : new Date(d);
      const off = dt.getTimezoneOffset();
      const local = new Date(dt.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0, 10);
    };
    const parseDate = (s) => {
      if (!s) return null;
      const d = new Date(s + 'T00:00:00');
      return isNaN(d) ? null : d;
    };

    function toast(msg) {
      const el = document.getElementById('toast');
      const box = el.firstElementChild;
      box.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.add('hidden'), 2200);
    }

    /**********************
     * WhatsApp helper (Checkout -> Kirim WA)
     **********************/
    function normalizePhoneToDigits(s) {
      return String(s || '').replace(/[^0-9]/g, '');
    }

    function toWhatsAppMsisdn(input) {
      // Accept: 08xxx / +62xxx / 62xxx
      let d = normalizePhoneToDigits(input);
      if (!d) return '';
      if (d.startsWith('0')) d = '62' + d.slice(1);
      if (!d.startsWith('62')) {
        // assume already includes country code or user typed other
        // keep as is
      }
      return d;
    }

    function buildWhatsAppOrderMessage({ tx, buyerName, buyerWhatsApp, buyerAddress, buyerNote, items, total }) {
      const lines = [];
      lines.push(`Order Baru - Varsha Fruits and Goods`);
      if (tx?.id) lines.push(`ID: ${tx.id}`);
      lines.push(`Nama: ${buyerName}`);
      if (buyerWhatsApp) lines.push(`WA: ${buyerWhatsApp}`);
      lines.push(`Alamat: ${buyerAddress}`);
      if (buyerNote) lines.push(`Catatan: ${buyerNote}`);
      lines.push('');
      lines.push('Item:');
      for (const it of items) {
        lines.push(`- ${it.name} x${it.qty} @ ${rupiah(it.unitPrice)} = ${rupiah(it.revenue)}`);
      }
      lines.push('');
      lines.push(`Total: ${rupiah(total)}`);
      lines.push('');
      lines.push(`Mohon konfirmasi pembayaran. Terima kasih.`);
      return lines.join('\n');
    }

    function openWhatsAppChat({ phone, message }) {
      const msisdn = toWhatsAppMsisdn(phone);
      if (!msisdn) throw new Error('Nomor WhatsApp admin belum diisi.');
      const url = `https://wa.me/${msisdn}?text=${encodeURIComponent(message || '')}`;
      window.open(url, '_blank', 'noopener');
      return url;
    }

    function downloadText(filename, text, mime='text/csv;charset=utf-8') {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function toCSV(rows, headers=null) {
      if (!rows || rows.length === 0) return '';
      const cols = headers || Object.keys(rows[0]);
      const esc = (v) => {
        if (v === null || v === undefined) return '';
        const s = String(v);
        if (/[",\n]/.test(s)) return '"' + s.replaceAll('"', '""') + '"';
        return s;
      };
      const lines = [];
      lines.push(cols.map(esc).join(','));
      for (const r of rows) lines.push(cols.map(c => esc(r[c])).join(','));
      return lines.join('\n');
    }

    /**********************
     * Storage
     **********************/
    const LS = {
      products: 'varsha_products',
      transactions: 'varsha_transactions',
      purchases: 'varsha_purchases',
      cart: 'varsha_cart',
      cloudConfig: 'varsha_cloud_config_json',
      cloudShopId: 'varsha_cloud_shop_id',
      cloudEnabled: 'varsha_cloud_enabled',
      deviceId: 'varsha_device_id',
      lastSeenTxId: 'varsha_last_seen_tx_id',
      orderWebhookUrl: 'varsha_order_webhook_url',
      orderWebhookEnabled: 'varsha_order_webhook_enabled',
      adminWhatsApp: 'varsha_admin_whatsapp',
      users: 'varsha_users',
      session: 'varsha_session',
      hero: 'varsha_hero_settings',
      profile: 'varsha_store_profile'
    };

    function load(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch { return fallback; }
    }
    function save(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    /**********************
     * Demo data
     **********************/
    const demoProducts = () => ([
      {
        id: uid('PRD'),
        name: 'Pisang Cavendish',
        category: 'Tropis',
        priceBuy: 12000,
        priceSell: 18000,
        stock: 35,
        image: 'https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?auto=format&fit=crop&w=800&q=60',
        promo: { active: true, discountPct: 15, start: toISODate(new Date()), end: toISODate(new Date(Date.now()+ 7*864e5)) }
      },
      {
        id: uid('PRD'),
        name: 'Apel Fuji',
        category: 'Impor',
        priceBuy: 22000,
        priceSell: 32000,
        stock: 18,
        image: 'https://images.unsplash.com/photo-1567306226416-28f0efdc88ce?auto=format&fit=crop&w=800&q=60',
        promo: { active: false, discountPct: 0, start: '', end: '' }
      },
      {
        id: uid('PRD'),
        name: 'Jeruk Lokal',
        category: 'Lokal',
        priceBuy: 9000,
        priceSell: 14000,
        stock: 42,
        image: 'https://images.unsplash.com/photo-1547514701-42782101795e?auto=format&fit=crop&w=800&q=60',
        promo: { active: true, discountPct: 10, start: toISODate(new Date(Date.now()- 2*864e5)), end: toISODate(new Date(Date.now()+ 5*864e5)) }
      },
      {
        id: uid('PRD'),
        name: 'Mangga Harum Manis',
        category: 'Musiman',
        priceBuy: 14000,
        priceSell: 21000,
        stock: 12,
        image: 'https://images.unsplash.com/photo-1591073113125-e46713c829ed?auto=format&fit=crop&w=800&q=60',
        promo: { active: false, discountPct: 0, start: '', end: '' }
      },
      {
        id: uid('PRD'),
        name: 'Anggur Merah',
        category: 'Impor',
        priceBuy: 30000,
        priceSell: 42000,
        stock: 9,
        image: 'https://images.unsplash.com/photo-1519996529931-28324d5a630e?auto=format&fit=crop&w=800&q=60',
        promo: { active: true, discountPct: 20, start: toISODate(new Date(Date.now()- 1*864e5)), end: toISODate(new Date(Date.now()+ 2*864e5)) }
      },
      {
        id: uid('PRD'),
        name: 'Nanas Madu',
        category: 'Tropis',
        priceBuy: 8000,
        priceSell: 13000,
        stock: 20,
        image: 'https://images.unsplash.com/photo-1589829050693-02d6d23f1dd0?auto=format&fit=crop&w=800&q=60',
        promo: { active: false, discountPct: 0, start: '', end: '' }
      }
    ]);

    /**********************
     * App state
     **********************/
    const state = {
      route: 'market',
      categoryFilter: '',
      search: '',
      adminProductSearch: '',
      adminCategoryFilter: '',
      stockLowOnly: false,
      txSearch: '',
      txRange: { from: '', to: '' },
      shipSearch: '',
      shipStatus: '',
      custShipSearch: '',
      custShipStatus: '',
      dashboardRange: { from: '', to: '' },
      charts: { line: null, donut: null }
    };

    /**********************
     * Auth (Local) - Admin/Customer
     **********************/
    function simpleHash(s) {
      const str = String(s || '');
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0).toString(16);
    }

    function getUsers() { return load(LS.users, []); }
    function setUsers(users) { save(LS.users, users); }

    function getSession() {
      const s = load(LS.session, null);
      return s && typeof s === 'object' ? s : null;
    }

    function setSession(sess) {
      save(LS.session, sess);
    }

    function clearSession() {
      localStorage.removeItem(LS.session);
    }

    function currentUser() {
      const sess = getSession();
      if (!sess?.email) return null;
      const u = getUsers().find(x => String(x.email).toLowerCase() === String(sess.email).toLowerCase());
      if (!u) return null;
      return { name: u.name, email: u.email, role: u.role, whatsApp: u.whatsApp || '' };
    }

    function isAdmin() {
      return (currentUser()?.role || '') === 'admin';
    }

    function ensureDefaultAccounts() {
      const users = getUsers();
      if (!users.length) {
        users.push({
          id: uid('USR'),
          name: 'Admin Varsha',
          email: 'admin@varsha.local',
          passwordHash: simpleHash('admin123'),
          role: 'admin',
          createdAt: new Date().toISOString()
        });
        users.push({
          id: uid('USR'),
          name: 'Customer Demo',
          email: 'customer@varsha.local',
          whatsApp: '081234567890',
          passwordHash: simpleHash('customer123'),
          role: 'customer',
          createdAt: new Date().toISOString()
        });
        setUsers(users);
      }
    }

    function authRegister({ name, email, password, role, adminCode, whatsApp }) {
      const e = String(email || '').trim().toLowerCase();
      const n = String(name || '').trim();
      const p = String(password || '');
      const r = (role === 'admin') ? 'admin' : 'customer';
      const wa = String(whatsApp || '').trim();

      if (r === 'admin') {
        const code = String(adminCode || '').trim();
        // Admin reference code is not stored in plain text. We compare a hash instead.
        // simpleHash('FR290707WF') => 'e12d51b1'
        const ADMIN_REF_HASH = 'e12d51b1';
        if (simpleHash(code) !== ADMIN_REF_HASH) throw new Error('Kode referensi admin tidak valid.');
      }

      if (r !== 'admin') {
        if (!wa) throw new Error('Nomor WhatsApp wajib diisi untuk Customer.');
      }

      if (!n) throw new Error('Nama wajib diisi.');
      if (!e) throw new Error('Email wajib diisi.');
      if (p.length < 6) throw new Error('Password minimal 6 karakter.');
      const users = getUsers();
      if (users.some(u => String(u.email).toLowerCase() === e)) throw new Error('Email sudah terdaftar.');
      users.push({ id: uid('USR'), name: n, email: e, whatsApp: wa, passwordHash: simpleHash(p), role: r, createdAt: new Date().toISOString() });
      setUsers(users);
      setSession({ email: e, loggedInAt: new Date().toISOString() });
      return { email: e, role: r };
    }

    function authLogin({ email, password }) {
      const e = String(email || '').trim().toLowerCase();
      const p = String(password || '');
      const users = getUsers();
      const u = users.find(x => String(x.email).toLowerCase() === e);
      if (!u) throw new Error('Akun tidak ditemukan.');
      if (u.passwordHash !== simpleHash(p)) throw new Error('Password salah.');
      setSession({ email: e, loggedInAt: new Date().toISOString() });
      return { email: e, role: u.role };
    }

    function authLogout() {
      clearSession();
    }

    function applyRoleUI() {
      const u = currentUser();
      const isA = (u?.role === 'admin');
      // Treat any logged-in non-admin as customer (more robust)
      const isC = !!u && !isA;

      // Admin-only controls
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle('hidden', !isA);
      });

      // Customer-only controls
      document.querySelectorAll('.customer-only').forEach(el => {
        // customer-only only shown for logged-in non-admin
        el.classList.toggle('hidden', !isC);
      });

      // Auth buttons
      const openAuthBtn = document.getElementById('openAuthBtn');
      const userNav = document.getElementById('userNav');
      const userChip = document.getElementById('userChip');
      const nameEl = document.getElementById('userNameLabel');
      const roleEl = document.getElementById('userRoleLabel');


      // Footers (bottom)
      const adminFooter = document.getElementById('adminFooter');
      const custFooter = document.getElementById('customerFooter');
      const topLogoutBtn = document.getElementById('logoutBtn');

      if (!u) {
        if (openAuthBtn) openAuthBtn.classList.remove('hidden');
        if (userNav) userNav.classList.add('hidden');
        if (custFooter) custFooter.classList.add('hidden');
        if (adminFooter) adminFooter.classList.add('hidden');

      } else {
        if (openAuthBtn) openAuthBtn.classList.add('hidden');

        if (isA) {
          // ADMIN: show user chip + logout in header + show admin footer menu
          if (userNav) userNav.classList.remove('hidden');
          if (userChip) userChip.classList.remove('hidden');
          if (topLogoutBtn) topLogoutBtn.classList.remove('hidden');
          if (custFooter) custFooter.classList.add('hidden');
          if (adminFooter) adminFooter.classList.remove('hidden');

        } else {
          // CUSTOMER (or any non-admin): hide header userNav and show footer logout
          if (userNav) userNav.classList.add('hidden');
          if (topLogoutBtn) topLogoutBtn.classList.add('hidden');
          if (custFooter) custFooter.classList.remove('hidden');
          if (adminFooter) adminFooter.classList.add('hidden');

        }

        if (nameEl) nameEl.textContent = u.name || u.email;
        if (roleEl) {
          roleEl.textContent = String(u.role || 'customer').toUpperCase();
          roleEl.className = 'rounded-full px-2 py-0.5 text-[10px] font-extrabold text-white ' + (isA ? 'bg-slate-900' : 'bg-emerald-700');
        }
      }

      // Layout: add bottom padding when any fixed footer is visible
      const footerVisible = (!!u && (isA || isC));
      document.body.classList.toggle('pb-24', footerVisible);

      // hard guard: customer cannot stay in admin route
      if (!isA && String(state.route || '').startsWith('admin.')) {
        routeTo('market');
      }
    }

    function ensureData() {
      let products = load(LS.products, null);
      if (!products || products.length === 0) {
        products = demoProducts();
        save(LS.products, products);
      }
      if (!load(LS.transactions, null)) save(LS.transactions, []);
      if (!load(LS.purchases, null)) save(LS.purchases, []);
      if (!load(LS.cart, null)) save(LS.cart, []);
    }

    function resetDemoData() {
      setProducts(demoProducts());
      setTransactions([]);
      setPurchases([]);
      setCart([]);
      toast('Data demo direset.');
      rerenderAll();
      routeTo('admin.dashboard');
    }

    function getProducts() { return load(LS.products, []); }
    function setProducts(products) { save(LS.products, products); }
    function getTransactions() { return load(LS.transactions, []); }
    function setTransactions(txs) { save(LS.transactions, txs); }
    function getPurchases() { return load(LS.purchases, []); }
    function setPurchases(p) { save(LS.purchases, p); }
    function getCart() { return load(LS.cart, []); }
    function setCart(c) { save(LS.cart, c); }

    /**********************
     * Hero settings (Marketplace Hero)
     **********************/
    const DEFAULT_HERO = {
      badge: 'Marketplace ‚Ä¢ Buah Segar Harian',
      headlineHtml: 'Belanja buah segar, cepat, dan hemat di <span class="underline decoration-white/60">Varsha Fruits and Goods</span>',
      subheadline: 'Pilih buah lokal, impor, musiman, dan tropis. Promo berjalan otomatis, stok real-time, checkout sederhana.',
      ctaLabel: 'Lihat Produk',
      ctaAction: 'scroll_products'
    };

    function getHeroSettings() {
      const s = load(LS.hero, null);
      if (!s || typeof s !== 'object') return { ...DEFAULT_HERO };
      return {
        badge: String(s.badge ?? DEFAULT_HERO.badge),
        headlineHtml: String(s.headlineHtml ?? DEFAULT_HERO.headlineHtml),
        subheadline: String(s.subheadline ?? DEFAULT_HERO.subheadline),
        ctaLabel: String(s.ctaLabel ?? DEFAULT_HERO.ctaLabel),
        ctaAction: String(s.ctaAction ?? DEFAULT_HERO.ctaAction)
      };
    }

    function setHeroSettings(next) {
      const payload = {
        badge: String(next?.badge ?? DEFAULT_HERO.badge),
        headlineHtml: String(next?.headlineHtml ?? DEFAULT_HERO.headlineHtml),
        subheadline: String(next?.subheadline ?? DEFAULT_HERO.subheadline),
        ctaLabel: String(next?.ctaLabel ?? DEFAULT_HERO.ctaLabel),
        ctaAction: String(next?.ctaAction ?? DEFAULT_HERO.ctaAction)
      };
      save(LS.hero, payload);
    }

    function applyHeroToMarketplace() {
      const hero = getHeroSettings();
      const badgeEl = document.getElementById('heroBadge');
      const headlineEl = document.getElementById('heroHeadline');
      const subEl = document.getElementById('heroSubheadline');
      const ctaBtn = document.getElementById('heroCtaBtn');

      if (badgeEl) badgeEl.textContent = hero.badge;
      if (headlineEl) headlineEl.innerHTML = hero.headlineHtml;
      if (subEl) subEl.textContent = hero.subheadline;
      if (ctaBtn) ctaBtn.textContent = hero.ctaLabel;

      // bind action (idempotent)
      if (ctaBtn && !ctaBtn._boundHero) {
        ctaBtn.addEventListener('click', () => {
          const h = getHeroSettings();
          if (h.ctaAction === 'open_cart') {
            openCart();
            return;
          }
          // default: scroll to products
          document.getElementById('productsAnchor')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        ctaBtn._boundHero = true;
      }
    }

    function renderAdminHero() {
      const hero = getHeroSettings();

      const badgeInput = document.getElementById('heroBadgeInput');
      const headInput = document.getElementById('heroHeadlineInput');
      const subInput = document.getElementById('heroSubheadlineInput');
      const ctaLabelInput = document.getElementById('heroCtaLabelInput');
      const ctaActionInput = document.getElementById('heroCtaActionInput');

      if (badgeInput && !badgeInput.value) badgeInput.value = hero.badge;
      if (headInput && !headInput.value) headInput.value = hero.headlineHtml;
      if (subInput && !subInput.value) subInput.value = hero.subheadline;
      if (ctaLabelInput && !ctaLabelInput.value) ctaLabelInput.value = hero.ctaLabel;
      if (ctaActionInput) ctaActionInput.value = hero.ctaAction;

      // apply preview from stored values
      applyHeroPreviewFromInputs();
    }

    function applyHeroPreviewFromInputs() {
      const badge = document.getElementById('heroBadgeInput')?.value ?? '';
      const headlineHtml = document.getElementById('heroHeadlineInput')?.value ?? '';
      const sub = document.getElementById('heroSubheadlineInput')?.value ?? '';
      const ctaLabel = document.getElementById('heroCtaLabelInput')?.value ?? '';

      const pb = document.getElementById('heroPreviewBadge');
      const ph = document.getElementById('heroPreviewHeadline');
      const ps = document.getElementById('heroPreviewSubheadline');
      const pc = document.getElementById('heroPreviewCta');

      if (pb) pb.textContent = badge || DEFAULT_HERO.badge;
      if (ph) ph.innerHTML = (headlineHtml || DEFAULT_HERO.headlineHtml);
      if (ps) ps.textContent = sub || DEFAULT_HERO.subheadline;
      if (pc) pc.textContent = ctaLabel || DEFAULT_HERO.ctaLabel;
    }

    /**********************
     * Store Profile (Logo, Store Name, Bank, Address)
     **********************/
    const DEFAULT_PROFILE = {
      storeName: 'Varsha',
      tagline: 'Fruits and Goods',
      address: '',
      bankName: '',
      bankAccount: '',
      bankHolder: '',
      logoUrl: ''
    };

    function getStoreProfile() {
      const s = load(LS.profile, null);
      if (!s || typeof s !== 'object') return { ...DEFAULT_PROFILE };
      return {
        storeName: String(s.storeName ?? DEFAULT_PROFILE.storeName),
        tagline: String(s.tagline ?? DEFAULT_PROFILE.tagline),
        address: String(s.address ?? DEFAULT_PROFILE.address),
        bankName: String(s.bankName ?? DEFAULT_PROFILE.bankName),
        bankAccount: String(s.bankAccount ?? DEFAULT_PROFILE.bankAccount),
        bankHolder: String(s.bankHolder ?? DEFAULT_PROFILE.bankHolder),
        logoUrl: String(s.logoUrl ?? DEFAULT_PROFILE.logoUrl)
      };
    }

    function setStoreProfile(next) {
      const payload = {
        storeName: String(next?.storeName ?? DEFAULT_PROFILE.storeName),
        tagline: String(next?.tagline ?? DEFAULT_PROFILE.tagline),
        address: String(next?.address ?? DEFAULT_PROFILE.address),
        bankName: String(next?.bankName ?? DEFAULT_PROFILE.bankName),
        bankAccount: String(next?.bankAccount ?? DEFAULT_PROFILE.bankAccount),
        bankHolder: String(next?.bankHolder ?? DEFAULT_PROFILE.bankHolder),
        logoUrl: String(next?.logoUrl ?? DEFAULT_PROFILE.logoUrl)
      };
      save(LS.profile, payload);
    }

    function applyStoreProfileToUI() {
      const p = getStoreProfile();

      // Header
      const nameHeader = document.getElementById('storeNameHeader');
      const taglineHeader = document.getElementById('storeTaglineHeader');
      if (nameHeader) nameHeader.textContent = p.storeName || DEFAULT_PROFILE.storeName;
      if (taglineHeader) taglineHeader.textContent = p.tagline || DEFAULT_PROFILE.tagline;

      const logoImg = document.getElementById('storeLogoImg');
      const logoFallback = document.getElementById('storeLogoFallback');
      if (logoImg && logoFallback) {
        if (p.logoUrl) {
          logoImg.src = p.logoUrl;
          logoImg.classList.remove('hidden');
          logoFallback.classList.add('hidden');
        } else {
          logoImg.removeAttribute('src');
          logoImg.classList.add('hidden');
          logoFallback.classList.remove('hidden');
        }
      }

      // Auth modal
      const nameAuth = document.getElementById('storeNameAuth');
      const taglineAuth = document.getElementById('storeTaglineAuth');
      if (nameAuth) nameAuth.textContent = p.storeName || DEFAULT_PROFILE.storeName;
      if (taglineAuth) taglineAuth.textContent = p.tagline || DEFAULT_PROFILE.tagline;

      const logoAuthImg = document.getElementById('storeLogoAuthImg');
      const logoAuthFallback = document.getElementById('storeLogoAuthFallback');
      if (logoAuthImg && logoAuthFallback) {
        if (p.logoUrl) {
          logoAuthImg.src = p.logoUrl;
          logoAuthImg.classList.remove('hidden');
          logoAuthFallback.classList.add('hidden');
        } else {
          logoAuthImg.removeAttribute('src');
          logoAuthImg.classList.add('hidden');
          logoAuthFallback.classList.remove('hidden');
        }
      }

      // Title
      try {
        document.title = `${p.storeName || 'Varsha'}${p.tagline ? ' ‚Ä¢ ' + p.tagline : ''}`;
      } catch {}
    }

    function updateProfileLogoPreview(url) {
      const img = document.getElementById('profileLogoPreview');
      const fallback = 'https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=200&q=60';
      if (!img) return;
      img.src = url || fallback;
    }

    function applyProfilePreviewFromInputs() {
      const storeName = document.getElementById('profileStoreName')?.value ?? '';
      const tagline = document.getElementById('profileTagline')?.value ?? '';
      const address = document.getElementById('profileAddress')?.value ?? '';
      const bankName = document.getElementById('profileBankName')?.value ?? '';
      const bankAccount = document.getElementById('profileBankAccount')?.value ?? '';
      const bankHolder = document.getElementById('profileBankHolder')?.value ?? '';
      const logoUrl = document.getElementById('profileLogoUrl')?.value ?? '';

      const pName = document.getElementById('profilePreviewName');
      const pTagline = document.getElementById('profilePreviewTagline');
      const pLogoImg = document.getElementById('profilePreviewLogoImg');
      const pLogoFallback = document.getElementById('profilePreviewLogoFallback');
      const pBank = document.getElementById('profilePreviewBank');
      const pAddr = document.getElementById('profilePreviewAddress');

      if (pName) pName.textContent = storeName || DEFAULT_PROFILE.storeName;
      if (pTagline) pTagline.textContent = tagline || DEFAULT_PROFILE.tagline;

      if (pLogoImg && pLogoFallback) {
        if (logoUrl) {
          pLogoImg.src = logoUrl;
          pLogoImg.classList.remove('hidden');
          pLogoFallback.classList.add('hidden');
        } else {
          pLogoImg.removeAttribute('src');
          pLogoImg.classList.add('hidden');
          pLogoFallback.classList.remove('hidden');
        }
      }

      const bankLine = [bankName, bankAccount, bankHolder].filter(Boolean).join(' ‚Ä¢ ');
      if (pBank) pBank.textContent = bankLine || '-';
      if (pAddr) pAddr.textContent = address || '-';

      updateProfileLogoPreview(logoUrl);
    }

    function renderAdminProfile() {
      const p = getStoreProfile();
      const storeName = document.getElementById('profileStoreName');
      const tagline = document.getElementById('profileTagline');
      const address = document.getElementById('profileAddress');
      const bankName = document.getElementById('profileBankName');
      const bankAcc = document.getElementById('profileBankAccount');
      const bankHolder = document.getElementById('profileBankHolder');
      const logoUrl = document.getElementById('profileLogoUrl');

      if (storeName && !storeName.value) storeName.value = p.storeName;
      if (tagline && !tagline.value) tagline.value = p.tagline;
      if (address && !address.value) address.value = p.address;
      if (bankName && !bankName.value) bankName.value = p.bankName;
      if (bankAcc && !bankAcc.value) bankAcc.value = p.bankAccount;
      if (bankHolder && !bankHolder.value) bankHolder.value = p.bankHolder;
      if (logoUrl && !logoUrl.value) logoUrl.value = p.logoUrl;

      updateProfileLogoPreview(p.logoUrl);
      applyProfilePreviewFromInputs();
    }

    async function uploadStoreLogoToCloud(file) {
      const enabled = !!load(LS.cloudEnabled, false);
      const shopId = String(load(LS.cloudShopId, '') || '').trim();
      if (!enabled || !cloud.connected) throw new Error('Cloud Sync belum tersambung. Buka Cloud: ... lalu Connect.');
      if (!shopId) throw new Error('Shop ID belum diisi.');
      if (!file) throw new Error('Pilih file logo dulu.');
      if (!file.type?.startsWith('image/')) throw new Error('File harus gambar (image/*).');

      if (!cloud.auth?.currentUser) {
        await cloud.auth.signInAnonymously();
      }
      try { await cloud.auth.currentUser.getIdToken(true); } catch {}

      if (!cloud.bucket) {
        await cloudPickWorkingBucket(shopId, { timeoutMs: 9000 });
      }

      const deviceId = getOrCreateDeviceId();
      const ext = guessExtFromFile(file);
      const filename = `store_logo_${Date.now()}_${deviceId}.${ext}`;
      const storagePath = `varsha_shops/${shopId}/store_profile/${filename}`;

      const meta = {
        contentType: file.type || 'image/jpeg',
        cacheControl: 'public,max-age=31536000'
      };

      const wrap = document.getElementById('profileUploadProgressWrap');
      const bar = document.getElementById('profileUploadProgressBar');
      const txt = document.getElementById('profileUploadProgressText');
      if (wrap) wrap.classList.remove('hidden');
      if (bar) bar.style.width = '0%';
      if (txt) txt.textContent = '0%';

      const ref = cloudStorageRef(storagePath);
      const task = ref.put(file, meta);

      await awaitPutTask(task, {
        timeoutMs: 15000,
        onProgress: (snap) => {
          const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
          if (bar) bar.style.width = pct + '%';
          if (txt) txt.textContent = pct + '%';
        }
      });

      const url = await task.snapshot.ref.getDownloadURL();
      return { url, storagePath, bucket: cloud.bucket };
    }

    /**********************
     * Promo logic
     **********************/
    function isPromoScheduledActive(promo) {
      if (!promo || !promo.active || !promo.discountPct) return false;
      const today = toISODate(new Date());
      const start = promo.start || '';
      const end = promo.end || '';
      if (start && today < start) return false;
      if (end && today > end) return false;
      return true;
    }

    function effectivePrice(product) {
      const promoOn = isPromoScheduledActive(product.promo);
      if (!promoOn) return { price: product.priceSell, promoOn: false, discountPct: 0 };
      const pct = clamp(Number(product.promo.discountPct || 0), 0, 90);
      const price = Math.round(product.priceSell * (1 - pct/100));
      return { price, promoOn: true, discountPct: pct };
    }

    /**********************
     * Routing
     **********************/
    const views = {
      market: 'view-market',
      'customer.shipping': 'view-customer-shipping',
      'admin.dashboard': 'view-admin-dashboard',
      'admin.profile': 'view-admin-profile',
      'admin.hero': 'view-admin-hero',
      'admin.products': 'view-admin-products',
      'admin.purchases': 'view-admin-purchases',
      'admin.promos': 'view-admin-promos',
      'admin.shipping': 'view-admin-shipping',
      'admin.transactions': 'view-admin-transactions',
      'admin.reports': 'view-admin-reports'
    };

    function routeTo(route) {
      // guard: non-admin cannot access admin routes
      if (String(route || '').startsWith('admin.') && !isAdmin()) {
        toast('Akses ditolak. Menu admin khusus admin.');
        route = 'market';
      }

      // guard: admin doesn't need customer shipping view
      if (String(route || '') === 'customer.shipping' && isAdmin()) {
        route = 'admin.dashboard';
      }

      state.route = route;

      // Toggle admin layout wrapper
      const adminLayout = document.getElementById('adminLayout');
      if (adminLayout) {
        adminLayout.classList.toggle('hidden', !String(route || '').startsWith('admin.'));
      }

      for (const [k, id] of Object.entries(views)) {
        document.getElementById(id).classList.toggle('hidden', k !== route);
      }
      document.querySelectorAll('.route-btn').forEach(btn => {
        btn.classList.toggle('active-route', btn.dataset.route === route);
      });
      document.getElementById('mobileNav').classList.add('hidden');

      // keep UI in sync with role
      try { applyRoleUI(); } catch {}

      // Auto-pull when entering admin views (per request)
      if (String(route || '').startsWith('admin.')) {
        cloudAutoPullIfNeeded(`route:${route}`);
      }

      // render on route
      if (route === 'market') renderMarketplace();
      if (route === 'customer.shipping') renderCustomerShipping();
      if (route === 'admin.dashboard') renderDashboard();
      if (route === 'admin.profile') renderAdminProfile();
      if (route === 'admin.hero') renderAdminHero();
      if (route === 'admin.products') renderAdminProducts();
      if (route === 'admin.purchases') renderPurchases();
      if (route === 'admin.promos') renderPromos();
      if (route === 'admin.shipping') renderShipping();
      if (route === 'admin.transactions') renderTransactions();
      if (route === 'admin.reports') renderReports();
    }

    /**********************
     * Marketplace rendering
     **********************/
    function filterProductsForMarket(products) {
      const cat = state.categoryFilter;
      const q = state.search.trim().toLowerCase();
      return products.filter(p => {
        const okCat = !cat || p.category === cat;
        const okQ = !q || p.name.toLowerCase().includes(q);
        return okCat && okQ;
      });
    }

    function renderPromoMarquee(products) {
      const promos = products.filter(p => isPromoScheduledActive(p.promo));
      const track = document.getElementById('promoTrack');
      track.innerHTML = '';
      const items = promos.length ? promos : [{ name: 'Tidak ada promo aktif saat ini. Cek kembali nanti!', category: '', promo: { discountPct: 0 } }];

      const makeChip = (p) => {
        const pct = p.promo?.discountPct ? `${p.promo.discountPct}%` : '';
        const start = p.promo?.start ? p.promo.start : '';
        const end = p.promo?.end ? p.promo.end : '';
        const dateText = (start || end) ? ` (${start || '-'} s/d ${end || '-'})` : '';
        const text = p.promo?.discountPct ? `PROMO ${pct} ‚Ä¢ ${p.name}${dateText}` : p.name;
        const el = document.createElement('div');
        el.className = 'mx-2 inline-flex items-center gap-2 rounded-full border bg-white/70 px-3 py-1.5 text-xs font-semibold text-emerald-800';
        el.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-500"></span><span>${text}</span>`;
        return el;
      };

      const row = document.createElement('div');
      row.className = 'flex items-center';
      items.forEach(p => row.appendChild(makeChip(p)));
      // duplicate for seamless loop
      const row2 = row.cloneNode(true);
      track.appendChild(row);
      track.appendChild(row2);

      track.parentElement.style.setProperty('--speed', promos.length ? '18s' : '26s');
    }

    function productCard(p) {
      const { price, promoOn, discountPct } = effectivePrice(p);
      const base = p.priceSell;
      const lowStock = p.stock <= 5;
      const disabled = p.stock <= 0;
      const img = p.image || 'https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=800&q=60';

      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl border bg-white overflow-hidden hover:shadow-md transition-shadow';
      wrap.innerHTML = `
        <div class="relative">
          <img alt="${p.name}" class="h-40 w-full object-cover" src="${img}">
          ${promoOn ? `<div class="absolute left-3 top-3 rounded-full bg-rose-600 px-2.5 py-1 text-xs font-extrabold text-white">-${discountPct}%</div>` : ''}
          ${lowStock ? `<div class="absolute right-3 top-3 rounded-full bg-amber-500 px-2.5 py-1 text-xs font-extrabold text-white">Stok rendah</div>` : ''}
        </div>
        <div class="p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm font-extrabold">${p.name}</div>
              <div class="text-xs text-slate-500">${p.category} ‚Ä¢ Stok: ${p.stock}</div>
            </div>
            <div class="text-right">
              <div class="text-sm font-extrabold text-emerald-700">${rupiah(price)}</div>
              ${promoOn ? `<div class="text-xs text-slate-400 line-through">${rupiah(base)}</div>` : `<div class="text-xs text-slate-400">&nbsp;</div>`}
            </div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <div class="flex items-center gap-1 rounded-xl border px-2 py-1.5">
              <button class="qty-btn rounded-lg px-2 py-1 hover:bg-slate-50" data-act="dec" data-id="${p.id}" aria-label="Kurangi">‚àí</button>
              <input class="qty-input no-spin w-12 text-center text-sm" type="number" min="1" value="1" data-id="${p.id}">
              <button class="qty-btn rounded-lg px-2 py-1 hover:bg-slate-50" data-act="inc" data-id="${p.id}" aria-label="Tambah">+</button>
            </div>
            <button class="add-to-cart flex-1 rounded-xl ${disabled ? 'bg-slate-200 text-slate-500 cursor-not-allowed' : 'bg-emerald-600 text-white hover:bg-emerald-700'} px-4 py-2 text-sm font-bold" data-id="${p.id}" ${disabled ? 'disabled' : ''}>
              ${disabled ? 'Habis' : 'Tambah'}
            </button>
          </div>
        </div>
      `;
      return wrap;
    }

    function renderMarketplace() {
      // Apply hero settings (badge/headline/subheadline/cta)
      try { applyHeroToMarketplace(); } catch {}

      const products = getProducts();
      renderPromoMarquee(products);

      const filtered = filterProductsForMarket(products);
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      filtered.forEach(p => grid.appendChild(productCard(p)));

      document.getElementById('productCount').textContent = filtered.length;
      document.getElementById('emptyProducts').classList.toggle('hidden', filtered.length !== 0);

      // bind events for qty/add
      grid.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          const input = grid.querySelector(`.qty-input[data-id="${id}"]`);
          const current = Number(input.value || 1);
          const next = act === 'inc' ? current + 1 : Math.max(1, current - 1);
          input.value = String(next);
        });
      });
      grid.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const input = grid.querySelector(`.qty-input[data-id="${id}"]`);
          const qty = clamp(Number(input.value || 1), 1, 9999);
          addToCart(id, qty);
        });
      });
    }

    /**********************
     * Cart
     **********************/
    function addToCart(productId, qty) {
      const products = getProducts();
      const p = products.find(x => x.id === productId);
      if (!p) return;
      if (p.stock <= 0) return toast('Stok habis.');
      const max = p.stock;
      const addQty = clamp(qty, 1, max);

      const cart = getCart();
      const existing = cart.find(i => i.productId === productId);
      const newQty = clamp((existing?.qty || 0) + addQty, 1, max);
      if (existing) existing.qty = newQty;
      else cart.push({ productId, qty: addQty });
      setCart(cart);
      toast(`Ditambahkan: ${p.name} x${addQty}`);
      renderCart();
      renderMarketplace();
    }

    function cartDetailed() {
      const cart = getCart();
      const products = getProducts();
      return cart.map(i => {
        const p = products.find(x => x.id === i.productId);
        if (!p) return null;
        const { price, promoOn, discountPct } = effectivePrice(p);
        return {
          productId: i.productId,
          name: p.name,
          category: p.category,
          qty: clamp(Number(i.qty || 1), 1, Math.max(1, p.stock)),
          stock: p.stock,
          priceUnit: price,
          priceSellBase: p.priceSell,
          priceBuy: p.priceBuy,
          promoOn,
          discountPct,
          image: p.image
        };
      }).filter(Boolean);
    }

    function renderCart() {
      const items = cartDetailed();
      const cartItems = document.getElementById('cartItems');
      cartItems.innerHTML = '';

      const count = items.reduce((a, b) => a + b.qty, 0);
      const badge = document.getElementById('cartCountBadge');
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else badge.classList.add('hidden');
      document.getElementById('cartSub').textContent = `${count} item`;

      const total = items.reduce((a, b) => a + b.qty * b.priceUnit, 0);
      document.getElementById('cartTotal').textContent = rupiah(total);
      document.getElementById('checkoutTotal').textContent = rupiah(total);

      document.getElementById('cartEmpty').classList.toggle('hidden', items.length !== 0);

      for (const it of items) {
        const row = document.createElement('div');
        row.className = 'rounded-2xl border bg-white p-3';
        const img = it.image || 'https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=800&q=60';
        const line = it.promoOn ? `<div class="text-xs text-slate-400 line-through">${rupiah(it.priceSellBase)} / unit</div>` : `<div class="text-xs text-slate-400">${rupiah(it.priceUnit)} / unit</div>`;
        row.innerHTML = `
          <div class="flex gap-3">
            <img class="h-16 w-16 rounded-xl object-cover border" src="${img}" alt="${it.name}" />
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="text-sm font-extrabold truncate">${it.name}</div>
                  <div class="text-xs text-slate-500">${it.category} ‚Ä¢ Stok: ${it.stock}</div>
                </div>
                <button class="remove-item rounded-lg p-2 hover:bg-slate-100" data-id="${it.productId}" aria-label="Hapus">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                </button>
              </div>
              <div class="mt-1 flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm font-bold text-emerald-700">${rupiah(it.priceUnit)}</div>
                  ${line}
                </div>
                <div class="flex items-center gap-1 rounded-xl border px-2 py-1.5">
                  <button class="cart-qty rounded-lg px-2 py-1 hover:bg-slate-50" data-act="dec" data-id="${it.productId}">‚àí</button>
                  <div class="w-8 text-center text-sm font-semibold">${it.qty}</div>
                  <button class="cart-qty rounded-lg px-2 py-1 hover:bg-slate-50" data-act="inc" data-id="${it.productId}">+</button>
                </div>
              </div>
              <div class="mt-2 text-right text-sm font-extrabold">Subtotal: ${rupiah(it.qty * it.priceUnit)}</div>
            </div>
          </div>
        `;
        cartItems.appendChild(row);
      }

      cartItems.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          let cart = getCart();
          cart = cart.filter(i => i.productId !== id);
          setCart(cart);
          renderCart();
          renderMarketplace();
        });
      });
      cartItems.querySelectorAll('.cart-qty').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          const cart = getCart();
          const products = getProducts();
          const p = products.find(x => x.id === id);
          const it = cart.find(x => x.productId === id);
          if (!p || !it) return;
          let q = Number(it.qty || 1);
          if (act === 'inc') q += 1; else q -= 1;
          q = clamp(q, 1, Math.max(1, p.stock));
          it.qty = q;
          setCart(cart);
          renderCart();
        });
      });

      // update cart if any item exceeds stock (after stock changes)
      let cart = getCart();
      let changed = false;
      const products = getProducts();
      for (const it of cart) {
        const p = products.find(x => x.id === it.productId);
        if (!p) continue;
        const max = p.stock;
        if (max <= 0) { it.qty = 0; changed = true; }
        else if (it.qty > max) { it.qty = max; changed = true; }
      }
      if (changed) {
        cart = cart.filter(i => i.qty > 0);
        setCart(cart);
      }
    }

    function openCart() {
      document.getElementById('cartOverlay').classList.remove('hidden');
      renderCart();
    }
    function closeCart() {
      document.getElementById('cartOverlay').classList.add('hidden');
    }

    function clearCart() {
      setCart([]);
      toast('Keranjang dikosongkan.');
      renderCart();
      renderMarketplace();
    }

    /**********************
     * Checkout
     **********************/
    function openCheckout() {
      const items = cartDetailed();
      if (items.length === 0) return toast('Keranjang masih kosong.');

      const u = currentUser();
      if (!u) {
        toast('Silakan login dulu untuk order.');
        document.getElementById('authModal')?.classList.remove('hidden');
        return;
      }

      // Auto-connect cloud in background so confirm checkout can push immediately
      // (Works if Firebase config + Shop ID already saved)
      try { cloudEnsureConnected({ silent: true, forceConnect: true }); } catch {}

      // Autofill from logged-in user
      try {
        const nameEl = document.getElementById('buyerName');
        const waEl = document.getElementById('buyerWhatsApp');
        if (nameEl && !nameEl.value) nameEl.value = u.name || '';
        if (waEl && !waEl.value) waEl.value = u.whatsApp || '';
      } catch {}

      document.getElementById('checkoutModal').classList.remove('hidden');
      // focus to address so customer tinggal isi alamat
      document.getElementById('buyerAddress')?.focus();
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function showOrderSuccess(tx) {
      const m = document.getElementById('orderSuccessModal');
      const sub = document.getElementById('orderSuccessSub');
      if (sub) {
        const id = tx?.id ? `ID: ${tx.id}` : '';
        const total = (tx?.total !== undefined) ? `Total: ${rupiah(tx.total)}` : '';
        sub.textContent = [id, total].filter(Boolean).join(' ‚Ä¢ ') || 'Order berhasil dikirim.';
      }
      if (m) m.classList.remove('hidden');
    }

    async function doCheckout({ name, address, note = '', whatsApp = '', txIdOverride = '' } = {}) {
      const items = cartDetailed();
      if (items.length === 0) return null;

      try {
        // For multi-device consistency: pull -> validate -> write -> push
        const tx = await cloudSyncWrite(() => {
          const products = getProducts();

          // validate stock against latest local (which is already pulled)
          for (const it of items) {
            const p = products.find(x => x.id === it.productId);
            if (!p || p.stock < it.qty) {
              toast('Stok berubah. Silakan cek keranjang.');
              renderCart();
              renderMarketplace();
              throw new Error('stock_changed');
            }
          }

          // compute totals
          let total = 0;
          let profit = 0;
          const txItems = items.map(it => {
            const revenue = it.qty * it.priceUnit;
            const cost = it.qty * Number(it.priceBuy || 0);
            total += revenue;
            profit += (revenue - cost);
            return {
              productId: it.productId,
              name: it.name,
              qty: it.qty,
              unitPrice: it.priceUnit,
              discountPct: it.promoOn ? it.discountPct : 0,
              unitSellBase: it.priceSellBase,
              unitBuy: it.priceBuy,
              revenue,
              cost
            };
          });

          // update stock
          for (const it of items) {
            const p = products.find(x => x.id === it.productId);
            p.stock = Math.max(0, Number(p.stock || 0) - it.qty);
          }
          setProducts(products);

          // record transaction
          const tx = {
            id: txIdOverride || uid('TX'),
            date: new Date().toISOString(),
            buyerName: name,
            buyerEmail: String(currentUser()?.email || '').trim().toLowerCase(),
            buyerWhatsApp: whatsApp || '',
            buyerAddress: address,
            buyerNote: note || '',
            total,
            profit,
            items: txItems,
            shipping: {
              status: 'pending',
              updatedAt: new Date().toISOString(),
              updatedBy: 'system',
              fee: 0,
              billConfirmedAt: '',
              billConfirmedBy: ''
            }
          };
          const txs = getTransactions();
          txs.unshift(tx);
          setTransactions(txs);

          // clear cart
          setCart([]);

          return tx;
        }, { reason: 'checkout' });

        if (!tx) return null;

        toast('Checkout sukses! Transaksi tercatat.');

        // Alternative to Firebase: send order webhook (non-blocking)
        try { sendOrderWebhook(tx); } catch {}

        // reset checkout note field (optional)
        try { const nEl = document.getElementById('buyerNote'); if (nEl) nEl.value = ''; } catch {}

        closeModal('checkoutModal');
        closeCart();
        rerenderAll();
        routeTo(isAdmin() ? 'admin.dashboard' : 'market');

        // Show success box
        try { showOrderSuccess(tx); } catch {}

        return tx;
      } catch (e) {
        if (String(e?.message || '') === 'stock_changed') return null;
        console.warn(e);
        return null;
      }
    }

    /**********************
     * Admin products
     **********************/
    function renderAdminProducts() {
      const products = getProducts();
      const q = state.adminProductSearch.trim().toLowerCase();
      const cat = state.adminCategoryFilter;

      let list = products.slice();
      if (q) list = list.filter(p => p.name.toLowerCase().includes(q));
      if (cat) list = list.filter(p => p.category === cat);
      if (state.stockLowOnly) list = list.filter(p => Number(p.stock || 0) < 10);

      const body = document.getElementById('adminProductsBody');
      body.innerHTML = '';

      for (const p of list) {
        const promoOn = isPromoScheduledActive(p.promo);
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="py-3">
            <div class="flex items-center gap-3">
              <img class="h-10 w-10 rounded-xl object-cover border" src="${p.image || 'https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=200&q=60'}" alt="${p.name}" />
              <div>
                <div class="font-extrabold">${p.name}</div>
                <div class="text-xs text-slate-500">ID: ${p.id}</div>
              </div>
            </div>
          </td>
          <td class="py-3">${p.category}</td>
          <td class="py-3">${rupiah(p.priceBuy)}</td>
          <td class="py-3">${rupiah(p.priceSell)}</td>
          <td class="py-3">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-bold ${p.stock <= 0 ? 'bg-rose-100 text-rose-700' : p.stock < 10 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${p.stock}</span>
          </td>
          <td class="py-3">
            ${p.promo?.discountPct ? `<span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-bold ${promoOn ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-600'}">${p.promo.discountPct}% ‚Ä¢ ${promoOn ? 'Aktif' : 'Terjadwal'}</span>` : `<span class="text-xs text-slate-400">-</span>`}
          </td>
          <td class="py-3 text-right">
            <button class="edit-product rounded-xl border px-3 py-1.5 text-sm font-semibold hover:bg-slate-50" data-id="${p.id}">Edit</button>
          </td>
        `;
        body.appendChild(tr);
      }

      body.querySelectorAll('.edit-product').forEach(btn => {
        btn.addEventListener('click', () => openProductModal(btn.dataset.id));
      });

      // update selects in other admin forms
      fillProductSelects();
    }

    function openProductModal(productId=null) {
      const modal = document.getElementById('productModal');
      modal.classList.remove('hidden');

      const title = document.getElementById('productModalTitle');
      const delBtn = document.getElementById('deleteProductBtn');
      const pushBtn = document.getElementById('pushProductCloudBtn');

      // reset upload UI
      const fileEl = document.getElementById('productImageFile');
      const wrap = document.getElementById('uploadProgressWrap');
      const bar = document.getElementById('uploadProgressBar');
      const txt = document.getElementById('uploadProgressText');
      if (fileEl) fileEl.value = '';
      if (wrap) wrap.classList.add('hidden');
      if (bar) bar.style.width = '0%';
      if (txt) txt.textContent = '0%';

      // bind URL -> preview (idempotent)
      const urlEl = document.getElementById('productImage');
      if (urlEl && !urlEl._boundPreview) {
        urlEl.addEventListener('input', () => updateProductImagePreview(urlEl.value.trim()));
        urlEl._boundPreview = true;
      }

      if (!productId) {
        title.textContent = 'Tambah Produk';
        delBtn.classList.add('hidden');
        if (pushBtn) pushBtn.classList.add('hidden');
        document.getElementById('productId').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productCategory').value = 'Lokal';
        document.getElementById('productStock').value = 0;
        document.getElementById('productBuy').value = '';
        document.getElementById('productSell').value = '';
        document.getElementById('productImage').value = '';
        updateProductImagePreview('');
        document.getElementById('productName').focus();
        return;
      }

      const p = getProducts().find(x => x.id === productId);
      if (!p) return;
      title.textContent = 'Edit Produk';
      delBtn.classList.remove('hidden');
      if (pushBtn) pushBtn.classList.remove('hidden');

      document.getElementById('productId').value = p.id;
      document.getElementById('productName').value = p.name;
      document.getElementById('productCategory').value = p.category;
      document.getElementById('productStock').value = p.stock;
      document.getElementById('productBuy').value = p.priceBuy;
      document.getElementById('productSell').value = p.priceSell;
      document.getElementById('productImage').value = p.image || '';
      updateProductImagePreview(p.image || '');

      delBtn.onclick = () => {
        if (!confirm('Hapus produk ini?')) return;
        cloudSyncWrite(() => {
          const products = getProducts().filter(x => x.id !== p.id);
          setProducts(products);
          toast('Produk dihapus.');
          closeModal('productModal');
          rerenderAll();
          routeTo('admin.products');
        }, { reason: 'deleteProduct' }).catch((e) => console.warn(e));
      };

      // Manual push button (quick send snapshot to cloud)
      if (pushBtn) {
        pushBtn.onclick = async () => {
          const enabled = !!load(LS.cloudEnabled, false);
          const shopId = String(load(LS.cloudShopId, '') || '').trim();
          if (!enabled) return toast('Cloud Sync belum aktif. Buka menu Laporan ‚Üí Cloud Sync ‚Üí Connect.');
          if (!cloud.connected) return toast('Cloud belum connect. Buka menu Laporan ‚Üí Cloud Sync ‚Üí Connect.');
          if (!shopId) return toast('Shop ID belum diisi.');

          try {
            pushBtn.disabled = true;
            pushBtn.classList.add('opacity-60');
            pushBtn.textContent = 'Pushing...';
            await cloudPush(shopId, { silent: false });
            hideCloudError();
          } catch (e) {
            console.warn(e);
            toast('Gagal push ke cloud. Lihat detail di menu Laporan.');
            showCloudError(e);
          } finally {
            pushBtn.disabled = false;
            pushBtn.classList.remove('opacity-60');
            pushBtn.textContent = 'Push (Kirim ke Cloud)';
          }
        };
      }
    }

    function upsertProduct(formData) {
      cloudSyncWrite(() => {
        const products = getProducts();
        const id = formData.id || uid('PRD');
        const existing = products.find(p => p.id === id);
        const payload = {
          id,
          name: formData.name.trim(),
          category: formData.category,
          stock: Math.max(0, Number(formData.stock || 0)),
          priceBuy: Math.max(0, Number(formData.priceBuy || 0)),
          priceSell: Math.max(0, Number(formData.priceSell || 0)),
          image: formData.image.trim(),
          promo: existing?.promo || { active: false, discountPct: 0, start: '', end: '' }
        };

        if (existing) {
          Object.assign(existing, payload);
          toast('Produk diperbarui.');
        } else {
          products.unshift(payload);
          toast('Produk ditambahkan.');
        }
        setProducts(products);

        closeModal('productModal');
        rerenderAll();
        routeTo('admin.products');
      }, { reason: 'upsertProduct' }).catch((e) => console.warn(e));
    }

    /**********************
     * Purchases
     **********************/
    function fillProductSelects() {
      const products = getProducts();
      const purchaseSel = document.getElementById('purchaseProduct');
      const promoSel = document.getElementById('promoProduct');
      if (!purchaseSel || !promoSel) return;

      const makeOptions = (sel, keepValue=true) => {
        const prev = sel.value;
        sel.innerHTML = '';
        for (const p of products) {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.name} (Stok ${p.stock})`;
          sel.appendChild(opt);
        }
        if (keepValue && prev && [...sel.options].some(o => o.value === prev)) sel.value = prev;
      };
      makeOptions(purchaseSel);
      makeOptions(promoSel);
    }

    function renderPurchases() {
      fillProductSelects();
      const purchases = getPurchases();
      const products = getProducts();

      const body = document.getElementById('purchaseHistoryBody');
      body.innerHTML = '';
      const last = purchases.slice(0, 12);
      for (const r of last) {
        const p = products.find(x => x.id === r.productId);
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="py-3">${new Date(r.date).toLocaleString('id-ID')}</td>
          <td class="py-3">${p ? p.name : r.productName || 'Produk (terhapus)'}</td>
          <td class="py-3">${r.qty}</td>
          <td class="py-3">${rupiah(r.buyPrice)}</td>
          <td class="py-3">${r.sellPrice ? rupiah(r.sellPrice) : '<span class="text-xs text-slate-400">-</span>'}</td>
        `;
        body.appendChild(tr);
      }
      if (last.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="5">Belum ada pembelian.</td>`;
        body.appendChild(tr);
      }

      // Fill buy price hint from selected product
      const purchaseProduct = document.getElementById('purchaseProduct');
      const buyInput = document.getElementById('purchaseBuyPrice');
      if (purchaseProduct && buyInput && !buyInput.value) {
        const p = products.find(x => x.id === purchaseProduct.value);
        if (p) buyInput.placeholder = `cth: ${p.priceBuy}`;
      }
    }

    function addPurchase({ productId, qty, buyPrice, sellPrice }) {
      cloudSyncWrite(() => {
        const products = getProducts();
        const p = products.find(x => x.id === productId);
        if (!p) return toast('Produk tidak ditemukan.');
        const q = clamp(Number(qty || 0), 1, 1e9);
        const bp = Math.max(0, Number(buyPrice || 0));
        const sp = sellPrice !== '' && sellPrice !== null && sellPrice !== undefined ? Math.max(0, Number(sellPrice || 0)) : null;
        if (!bp) return toast('Harga beli harus diisi.');

        p.stock = Number(p.stock || 0) + q;
        p.priceBuy = bp;
        if (sp !== null) p.priceSell = sp;
        setProducts(products);

        const purchases = getPurchases();
        purchases.unshift({
          id: uid('BUY'),
          date: new Date().toISOString(),
          productId,
          productName: p.name,
          qty: q,
          buyPrice: bp,
          sellPrice: sp
        });
        setPurchases(purchases);

        toast('Pembelian tersimpan & stok terupdate.');
        rerenderAll();
        routeTo('admin.purchases');
      }, { reason: 'purchase' }).catch((e) => console.warn(e));
    }

    /**********************
     * Promos
     **********************/
    function renderPromos() {
      fillProductSelects();
      const products = getProducts();
      const body = document.getElementById('promoTableBody');
      body.innerHTML = '';

      const list = products.filter(p => p.promo && (p.promo.discountPct || p.promo.start || p.promo.end || p.promo.active));

      for (const p of list) {
        const promo = p.promo || {};
        const scheduledOn = isPromoScheduledActive(promo);
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="py-3">
            <div class="font-extrabold">${p.name}</div>
            <div class="text-xs text-slate-500">${p.category} ‚Ä¢ Harga jual ${rupiah(p.priceSell)}</div>
          </td>
          <td class="py-3">${promo.discountPct ? promo.discountPct + '%' : '-'}</td>
          <td class="py-3">${promo.start || '-'}</td>
          <td class="py-3">${promo.end || '-'}</td>
          <td class="py-3">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-bold ${scheduledOn ? 'bg-rose-100 text-rose-700' : promo.active ? 'bg-slate-100 text-slate-700' : 'bg-slate-50 text-slate-400'}">${scheduledOn ? 'Aktif' : promo.active ? 'Terjadwal' : 'Nonaktif'}</span>
          </td>
          <td class="py-3 text-right">
            <button class="edit-promo rounded-xl border px-3 py-1.5 text-sm font-semibold hover:bg-slate-50" data-id="${p.id}">Edit</button>
          </td>
        `;
        body.appendChild(tr);
      }
      if (list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="6">Belum ada promo yang diset.</td>`;
        body.appendChild(tr);
      }

      body.querySelectorAll('.edit-promo').forEach(btn => btn.addEventListener('click', () => loadPromoToForm(btn.dataset.id)));

      // set default date range for form
      const start = document.getElementById('promoStart');
      const end = document.getElementById('promoEnd');
      if (!start.value) start.value = toISODate(new Date());
      if (!end.value) end.value = toISODate(new Date(Date.now()+7*864e5));
    }

    function loadPromoToForm(productId) {
      const p = getProducts().find(x => x.id === productId);
      if (!p) return;
      document.getElementById('promoProduct').value = p.id;
      document.getElementById('promoDiscount').value = p.promo?.discountPct ?? 0;
      document.getElementById('promoActive').checked = !!p.promo?.active;
      document.getElementById('promoStart').value = p.promo?.start || '';
      document.getElementById('promoEnd').value = p.promo?.end || '';
      toast('Promo dimuat ke form.');
    }

    function savePromo({ productId, discountPct, start, end, active }) {
      cloudSyncWrite(() => {
        const products = getProducts();
        const p = products.find(x => x.id === productId);
        if (!p) return;
        const pct = clamp(Number(discountPct || 0), 0, 90);
        p.promo = {
          active: !!active,
          discountPct: pct,
          start: start || '',
          end: end || ''
        };
        setProducts(products);
        toast('Promo disimpan.');
        rerenderAll();
        routeTo('admin.promos');
      }, { reason: 'savePromo' }).catch((e) => console.warn(e));
    }

    function clearPromo(productId) {
      cloudSyncWrite(() => {
        const products = getProducts();
        const p = products.find(x => x.id === productId);
        if (!p) return;
        p.promo = { active: false, discountPct: 0, start: '', end: '' };
        setProducts(products);
        toast('Promo dihapus.');
        rerenderAll();
        routeTo('admin.promos');
      }, { reason: 'clearPromo' }).catch((e) => console.warn(e));
    }

    /**********************
     * Dashboard
     **********************/
    function getRangeFromPeriod(period) {
      const now = new Date();
      const start = new Date(now);
      const end = new Date(now);

      if (period === 'today') {
        return { from: toISODate(now), to: toISODate(now) };
      }
      if (period === 'week') {
        const day = (now.getDay() + 6) % 7; // 0=Mon
        start.setDate(now.getDate() - day);
        return { from: toISODate(start), to: toISODate(end) };
      }
      if (period === 'month') {
        start.setDate(1);
        return { from: toISODate(start), to: toISODate(end) };
      }
      if (period === 'year') {
        start.setMonth(0, 1);
        return { from: toISODate(start), to: toISODate(end) };
      }
      return { from: '', to: '' };
    }

    function txInRange(tx, from, to) {
      const d = toISODate(new Date(tx.date));
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function computeDashboard(from, to) {
      const txs = getTransactions();
      const inRange = txs.filter(tx => txInRange(tx, from, to));
      const revenue = inRange.reduce((a, b) => a + Number(b.total || 0), 0);
      const profit = inRange.reduce((a, b) => a + Number(b.profit || 0), 0);
      const units = inRange.reduce((a, b) => a + (b.items || []).reduce((x, y) => x + Number(y.qty || 0), 0), 0);
      return { inRange, revenue, profit, units, txCount: inRange.length };
    }

    function buildSalesSeries(txs, from, to) {
      // daily series from..to
      const start = from ? parseDate(from) : null;
      const end = to ? parseDate(to) : null;
      const now = new Date();
      const s = start || new Date(now.getFullYear(), now.getMonth(), 1);
      const e = end || now;
      const days = [];
      const map = new Map();
      for (const tx of txs) {
        const d = toISODate(new Date(tx.date));
        map.set(d, (map.get(d) || 0) + Number(tx.total || 0));
      }
      const cur = new Date(s);
      while (cur <= e) {
        const d = toISODate(cur);
        days.push({ date: d, total: map.get(d) || 0 });
        cur.setDate(cur.getDate() + 1);
      }
      return days;
    }

    function buildTopProducts(txs) {
      const map = new Map();
      for (const tx of txs) {
        for (const it of (tx.items || [])) {
          map.set(it.name, (map.get(it.name) || 0) + Number(it.qty || 0));
        }
      }
      const arr = [...map.entries()].map(([name, qty]) => ({ name, qty })).sort((a,b)=>b.qty-a.qty).slice(0, 8);
      return arr;
    }

    function renderDashboard() {
      // init default range from selected period if empty or not custom
      const period = document.getElementById('periodSelect').value;
      if (period !== 'custom') {
        const r = getRangeFromPeriod(period);
        document.getElementById('dateFrom').value = r.from;
        document.getElementById('dateTo').value = r.to;
        state.dashboardRange = r;
      } else {
        state.dashboardRange = {
          from: document.getElementById('dateFrom').value,
          to: document.getElementById('dateTo').value
        };
      }

      const { from, to } = state.dashboardRange;
      const stats = computeDashboard(from, to);
      document.getElementById('sumRevenue').textContent = rupiah(stats.revenue);
      document.getElementById('sumTransactions').textContent = String(stats.txCount);
      document.getElementById('sumUnits').textContent = String(stats.units);
      document.getElementById('sumProfit').textContent = rupiah(stats.profit);

      // latest transactions
      const latest = getTransactions().slice(0, 8);
      const body = document.getElementById('latestTxBody');
      body.innerHTML = '';
      if (latest.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="6">Belum ada transaksi.</td>`;
        body.appendChild(tr);
      } else {
        for (const tx of latest) {
          const itemCount = (tx.items || []).reduce((a,b)=>a+Number(b.qty||0),0);
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0';
          tr.innerHTML = `
            <td class="py-3 font-semibold">${tx.id}</td>
            <td class="py-3">${new Date(tx.date).toLocaleString('id-ID')}</td>
            <td class="py-3">${tx.buyerName || '-'}</td>
            <td class="py-3">${rupiah(tx.total)}</td>
            <td class="py-3">${rupiah(tx.profit)}</td>
            <td class="py-3">${itemCount}</td>
          `;
          body.appendChild(tr);
        }
      }

      // charts
      const series = buildSalesSeries(stats.inRange, from, to);
      const top = buildTopProducts(stats.inRange);
      renderCharts(series, top);
    }

    function renderCharts(series, top) {
      const lineEl = document.getElementById('salesLine');
      const donutEl = document.getElementById('topDoughnut');

      const labels = series.map(x => x.date.slice(5));
      const data = series.map(x => x.total);

      if (state.charts.line) state.charts.line.destroy();
      state.charts.line = new Chart(lineEl, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Omzet',
            data,
            borderColor: '#059669',
            backgroundColor: 'rgba(16,185,129,.15)',
            fill: true,
            tension: 0.35,
            pointRadius: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => rupiah(ctx.parsed.y) } }
          },
          scales: {
            y: {
              ticks: { callback: (v) => (v >= 1000000 ? (v/1000000)+'jt' : v >= 1000 ? (v/1000)+'rb' : v) }
            }
          }
        }
      });

      const labels2 = top.length ? top.map(x => x.name) : ['Belum ada penjualan'];
      const data2 = top.length ? top.map(x => x.qty) : [1];
      const colors = ['#10b981','#34d399','#a3e635','#f59e0b','#fb7185','#60a5fa','#a78bfa','#22c55e'];

      if (state.charts.donut) state.charts.donut.destroy();
      state.charts.donut = new Chart(donutEl, {
        type: 'doughnut',
        data: {
          labels: labels2,
          datasets: [{
            data: data2,
            backgroundColor: colors.slice(0, data2.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 10 } },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} qty` } }
          }
        }
      });
    }

    /**********************
     * Shipping admin
     **********************/
    const SHIPPING_STATUSES = [
      { value: 'pending', label: 'Pending', cls: 'bg-slate-100 text-slate-700' },
      { value: 'processing', label: 'Diproses', cls: 'bg-amber-100 text-amber-800' },
      { value: 'shipped', label: 'Dikirim', cls: 'bg-sky-100 text-sky-800' },
      { value: 'delivered', label: 'Selesai', cls: 'bg-emerald-100 text-emerald-800' },
      { value: 'canceled', label: 'Batal', cls: 'bg-rose-100 text-rose-800' }
    ];

    function getShippingMeta(status) {
      const s = String(status || 'pending');
      return SHIPPING_STATUSES.find(x => x.value === s) || SHIPPING_STATUSES[0];
    }

    function normalizeTxShipping(tx) {
      if (!tx) return tx;
      // Normalize optional buyer identity fields (for older data)
      if (!tx.buyerEmail) tx.buyerEmail = '';
      if (!tx.buyerWhatsApp) tx.buyerWhatsApp = '';
      if (!tx.buyerNote) tx.buyerNote = '';

      if (!tx.shipping || typeof tx.shipping !== 'object') {
        tx.shipping = { status: 'pending', updatedAt: '', updatedBy: '', fee: 0, billConfirmedAt: '', billConfirmedBy: '' };
      }
      if (!tx.shipping.status) tx.shipping.status = 'pending';
      if (tx.shipping.fee === undefined || tx.shipping.fee === null || isNaN(Number(tx.shipping.fee))) tx.shipping.fee = 0;
      if (!tx.shipping.billConfirmedAt) tx.shipping.billConfirmedAt = '';
      if (!tx.shipping.billConfirmedBy) tx.shipping.billConfirmedBy = '';
      return tx;
    }

    function getTxBillTotal(tx) {
      const base = Number(tx?.total || 0);
      const fee = Number(tx?.shipping?.fee || 0);
      return base + fee;
    }

    function setShippingStatusAndFee(txId, { status, fee }) {
      return cloudSyncWrite(() => {
        const txs = getTransactions();
        const tx = txs.find(t => t.id === txId);
        if (!tx) return;
        normalizeTxShipping(tx);
        if (status !== undefined) tx.shipping.status = String(status || 'pending');
        if (fee !== undefined) tx.shipping.fee = Math.max(0, Number(fee || 0));
        tx.shipping.updatedAt = new Date().toISOString();
        tx.shipping.updatedBy = currentUser()?.email || 'local';
        setTransactions(txs);
        toast('Pengiriman diperbarui.');
        rerenderAll();
        routeTo('admin.shipping');
      }, { reason: 'shippingUpdate' });
    }

    function buildWhatsAppBillMessage({ tx, shippingFee }) {
      const fee = Math.max(0, Number(shippingFee || 0));
      const totalItems = Number(tx?.total || 0);
      const bill = totalItems + fee;
      const items = Array.isArray(tx?.items) ? tx.items : [];

      // Payment info from Store Profile
      let profile = null;
      try { profile = getStoreProfile(); } catch {}
      const storeTitle = [profile?.storeName, profile?.tagline].filter(Boolean).join(' ') || 'Varsha Fruits and Goods';

      const payLines = [];
      if (profile?.bankName) payLines.push(`Bank: ${profile.bankName}`);
      if (profile?.bankAccount) payLines.push(`No Rek: ${profile.bankAccount}`);
      if (profile?.bankHolder) payLines.push(`A/N: ${profile.bankHolder}`);

      const lines = [];
      lines.push(`Konfirmasi Tagihan - ${storeTitle}`);
      if (tx?.id) lines.push(`ID: ${tx.id}`);
      if (tx?.buyerName) lines.push(`Nama: ${tx.buyerName}`);
      if (tx?.buyerEmail) lines.push(`Email: ${tx.buyerEmail}`);
      if (tx?.buyerWhatsApp) lines.push(`WA: ${tx.buyerWhatsApp}`);
      if (tx?.buyerAddress) lines.push(`Alamat: ${tx.buyerAddress}`);
      if (tx?.buyerNote) lines.push(`Catatan: ${tx.buyerNote}`);
      lines.push('');

      if (items.length) {
        lines.push('Rincian Item:');
        for (const it of items) {
          const qty = Number(it.qty || 0);
          const unit = Number(it.unitPrice || 0);
          const subtotal = Number(it.revenue || (qty * unit) || 0);
          lines.push(`- ${it.name} x${qty} @ ${rupiah(unit)} = ${rupiah(subtotal)}`);
        }
        lines.push('');
      }

      lines.push(`Subtotal belanja: ${rupiah(totalItems)}`);
      lines.push(`Biaya pengiriman: ${rupiah(fee)}`);
      lines.push(`Total tagihan: ${rupiah(bill)}`);

      if (payLines.length) {
        lines.push('');
        lines.push('Informasi Pembayaran:');
        payLines.forEach(l => lines.push(l));
      }

      lines.push('');
      lines.push('Silakan lakukan pembayaran sesuai total tagihan di atas. Terima kasih.');
      return lines.join('\n');
    }

    async function sendBillToCustomer(txId) {
      const txs = getTransactions();
      const tx = txs.find(t => t.id === txId);
      if (!tx) throw new Error('Transaksi tidak ditemukan.');
      normalizeTxShipping(tx);
      const wa = String(tx.buyerWhatsApp || '').trim();
      if (!wa) throw new Error('Nomor WhatsApp customer belum ada di transaksi.');

      const msisdn = toWhatsAppMsisdn(wa);
      if (!msisdn) throw new Error('Nomor WhatsApp customer tidak valid.');

      // Build final message first (so the opened WA always contains full details)
      const msg = buildWhatsAppBillMessage({ tx, shippingFee: tx.shipping.fee });
      const finalUrl = `https://wa.me/${msisdn}?text=${encodeURIComponent(msg)}`;

      // Open WA immediately (avoid popup blocker)
      let win = null;
      try { win = window.open(finalUrl, '_blank', 'noopener'); } catch {}

      // Record confirmation in data (and push to cloud)
      await cloudSyncWrite(() => {
        const txs2 = getTransactions();
        const tx2 = txs2.find(t => t.id === txId);
        if (!tx2) return;
        normalizeTxShipping(tx2);
        tx2.shipping.billConfirmedAt = new Date().toISOString();
        tx2.shipping.billConfirmedBy = currentUser()?.email || 'local';
        setTransactions(txs2);
      }, { reason: 'billConfirm' });

      // Fallback if popup blocked
      try {
        if (!win) window.open(finalUrl, '_blank', 'noopener');
      } catch {}

      toast('Konfirmasi tagihan dikirim (WA).');
      rerenderAll();
      routeTo('admin.shipping');
    }

    function filterShippingList(txs) {
      const q = String(state.shipSearch || '').trim().toLowerCase();
      const st = String(state.shipStatus || '').trim();
      let list = txs.slice();
      for (const tx of list) normalizeTxShipping(tx);
      if (st) list = list.filter(tx => (tx.shipping?.status || 'pending') === st);
      if (q) {
        list = list.filter(tx => {
          const hay = [
            tx.id,
            tx.buyerName,
            tx.buyerEmail,
            tx.buyerWhatsApp,
            tx.buyerAddress,
            tx.buyerNote
          ].filter(Boolean).join(' ').toLowerCase();
          return hay.includes(q);
        });
      }
      return list;
    }

    function renderShipping() {
      const txs = getTransactions();
      const list = filterShippingList(txs);

      const body = document.getElementById('shipBody');
      const empty = document.getElementById('shipEmpty');
      if (!body || !empty) return;

      body.innerHTML = '';
      empty.classList.toggle('hidden', list.length !== 0);

      if (list.length === 0 && txs.length > 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="9">Tidak ada order yang cocok dengan filter.</td>`;
        body.appendChild(tr);
        return;
      }

      for (const tx of list) {
        normalizeTxShipping(tx);
        const meta = getShippingMeta(tx.shipping?.status);
        const updatedText = tx.shipping?.updatedAt ? ` ‚Ä¢ ${new Date(tx.shipping.updatedAt).toLocaleString('id-ID')}` : '';

        const fee = Number(tx.shipping?.fee || 0);
        const bill = getTxBillTotal(tx);
        const billConfirmedAt = tx.shipping?.billConfirmedAt ? new Date(tx.shipping.billConfirmedAt).toLocaleString('id-ID') : '';

        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0 align-top';
        tr.innerHTML = `
          <td class="py-3 font-semibold whitespace-nowrap">${tx.id}</td>
          <td class="py-3 whitespace-nowrap">${new Date(tx.date).toLocaleString('id-ID')}</td>
          <td class="py-3">
            <div class="font-semibold">${tx.buyerName || '-'}</div>
            ${tx.buyerWhatsApp ? `<div class="text-xs text-slate-600 font-mono">${tx.buyerWhatsApp}</div>` : ''}
            ${tx.buyerNote ? `<div class="mt-1 text-xs text-slate-500 italic">Catatan: ${tx.buyerNote}</div>` : ''}
          </td>
          <td class="py-3">
            <div class="text-xs text-slate-600 max-w-[420px]">${tx.buyerAddress || ''}</div>
          </td>
          <td class="py-3 whitespace-nowrap">${rupiah(tx.total || 0)}</td>
          <td class="py-3 whitespace-nowrap">
            <input type="number" min="0" step="100" class="ship-fee no-spin w-28 rounded-xl border bg-white px-2 py-1.5 text-xs" data-id="${tx.id}" value="${fee}" />
            <div class="mt-1 text-[11px] text-slate-500">Rp (manual)</div>
          </td>
          <td class="py-3 whitespace-nowrap">
            <div class="font-extrabold">${rupiah(bill)}</div>
            ${billConfirmedAt ? `<div class="mt-1 text-[11px] text-emerald-700 font-semibold">WA terkirim: ${billConfirmedAt}</div>` : `<div class="mt-1 text-[11px] text-slate-500">Belum konfirmasi</div>`}
          </td>
          <td class="py-3">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-bold ${meta.cls}">${meta.label}</span>
            <div class="mt-1 text-[11px] text-slate-500">Update${updatedText}</div>
          </td>
          <td class="py-3 text-right">
            <div class="inline-flex flex-col items-end gap-2">
              <div class="inline-flex flex-col sm:flex-row gap-2">
                <select class="ship-set rounded-xl border bg-white px-2 py-1.5 text-xs" data-id="${tx.id}">
                  ${SHIPPING_STATUSES.map(s => `<option value="${s.value}" ${s.value === (tx.shipping?.status || 'pending') ? 'selected' : ''}>${s.label}</option>`).join('')}
                </select>
                <button class="ship-save rounded-xl bg-slate-900 px-3 py-1.5 text-xs font-extrabold text-white hover:bg-slate-800" data-id="${tx.id}">Simpan</button>
              </div>
              <button class="ship-bill rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-xs font-extrabold text-emerald-800 hover:bg-emerald-100" data-id="${tx.id}">Kirim Tagihan</button>
            </div>
          </td>
        `;
        body.appendChild(tr);
      }

      body.querySelectorAll('.ship-save').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const sel = body.querySelector(`.ship-set[data-id="${id}"]`);
          const feeEl = body.querySelector(`.ship-fee[data-id="${id}"]`);
          const status = sel?.value || 'pending';
          const fee = Number(feeEl?.value || 0);
          try {
            btn.disabled = true;
            btn.classList.add('opacity-60');
            await setShippingStatusAndFee(id, { status, fee });
          } catch (e) {
            console.warn(e);
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-60');
          }
        });
      });

      body.querySelectorAll('.ship-bill').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const feeEl = body.querySelector(`.ship-fee[data-id="${id}"]`);
          const fee = Number(feeEl?.value || 0);
          try {
            btn.disabled = true;
            btn.classList.add('opacity-60');
            // ensure fee saved before sending bill
            await setShippingStatusAndFee(id, { fee });
            await sendBillToCustomer(id);
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal kirim tagihan.');
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-60');
          }
        });
      });
    }

    function exportShippingReport() {
      const txs = getTransactions();
      const rows = txs.map(tx => {
        normalizeTxShipping(tx);
        const fee = Number(tx.shipping?.fee || 0);
        const bill = getTxBillTotal(tx);
        return {
          tx_id: tx.id,
          tx_date: new Date(tx.date).toLocaleString('id-ID'),
          buyer_name: tx.buyerName || '',
          buyer_email: tx.buyerEmail || '',
          buyer_whatsapp: tx.buyerWhatsApp || '',
          buyer_address: tx.buyerAddress || '',
          total_items: tx.total || 0,
          shipping_fee: fee,
          bill_total: bill,
          shipping_status: tx.shipping?.status || 'pending',
          shipping_updated_at: tx.shipping?.updatedAt || '',
          shipping_updated_by: tx.shipping?.updatedBy || '',
          bill_confirmed_at: tx.shipping?.billConfirmedAt || '',
          bill_confirmed_by: tx.shipping?.billConfirmedBy || ''
        };
      });
      const csv = toCSV(rows.length ? rows : [{ note: 'Tidak ada data pengiriman.' }]);
      downloadText(`Varsha_Laporan_Pengiriman_${toISODate(new Date())}.csv`, csv);
    }

    /**********************
     * Customer: Shipping Status
     **********************/
    function renderCustomerShipping() {
      const u = currentUser();
      const loginHint = document.getElementById('custShipLoginHint');
      const main = document.getElementById('custShipMain');
      const body = document.getElementById('custShipBody');
      const empty = document.getElementById('custShipEmpty');

      if (!loginHint || !main || !body || !empty) return;

      if (!u) {
        loginHint.classList.remove('hidden');
        main.classList.add('hidden');
        return;
      }

      loginHint.classList.add('hidden');
      main.classList.remove('hidden');

      const userEmail = String(u.email || '').trim().toLowerCase();
      if (!userEmail) {
        body.innerHTML = '';
        empty.classList.remove('hidden');
        empty.innerHTML = `
          <div class="font-semibold">Email akun belum tersedia</div>
          <div class="text-sm text-slate-500 mt-1">Status pengiriman ditampilkan berdasarkan email akun. Silakan login ulang.</div>
        `;
        return;
      }

      const q = String(state.custShipSearch || '').trim().toLowerCase();
      const st = String(state.custShipStatus || '').trim();

      let list = getTransactions().slice();
      list.forEach(normalizeTxShipping);
      list = list.filter(tx => String(tx.buyerEmail || '').trim().toLowerCase() === userEmail);
      if (st) list = list.filter(tx => (tx.shipping?.status || 'pending') === st);
      if (q) list = list.filter(tx => String(tx.id || '').toLowerCase().includes(q));

      body.innerHTML = '';
      empty.classList.toggle('hidden', list.length !== 0);

      if (list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="7">Tidak ada order yang cocok.</td>`;
        body.appendChild(tr);
        return;
      }

      for (const tx of list) {
        const meta = getShippingMeta(tx.shipping?.status);
        const fee = Number(tx.shipping?.fee || 0);
        const bill = getTxBillTotal(tx);
        const upd = tx.shipping?.updatedAt ? new Date(tx.shipping.updatedAt).toLocaleString('id-ID') : '-';

        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0 align-top';
        tr.innerHTML = `
          <td class="py-3 font-semibold whitespace-nowrap">${tx.id}</td>
          <td class="py-3 whitespace-nowrap">${new Date(tx.date).toLocaleString('id-ID')}</td>
          <td class="py-3 whitespace-nowrap">${rupiah(tx.total || 0)}</td>
          <td class="py-3 whitespace-nowrap">${rupiah(fee)}</td>
          <td class="py-3 whitespace-nowrap font-extrabold">${rupiah(bill)}</td>
          <td class="py-3"><span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-bold ${meta.cls}">${meta.label}</span></td>
          <td class="py-3 text-xs text-slate-500">${upd}</td>
        `;
        body.appendChild(tr);
      }
    }

    /**********************
     * Transactions admin
     **********************/
    function renderTransactions() {
      const txs = getTransactions();
      const q = state.txSearch.trim().toLowerCase();
      const from = state.txRange.from;
      const to = state.txRange.to;

      let list = txs.filter(tx => txInRange(tx, from, to));
      if (q) {
        list = list.filter(tx => {
          const hit = (tx.id || '').toLowerCase().includes(q) || (tx.buyerName || '').toLowerCase().includes(q);
          const hitItem = (tx.items || []).some(it => (it.name || '').toLowerCase().includes(q));
          return hit || hitItem;
        });
      }

      const body = document.getElementById('txBody');
      body.innerHTML = '';
      document.getElementById('txEmpty').classList.toggle('hidden', list.length !== 0);

      for (const tx of list) {
        normalizeTxShipping(tx);
        const detail = (tx.items || []).map(it => `${it.name} x${it.qty} @${rupiah(it.unitPrice)}${it.discountPct ? ` (-${it.discountPct}%)` : ''}`).join(' ‚Ä¢ ');
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="py-3 font-semibold">${tx.id}</td>
          <td class="py-3">${new Date(tx.date).toLocaleString('id-ID')}</td>
          <td class="py-3">
            <div class="font-semibold">${tx.buyerName || '-'}</div>
            ${tx.buyerEmail ? `<div class="text-xs text-slate-600">${tx.buyerEmail}</div>` : ''}
            ${tx.buyerWhatsApp ? `<div class="text-xs text-slate-600 font-mono">${tx.buyerWhatsApp}</div>` : ''}
            <div class="text-xs text-slate-500 truncate max-w-[360px]">${tx.buyerAddress || ''}</div>
            ${tx.buyerNote ? `<div class="mt-1 text-xs text-slate-500 italic truncate max-w-[360px]">Catatan: ${tx.buyerNote}</div>` : ''}
          </td>
          <td class="py-3">${rupiah(tx.total)}</td>
          <td class="py-3">${rupiah(tx.profit)}</td>
          <td class="py-3">
            <div class="text-xs text-slate-600 max-w-[520px]">${detail}</div>
          </td>
        `;
        body.appendChild(tr);
      }

      if (list.length === 0 && txs.length > 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-6 text-center text-slate-500" colspan="6">Tidak ada transaksi yang cocok dengan filter.</td>`;
        body.appendChild(tr);
      }
    }

    /**********************
     * Reports
     **********************/
    function exportSalesReport() {
      const txs = getTransactions();
      const rows = [];
      for (const tx of txs) {
        normalizeTxShipping(tx);
        const shippingFee = Number(tx.shipping?.fee || 0);
        const billTotal = getTxBillTotal(tx);
        const billConfirmedAt = tx.shipping?.billConfirmedAt || '';

        for (const it of (tx.items || [])) {
          rows.push({
            tx_id: tx.id,
            tx_date: new Date(tx.date).toLocaleString('id-ID'),
            buyer_name: tx.buyerName,
            buyer_email: tx.buyerEmail || '',
            buyer_whatsapp: tx.buyerWhatsApp || '',
            buyer_address: tx.buyerAddress,
            buyer_note: tx.buyerNote || '',
            shipping_fee: shippingFee,
            bill_total: billTotal,
            bill_confirmed_at: billConfirmedAt,
            product: it.name,
            qty: it.qty,
            unit_price: it.unitPrice,
            discount_pct: it.discountPct,
            unit_buy: it.unitBuy,
            revenue: it.revenue,
            cost: it.cost,
            profit_item: Number(it.revenue || 0) - Number(it.cost || 0)
          });
        }
      }
      const csv = toCSV(rows.length ? rows : [{ note: 'Tidak ada data penjualan.' }]);
      downloadText(`Varsha_Laporan_Penjualan_${toISODate(new Date())}.csv`, csv);
    }

    function exportPurchasesReport() {
      const purchases = getPurchases();
      const rows = purchases.map(p => ({
        purchase_id: p.id,
        date: new Date(p.date).toLocaleString('id-ID'),
        product_id: p.productId,
        product: p.productName,
        qty: p.qty,
        buy_price: p.buyPrice,
        sell_price_updated: p.sellPrice ?? ''
      }));
      const csv = toCSV(rows.length ? rows : [{ note: 'Tidak ada data pembelian.' }]);
      downloadText(`Varsha_Laporan_Pembelian_${toISODate(new Date())}.csv`, csv);
    }

    function exportStockReport() {
      const products = getProducts();
      const rows = products.map(p => {
        const promoOn = isPromoScheduledActive(p.promo);
        const ep = effectivePrice(p);
        return {
          product_id: p.id,
          name: p.name,
          category: p.category,
          stock: p.stock,
          buy_price: p.priceBuy,
          sell_price: p.priceSell,
          promo_active: p.promo?.active ? 'yes' : 'no',
          promo_discount_pct: p.promo?.discountPct || 0,
          promo_start: p.promo?.start || '',
          promo_end: p.promo?.end || '',
          promo_effective_now: promoOn ? 'yes' : 'no',
          effective_price_now: ep.price
        };
      });
      const csv = toCSV(rows);
      downloadText(`Varsha_Laporan_Stok_${toISODate(new Date())}.csv`, csv);
    }

    function exportAllData() {
      const payload = {
        app: 'Varsha Fruits and Goods',
        version: 1,
        exportedAt: new Date().toISOString(),
        data: {
          products: getProducts(),
          transactions: getTransactions(),
          purchases: getPurchases(),
          cart: getCart()
        }
      };
      downloadText(`Varsha_Backup_${toISODate(new Date())}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
    }

    async function importAllDataFromFile(file) {
      const text = await file.text();
      let parsed;
      try {
        parsed = JSON.parse(text);
      } catch {
        toast('File JSON tidak valid.');
        return;
      }

      const data = parsed?.data || parsed; // allow plain object
      if (!data || typeof data !== 'object') {
        toast('Format backup tidak dikenali.');
        return;
      }

      // minimal validation
      const products = Array.isArray(data.products) ? data.products : null;
      const transactions = Array.isArray(data.transactions) ? data.transactions : null;
      const purchases = Array.isArray(data.purchases) ? data.purchases : null;
      const cart = Array.isArray(data.cart) ? data.cart : [];

      if (!products || !transactions || !purchases) {
        toast('Backup harus berisi products, transactions, purchases.');
        return;
      }

      save(LS.products, products);
      save(LS.transactions, transactions);
      save(LS.purchases, purchases);
      save(LS.cart, cart);

      toast('Import berhasil. Data diperbarui.');
      rerenderAll();
      routeTo(state.route);
    }

    function renderReports() {
      // Cloud Sync UI moved to header modal; here we only keep header status up to date
      const enabled = !!load(LS.cloudEnabled, false);
      const hasCfg = !!String(load(LS.cloudConfig, '') || '').trim();
      const hasShop = !!String(load(LS.cloudShopId, '') || '').trim();

      // populate webhook settings
      const whUrlEl = document.getElementById('orderWebhookUrl');
      const whEnEl = document.getElementById('orderWebhookEnabled');
      if (whUrlEl && !whUrlEl.value) whUrlEl.value = load(LS.orderWebhookUrl, '') || '';
      if (whEnEl) whEnEl.checked = !!load(LS.orderWebhookEnabled, false);
      updateOrderWebhookStatusUI();

      // If already connected, keep the live status (do not overwrite to Ready)
      if (!cloud.connected) updateCloudStatusUI((enabled || (hasCfg && hasShop)) ? 'Ready (saved config)' : 'Offline');
    }

    /**********************
     * Order Webhook (Alternative to Firebase)
     **********************/
    function getOrderWebhookSettings() {
      return {
        enabled: !!load(LS.orderWebhookEnabled, false),
        url: String(load(LS.orderWebhookUrl, '') || '').trim()
      };
    }

    function updateOrderWebhookStatusUI(textOverride = '') {
      const el = document.getElementById('orderWebhookStatus');
      if (!el) return;
      if (textOverride) {
        el.innerHTML = `Status: <span class="font-semibold">${textOverride}</span>`;
        return;
      }
      const s = getOrderWebhookSettings();
      if (!s.enabled) {
        el.innerHTML = `Status: <span class="font-semibold">Nonaktif</span>`;
        return;
      }
      if (!s.url) {
        el.innerHTML = `Status: <span class="font-semibold">Aktif (URL kosong)</span>`;
        return;
      }
      el.innerHTML = `Status: <span class="font-semibold">Aktif</span> ‚Ä¢ <span class="font-mono break-all">${s.url}</span>`;
    }

    async function postJsonWithTimeout(url, payload, { timeoutMs = 8000 } = {}) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal,
          mode: 'cors'
        });
        const text = await res.text().catch(() => '');
        if (!res.ok) {
          throw new Error(`Webhook HTTP ${res.status} ${res.statusText}${text ? ' | ' + text.slice(0, 300) : ''}`);
        }
        return { ok: true, status: res.status, text };
      } finally {
        clearTimeout(t);
      }
    }

    function buildWebhookPayload(event, tx = null) {
      const shopId = String(load(LS.cloudShopId, '') || '').trim() || 'varsha-shop-01';
      return {
        event,
        shopId,
        deviceId: getOrCreateDeviceId(),
        sentAt: new Date().toISOString(),
        tx
      };
    }

    async function sendOrderWebhook(tx) {
      const s = getOrderWebhookSettings();
      if (!s.enabled) return;
      if (!s.url) {
        updateOrderWebhookStatusUI('Aktif (URL kosong)');
        return;
      }

      const payload = buildWebhookPayload('order.created', tx);
      try {
        updateOrderWebhookStatusUI('Mengirim...');
        await postJsonWithTimeout(s.url, payload, { timeoutMs: 9000 });
        updateOrderWebhookStatusUI('Terkirim');
        // bring it back to active view after a moment
        setTimeout(() => updateOrderWebhookStatusUI(), 1200);
      } catch (e) {
        console.warn('Order webhook failed', e);
        updateOrderWebhookStatusUI('Gagal kirim');
        setTimeout(() => updateOrderWebhookStatusUI(), 1800);
      }
    }

    async function testOrderWebhook() {
      const s = getOrderWebhookSettings();
      if (!s.url) throw new Error('Webhook URL masih kosong.');
      const payload = buildWebhookPayload('ping', null);
      return postJsonWithTimeout(s.url, payload, { timeoutMs: 9000 });
    }

    /**********************
     * Cloud Sync (Firebase)
     **********************/
    const cloud = {
      app: null,
      db: null,
      auth: null,
      storage: null,
      projectId: '',
      shopId: '',
      rawBucket: '',
      bucket: '',
      bucketCandidates: [],
      unsub: null,
      connected: false,
      applyingRemote: false,
      lastRemoteRev: null,
      lastLocalPushedHash: null
    };

    // Sync helpers: serialize pull/push to avoid race conditions
    const cloudSync = {
      chain: Promise.resolve(),
      lastAutoPullAt: 0,
      autoPullCooldownMs: 4000,
      suppressAutoPullUntil: 0
    };

    function cloudRunExclusive(fn) {
      cloudSync.chain = cloudSync.chain.then(fn, fn);
      return cloudSync.chain;
    }

    async function cloudEnsureConnected({ silent = true, forceConnect = false } = {}) {
      const cfgText = String(load(LS.cloudConfig, '') || '').trim();
      const shopId = String(load(LS.cloudShopId, '') || '').trim();
      if (!cfgText || !shopId) return { ok: false, reason: 'no_config', shopId: '' };

      // Per request: jika config + Shop ID sudah tersimpan, Cloud Sync dianggap aktif
      // (jadi tidak perlu menekan tombol Connect setiap kali).
      save(LS.cloudEnabled, true);

      if (cloud.connected) return { ok: true, shopId };
      try {
        await cloudConnect({ configText: cfgText, shopId });
        if (!silent) toast('Cloud sync tersambung.');
        hideCloudError();
        return { ok: true, shopId };
      } catch (e) {
        console.warn('Auto-connect failed', e);
        updateCloudStatusUI('Offline (auto-connect gagal)');
        showCloudError(e);
        return { ok: false, reason: 'connect_failed', shopId };
      }
    }

    async function cloudAutoPullIfNeeded(reason = '') {
      const now = Date.now();
      if (now < cloudSync.suppressAutoPullUntil) return;
      if (now - cloudSync.lastAutoPullAt < cloudSync.autoPullCooldownMs) return;

      cloudSync.lastAutoPullAt = now;
      return cloudRunExclusive(async () => {
        const c = await cloudEnsureConnected({ silent: true });
        if (!c.ok || !c.shopId) return;

        try {
          const res = await cloudPull(c.shopId, { silent: true, noRoute: true, noToastEmpty: true });
          // If cloud is empty (first device), push local snapshot as baseline
          if (res?.empty) {
            await cloudPush(c.shopId, { silent: true });
          }
        } catch (e) {
          console.warn('Auto-pull failed', reason, e);
          showCloudError(e);
        }
      });
    }

    async function cloudSyncWrite(actionFn, { reason = 'write' } = {}) {
      // Pull -> apply local change -> push
      return cloudRunExclusive(async () => {
        // Always attempt connect automatically (if config + Shop ID already saved)
        const c = await cloudEnsureConnected({ silent: true, forceConnect: true });
        if (!c.ok || !c.shopId) {
          // no cloud config, just run locally
          return actionFn();
        }

        // Prevent immediate auto-pull caused by routeTo() after this write
        cloudSync.suppressAutoPullUntil = Date.now() + 2500;

        // Pause auto-push debounce to avoid double pushes
        if (typeof cloudAuto !== 'undefined') cloudAuto.disabled = (cloudAuto.disabled || 0) + 1;

        try {
          // Always pull latest first (per request)
          try {
            const res = await cloudPull(c.shopId, { silent: true, noRoute: true, noToastEmpty: true });
            if (res?.empty) {
              // If cloud empty, push current local baseline first
              await cloudPush(c.shopId, { silent: true });
            }
          } catch (e) {
            console.warn('Pre-write pull failed', reason, e);
            // Continue with local write anyway
          }

          // Apply local write
          const out = await actionFn();

          // Push latest snapshot
          try {
            await cloudPush(c.shopId, { silent: true });
          } catch (e) {
            console.warn('Post-write push failed', reason, e);
            toast('Gagal push ke cloud. Cek koneksi/rules.');
            showCloudError(e);
          }

          return out;
        } finally {
          if (typeof cloudAuto !== 'undefined') cloudAuto.disabled = Math.max(0, (cloudAuto.disabled || 0) - 1);
        }
      });
    }

    function buildBucketCandidates(config) {
      const pid = String(config?.projectId || '').trim();
      const raw = String(config?.storageBucket || '').trim();
      const out = [];
      const push = (v) => {
        const s = String(v || '').trim();
        if (!s) return;
        if (!out.includes(s)) out.push(s);
      };

      const appspot = pid ? `${pid}.appspot.com` : '';
      const fireDomain = pid ? `${pid}.firebasestorage.app` : '';

      // Priority: if raw ends with .firebasestorage.app, try classic appspot first (most common gs:// bucket)
      if (raw && raw.endsWith('.firebasestorage.app')) {
        push(appspot);
        push(raw);
      } else {
        push(raw);
        push(appspot);
      }
      push(fireDomain);
      return out.filter(Boolean);
    }

    function cloudStorageRef(path, bucketOverride = '') {
      if (!cloud.storage) throw new Error('Storage belum siap');
      const bucket = String(bucketOverride || cloud.bucket || '').trim();
      // Prefer refFromURL so we can explicitly target the right bucket.
      if (bucket) return cloud.storage.refFromURL(`gs://${bucket}/${path}`);
      return cloud.storage.ref().child(path);
    }

    function awaitPutTask(task, { timeoutMs = 12000, onProgress } = {}) {
      return new Promise((resolve, reject) => {
        let lastAt = Date.now();
        let lastTransferred = 0;

        const watchdog = setInterval(() => {
          if (Date.now() - lastAt > timeoutMs) {
            clearInterval(watchdog);
            try { task.cancel(); } catch {}
            reject(new Error('Upload macet (tidak ada progress).'));
          }
        }, 1200);

        task.on('state_changed',
          (snap) => {
            if (typeof onProgress === 'function') onProgress(snap);
            if (snap.bytesTransferred !== lastTransferred) {
              lastTransferred = snap.bytesTransferred;
              lastAt = Date.now();
            }
          },
          (err) => {
            clearInterval(watchdog);
            reject(err);
          },
          () => {
            clearInterval(watchdog);
            resolve(task.snapshot);
          }
        );
      });
    }

    function guessExtFromFile(file) {
      const name = String(file?.name || '').toLowerCase();
      const m = name.match(/\.([a-z0-9]{2,5})$/);
      if (m) return m[1];
      const type = String(file?.type || '').toLowerCase();
      if (type.includes('png')) return 'png';
      if (type.includes('webp')) return 'webp';
      if (type.includes('jpg') || type.includes('jpeg')) return 'jpg';
      return 'jpg';
    }

    async function cloudPickWorkingBucket(shopId, { timeoutMs = 9000 } = {}) {
      const sid = (shopId || load(LS.cloudShopId, '') || '').trim();
      if (!sid) throw new Error('Shop ID harus diisi.');
      if (!cloud.connected) throw new Error('Belum connect Cloud Sync.');

      // Ensure auth
      if (!cloud.auth?.currentUser) {
        await cloud.auth.signInAnonymously();
      }
      try { await cloud.auth.currentUser.getIdToken(true); } catch {}

      const candidates = Array.isArray(cloud.bucketCandidates) && cloud.bucketCandidates.length
        ? cloud.bucketCandidates.slice()
        : (cloud.projectId ? [cloud.rawBucket, `${cloud.projectId}.appspot.com`, `${cloud.projectId}.firebasestorage.app`] : [cloud.rawBucket]).filter(Boolean);

      // If cloud.bucket is set, try it first
      const ordered = [];
      const push = (b) => {
        const s = String(b || '').trim();
        if (!s) return;
        if (!ordered.includes(s)) ordered.push(s);
      };
      push(cloud.bucket);
      candidates.forEach(push);

      const deviceId = getOrCreateDeviceId();
      const filename = `bucket_probe_${Date.now()}_${deviceId}.txt`;
      const storagePath = `varsha_shops/${sid}/product_images/${filename}`;
      const blob = new Blob([new TextEncoder().encode('ok')], { type: 'text/plain' });

      const errors = [];
      for (const b of ordered) {
        try {
          const ref = cloudStorageRef(storagePath, b);
          const task = ref.put(blob, { contentType: 'text/plain', cacheControl: 'no-cache' });
          await awaitPutTask(task, { timeoutMs });
          // cleanup (best effort)
          try { await ref.delete(); } catch {}

          cloud.bucket = b;
          return { bucket: b, storagePath };
        } catch (e) {
          errors.push({ bucket: b, err: e });
        }
      }

      const summary = errors.map(x => `${x.bucket}: ${String(x.err?.code || x.err?.message || x.err)}`).join(' || ');
      throw new Error('Tidak bisa upload ke Firebase Storage di semua kandidat bucket. ' + (summary ? ('Detail: ' + summary) : ''));
    }

    async function uploadProductImageToCloud({ file, productId }) {
      const enabled = !!load(LS.cloudEnabled, false);
      const shopId = load(LS.cloudShopId, '');
      if (!enabled || !cloud.connected) throw new Error('Cloud Sync belum tersambung. Connect dulu di menu Laporan.');
      if (!shopId) throw new Error('Shop ID belum diisi.');
      if (!file) throw new Error('Pilih file gambar dulu.');
      if (!file.type?.startsWith('image/')) throw new Error('File harus gambar (image/*).');

      // Ensure auth session exists for Storage rules that require authenticated users
      if (!cloud.auth?.currentUser) {
        await cloud.auth.signInAnonymously();
      }
      try {
        // Force token refresh (helps on some browsers where Storage upload hangs until token exists)
        await cloud.auth.currentUser.getIdToken(true);
      } catch {}

      const maxMb = 3.5;
      if (file.size > maxMb * 1024 * 1024) throw new Error(`Ukuran file terlalu besar. Maks ${maxMb} MB.`);

      // pick a working bucket first (helps with macet 0%)
      if (!cloud.bucket) {
        await cloudPickWorkingBucket(shopId, { timeoutMs: 9000 });
      }

      const deviceId = getOrCreateDeviceId();
      const ext = guessExtFromFile(file);
      const safeProductId = (productId || uid('PRD')).replaceAll('/', '_');
      const filename = `${safeProductId}_${Date.now()}_${deviceId}.${ext}`;
      const storagePath = `varsha_shops/${shopId}/product_images/${filename}`;

      const meta = {
        contentType: file.type || 'image/jpeg',
        cacheControl: 'public,max-age=31536000'
      };

      const wrap = document.getElementById('uploadProgressWrap');
      const bar = document.getElementById('uploadProgressBar');
      const txt = document.getElementById('uploadProgressText');
      if (wrap) wrap.classList.remove('hidden');
      if (bar) bar.style.width = '0%';
      if (txt) txt.textContent = '0%';

      const ref = cloudStorageRef(storagePath);
      const task = ref.put(file, meta);

      await awaitPutTask(task, {
        timeoutMs: 15000,
        onProgress: (snap) => {
          const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
          if (bar) bar.style.width = pct + '%';
          if (txt) txt.textContent = pct + '%';
        }
      });

      const url = await task.snapshot.ref.getDownloadURL();
      return { url, storagePath, bucket: cloud.bucket };
    }

    async function cloudTestStorage(shopId) {
      if (!cloud.connected) throw new Error('Belum connect Cloud Sync.');
      const sid = (shopId || load(LS.cloudShopId, '') || '').trim();
      if (!sid) throw new Error('Shop ID harus diisi.');

      const res = await cloudPickWorkingBucket(sid, { timeoutMs: 9000 });
      return { ok: true, ...res };
    }

    function updateProductImagePreview(url) {
      const img = document.getElementById('productImagePreview');
      const fallback = 'https://images.unsplash.com/photo-1541976590-713941681591?auto=format&fit=crop&w=200&q=60';
      if (!img) return;
      img.src = url || fallback;
    }

    function getOrCreateDeviceId() {
      let id = load(LS.deviceId, '');
      if (!id) {
        id = uid('DEV');
        save(LS.deviceId, id);
      }
      return id;
    }

    function stableStringify(obj) {
      const seen = new WeakSet();
      const sorter = (a, b) => (a < b ? -1 : a > b ? 1 : 0);
      return JSON.stringify(obj, function (k, v) {
        if (v && typeof v === 'object') {
          if (seen.has(v)) return;
          seen.add(v);
          if (Array.isArray(v)) return v;
          const out = {};
          for (const key of Object.keys(v).sort(sorter)) out[key] = v[key];
          return out;
        }
        return v;
      });
    }

    function hashString(s) {
      // simple non-crypto hash
      let h = 2166136261;
      for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0).toString(16);
    }

    function snapshotData() {
      return {
        products: getProducts(),
        transactions: getTransactions(),
        purchases: getPurchases(),
        cart: getCart(),
        hero: load(LS.hero, DEFAULT_HERO),
        profile: load(LS.profile, DEFAULT_PROFILE)
      };
    }

    function applySnapshotToLocal(data) {
      if (!data) return;
      save(LS.products, Array.isArray(data.products) ? data.products : []);
      save(LS.transactions, Array.isArray(data.transactions) ? data.transactions : []);
      save(LS.purchases, Array.isArray(data.purchases) ? data.purchases : []);
      save(LS.cart, Array.isArray(data.cart) ? data.cart : []);
      // Optional settings synced via Cloud
      if (data.hero && typeof data.hero === 'object') save(LS.hero, data.hero);
      if (data.profile && typeof data.profile === 'object') save(LS.profile, data.profile);

      // Apply to UI (header, auth modal, etc)
      try { applyStoreProfileToUI(); } catch {}
      try { applyHeroToMarketplace(); } catch {}
    }

    function getLastSeenTxId() {
      return load(LS.lastSeenTxId, '') || '';
    }
    function setLastSeenTxId(id) {
      save(LS.lastSeenTxId, id || '');
    }

    function maybeNotifyNewOrder(remoteData) {
      // only relevant if remote has transactions
      const txs = remoteData?.transactions;
      if (!Array.isArray(txs) || txs.length === 0) return;
      const newest = txs[0];
      if (!newest?.id) return;

      const lastSeen = getLastSeenTxId();
      if (!lastSeen) {
        // first time: set baseline without notifying
        setLastSeenTxId(newest.id);
        return;
      }
      if (newest.id === lastSeen) return;

      // mark seen (so we won't spam)
      setLastSeenTxId(newest.id);

      const buyer = newest.buyerName ? ` ‚Ä¢ ${newest.buyerName}` : '';
      toast(`Order baru masuk${buyer} ‚Ä¢ ${rupiah(newest.total || 0)}`);

      // if admin is viewing, refresh relevant views
      if (String(state.route || '').startsWith('admin.')) {
        rerenderAll();
      }
    }

    function hideCloudError() {
      const wrap = document.getElementById('cloudErrorWrap');
      if (wrap) wrap.classList.add('hidden');
    }

    function showCloudError(err) {
      const wrap = document.getElementById('cloudErrorWrap');
      const textEl = document.getElementById('cloudErrorText');
      const hintsEl = document.getElementById('cloudErrorHints');
      if (!wrap || !textEl || !hintsEl) return;

      const info = explainFirebaseError(err);
      textEl.textContent = info.raw;
      hintsEl.innerHTML = info.hintsHtml;
      wrap.classList.remove('hidden');
    }

    function explainFirebaseError(err) {
      const code = String(err?.code || '').trim();
      const msg = String(err?.message || err || '').trim();
      const raw = [code, msg].filter(Boolean).join(' | ') || 'Unknown error';
      const lc = raw.toLowerCase();

      const hints = [];

      // common: auth domain not authorized / restricted
      if (lc.includes('auth/unauthorized-domain') || lc.includes('unauthorized domain') || lc.includes('not authorized')) {
        hints.push(
          `<b>Penyebab paling umum:</b> domain website belum ditambahkan ke <b>Firebase Authorized domains</b>.` +
          `<br>Perbaikan: Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí tambahkan <span class="font-mono">${window.location.host || 'USERNAME.github.io'}</span>.`
        );
      }

      if (
        (lc.includes('api key') && lc.includes('restricted')) ||
        lc.includes('key is restricted') ||
        (lc.includes('requests') && lc.includes('referer') && (lc.includes('blocked') || lc.includes('not allowed'))) ||
        (lc.includes('referer') && lc.includes('blocked'))
      ) {
        hints.push(
          `<b>API key restricted:</b> API Key kamu dibatasi (Application restrictions / API restrictions) sehingga request Firebase ditolak.` +
          `<br>Perbaikan: Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials ‚Üí API key ‚Üí set <b>Application restrictions</b> ke <b>None</b> atau tambahkan domain kamu ke <b>HTTP referrers</b> (contoh: <span class="font-mono">${window.location.host || 'USERNAME.github.io'}</span>).`
        );
      }

      if (lc.includes('permission-denied') || lc.includes('missing or insufficient permissions')) {
        hints.push(
          `<b>Firestore rules menolak akses:</b> akses ke Firestore ditolak oleh Rules.` +
          `<br>Perbaikan: Firebase Console ‚Üí Firestore Database ‚Üí Rules. Untuk demo, pakai contoh rules di menu <b>Laporan ‚Üí Deploy ke GitHub Pages</b> (tombol Copy).`
        );
      }

      if (lc.includes('storage/unauthorized') || lc.includes('storage/unauthenticated')) {
        hints.push(
          `<b>Storage rules menolak upload:</b> pastikan Storage Rules mengizinkan <b>write</b> untuk user authenticated.` +
          `<br>Lihat contoh Storage rules di bagian Deploy (menu Laporan).`
        );
      }

      if (lc.includes('storage') && (lc.includes('not found') || lc.includes('404'))) {
        hints.push(
          `<b>Firebase Storage belum aktif / bucket tidak ditemukan:</b> buka Firebase Console ‚Üí <b>Storage</b> ‚Üí lakukan setup (Get started).` +
          `<br>Pastikan bucket benar (umumnya <span class="font-mono">PROJECT_ID.appspot.com</span>).`
        );
      }

      if (lc.includes('upload') && lc.includes('macet')) {
        hints.push(
          `<b>Upload stuck 0% / Test Storage macet:</b> biasanya karena salah satu ini:` +
          `<br>1) Storage belum diaktifkan (Firebase Console ‚Üí Storage ‚Üí Get started),` +
          `<br>2) Storage Rules menolak write (butuh request.auth != null),` +
          `<br>3) Bucket salah. Untuk gs:// biasanya bucket yang benar adalah <span class="font-mono">PROJECT_ID.appspot.com</span> (bukan <span class="font-mono">*.firebasestorage.app</span>).` +
          `<br>Catatan: aplikasi ini akan mencoba beberapa kandidat bucket otomatis saat upload/test.`
        );
      }

      if (lc.includes('bucket') && (lc.includes('invalid') || lc.includes('does not exist'))) {
        hints.push(
          `<b>Bucket Storage bermasalah:</b> pastikan field <b>storageBucket</b> di firebaseConfig benar.` +
          `<br>Untuk Firebase umumnya: <span class="font-mono">${DEFAULT_FIREBASE_CONFIG.projectId}.appspot.com</span>.`
        );
      }

      if (window.location.protocol === 'file:') {
        hints.push(
          `<b>Kamu membuka dari file://</b>. Firebase Auth/Firestore sering gagal dari file lokal.` +
          `<br>Solusi: deploy ke GitHub Pages (https) lalu buka dari URL tersebut.`
        );
      }

      if (!hints.length) {
        hints.push(
          `Cek juga: (1) Firestore aktif, (2) Anonymous Auth enabled, (3) Authorized domains benar, (4) Rules Firestore/Storage.`
        );
      }

      return { raw, hintsHtml: '<ul class="list-disc pl-5 space-y-1">' + hints.map(h => `<li>${h}</li>`).join('') + '</ul>' };
    }

    function updateCloudStatusUI(text) {
      const el = document.getElementById('cloudStatus');
      if (el) el.innerHTML = `Status: <span class="font-semibold">${text}</span>`;

      // header indicator
      const nav = document.getElementById('cloudNavStatus');
      const dot = document.getElementById('cloudNavDot');
      const t = document.getElementById('cloudNavText');
      const enabled = !!load(LS.cloudEnabled, false);
      const hasCfg = !!String(load(LS.cloudConfig, '') || '').trim();
      const hasShop = !!String(load(LS.cloudShopId, '') || '').trim();
      // Cloud pill in header is always visible so user can open Cloud Sync settings
      if (nav) nav.classList.remove('hidden');

      if (dot) {
        const online = String(text || '').toLowerCase().includes('connected');
        dot.className = 'h-2 w-2 rounded-full ' + (online ? 'bg-emerald-500' : (enabled || (hasCfg && hasShop)) ? 'bg-amber-400' : 'bg-slate-300');
      }
      if (t) {
        const short = (enabled || (hasCfg && hasShop) || cloud.connected)
          ? (String(text || 'Offline').startsWith('Connected') ? 'Cloud: Online' : 'Cloud: Ready')
          : 'Cloud: Offline';
        t.textContent = short;
      }
    }

    const DEFAULT_FIREBASE_CONFIG = {
      apiKey: "AIzaSyCewjyEJF3MTJGY6mAc6K_6uRKvZIyxnzY",
      authDomain: "belanja-buah-segar.firebaseapp.com",
      projectId: "belanja-buah-segar",
      storageBucket: "belanja-buah-segar.firebasestorage.app",
      messagingSenderId: "153003646850",
      appId: "1:153003646850:web:e45ea618cdb8cdbbd1399b",
      measurementId: "G-C5CV3QZQDJ"
    };

    // Ensure default Firebase config + default Shop ID exist in localStorage.
    // This does NOT override user-entered settings.
    function ensureCloudDefaults({ enable = false } = {}) {
      const existingCfg = String(load(LS.cloudConfig, '') || '').trim();
      const existingShop = String(load(LS.cloudShopId, '') || '').trim();

      if (!existingCfg) {
        save(LS.cloudConfig, JSON.stringify(DEFAULT_FIREBASE_CONFIG, null, 2));
      }
      if (!existingShop) {
        // Default shop ID (must be same across devices to sync)
        save(LS.cloudShopId, 'varsha-shop-01');
      }
      if (enable) {
        save(LS.cloudEnabled, true);
      }

      return {
        configText: String(load(LS.cloudConfig, '') || '').trim(),
        shopId: String(load(LS.cloudShopId, '') || '').trim()
      };
    }

    function parseFirebaseConfigText(text) {
      const raw = (text || '').trim();
      if (!raw) throw new Error('Firebase config kosong');

      // 1) Strict JSON
      try {
        const obj = JSON.parse(raw);
        if (obj && typeof obj === 'object') return obj;
      } catch {}

      // 2) JS snippet: const firebaseConfig = { ... };
      const first = raw.indexOf('{');
      const last = raw.lastIndexOf('}');
      if (first === -1 || last === -1 || last <= first) {
        throw new Error('Firebase config tidak valid. Tempel JSON atau snippet firebaseConfig.');
      }
      const objLiteral = raw.slice(first, last + 1);

      try {
        // Evaluate object literal only
        const obj = (new Function(`return (${objLiteral});`))();
        if (!obj || typeof obj !== 'object') throw new Error('not_object');
        return obj;
      } catch {
        throw new Error('Firebase config tidak bisa diparse. Pastikan formatnya benar.');
      }
    }

    async function cloudInitFromSavedConfig() {
      const enabled = !!load(LS.cloudEnabled, false);
      if (!enabled) return;
      const cfgText = load(LS.cloudConfig, '');
      const shopId = load(LS.cloudShopId, '');
      if (!cfgText || !shopId) return;
      try {
        await cloudConnect({ configText: cfgText, shopId });
        hideCloudError();
      } catch (e) {
        console.warn('Cloud auto-connect failed', e);
        updateCloudStatusUI('Offline (auto-connect gagal)');
        // show detail in reports page (if user opens it)
        showCloudError(e);
      }
    }

    async function cloudConnect({ configText, shopId }) {
      if (!configText || !shopId) throw new Error('Config/Shop ID kosong');
      const config = parseFirebaseConfigText(configText);
      if (!config.projectId) throw new Error('Firebase config harus memiliki projectId');

      // persist settings
      save(LS.cloudConfig, configText);
      save(LS.cloudShopId, shopId);
      save(LS.cloudEnabled, true);

      cloud.projectId = String(config.projectId || '').trim();
      cloud.shopId = String(shopId || '').trim();
      cloud.rawBucket = String(config.storageBucket || '').trim();
      cloud.bucketCandidates = buildBucketCandidates(config);
      // Do not set cloud.bucket here; we will probe on first upload/test.

      // init firebase once
      if (!cloud.app) {
        cloud.app = firebase.initializeApp(config);
        cloud.auth = firebase.auth();
        cloud.db = firebase.firestore();
        cloud.storage = firebase.storage();
      }

      // sign-in anonymous
      if (!cloud.auth.currentUser) {
        await cloud.auth.signInAnonymously();
      }

      cloud.connected = true;
      const bucketInfo = cloud.bucket ? ` ‚Ä¢ bucket=${cloud.bucket}` : (cloud.rawBucket ? ` ‚Ä¢ bucket(raw)=${cloud.rawBucket}` : '');
      updateCloudStatusUI(`Connected ‚Ä¢ projectId=${cloud.projectId}${bucketInfo} ‚Ä¢ shop=${cloud.shopId}`);

      // set baseline for new order notification
      const currentTx = getTransactions();
      if (currentTx.length) setLastSeenTxId(currentTx[0].id);

      // start realtime listener
      await cloudStartListener(shopId);

      return true;
    }

    async function cloudDisconnect(opts = {}) {
      const silent = !!opts.silent;
      const keepEnabled = !!opts.keepEnabled;
      if (cloud.unsub) {
        try { cloud.unsub(); } catch {}
        cloud.unsub = null;
      }
      cloud.connected = false;
      if (!keepEnabled) save(LS.cloudEnabled, false);
      updateCloudStatusUI('Offline');
      if (!silent) toast('Cloud sync dimatikan (disconnect).');
    }

    function cloudDocRef(shopId) {
      return cloud.db.collection('varsha_shops').doc(shopId);
    }

    async function cloudPush(shopId, opts = {}) {
      if (!cloud.connected) throw new Error('Belum connect');
      const deviceId = getOrCreateDeviceId();
      const snap = snapshotData();
      const raw = stableStringify(snap);
      const hash = hashString(raw);
      cloud.lastLocalPushedHash = hash;
      const ref = cloudDocRef(shopId);
      await ref.set({
        schemaVersion: 1,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: deviceId,
        rev: uid('REV'),
        hash,
        data: snap
      }, { merge: true });
      if (!opts?.silent) toast('Push ke cloud berhasil.');
      updateCloudStatusUI(`Connected ‚Ä¢ Last push ${new Date().toLocaleTimeString('id-ID')}`);
    }

    async function cloudPull(shopId, opts = {}) {
      if (!cloud.connected) throw new Error('Belum connect');
      const ref = cloudDocRef(shopId);
      const doc = await ref.get();
      if (!doc.exists) {
        if (!opts?.noToastEmpty && !opts?.silent) toast('Cloud masih kosong.');
        return { empty: true };
      }
      const payload = doc.data();
      const data = payload?.data;
      if (!data) {
        if (!opts?.silent) toast('Data cloud tidak ditemukan.');
        return { empty: false, applied: false };
      }
      cloud.applyingRemote = true;
      try {
        applySnapshotToLocal(data);
        // baseline last seen tx
        if (Array.isArray(data.transactions) && data.transactions.length) setLastSeenTxId(data.transactions[0].id);
        if (!opts?.silent) toast('Pull dari cloud berhasil.');
        rerenderAll();
        if (!opts?.noRoute) routeTo(state.route);
        return { empty: false, applied: true };
      } finally {
        cloud.applyingRemote = false;
      }
    }

    async function cloudStartListener(shopId) {
      if (cloud.unsub) {
        try { cloud.unsub(); } catch {}
        cloud.unsub = null;
      }
      const ref = cloudDocRef(shopId);
      const deviceId = getOrCreateDeviceId();

      cloud.unsub = ref.onSnapshot((doc) => {
        if (!doc.exists) return;
        const payload = doc.data();
        const rev = payload?.rev || null;
        const updatedBy = payload?.updatedBy || '';
        const hash = payload?.hash || '';
        const data = payload?.data;

        // ignore if this update is from this device and same hash
        if (updatedBy === deviceId && hash && hash === cloud.lastLocalPushedHash) return;
        if (rev && rev === cloud.lastRemoteRev) return;
        if (!data) return;

        cloud.lastRemoteRev = rev;
        if (cloud.applyingRemote) return;

        cloud.applyingRemote = true;
        try {
          // notify admin if there's a new transaction
          maybeNotifyNewOrder(data);

          applySnapshotToLocal(data);
          rerenderAll();
          // do not force route changes
          updateCloudStatusUI(`Connected ‚Ä¢ Updated from cloud ${new Date().toLocaleTimeString('id-ID')}`);
        } finally {
          cloud.applyingRemote = false;
        }
      }, (err) => {
        console.warn('Cloud listener error', err);
        updateCloudStatusUI('Connected (listener error)');
      });
    }

    // Auto-push on local changes (debounced)
    const cloudAuto = { t: null, disabled: 0 };
    function cloudScheduleAutoPush() {
      const enabled = !!load(LS.cloudEnabled, false);
      const shopId = load(LS.cloudShopId, '');
      if (!enabled || !cloud.connected || !shopId) return;
      if (cloud.applyingRemote) return;
      if ((cloudAuto.disabled || 0) > 0) return;
      clearTimeout(cloudAuto.t);
      cloudAuto.t = setTimeout(async () => {
        try {
          await cloudPush(shopId, { silent: true });
        } catch (e) {
          console.warn('Auto-push failed', e);
        }
      }, 900);
    }

    // Hook: whenever we save core data, schedule autopush
    const _setProducts = setProducts;
    setProducts = function(products) {
      _setProducts(products);
      cloudScheduleAutoPush();
    };
    const _setTransactions = setTransactions;
    setTransactions = function(txs) {
      _setTransactions(txs);
      cloudScheduleAutoPush();
    };
    const _setPurchases = setPurchases;
    setPurchases = function(p) {
      _setPurchases(p);
      cloudScheduleAutoPush();
    };
    const _setCart = setCart;
    setCart = function(c) {
      _setCart(c);
      cloudScheduleAutoPush();
    };

    /**********************
     * Rerender helper
     **********************/
    function rerenderAll() {
      // update pieces that may be visible
      renderCart();
      if (state.route === 'market') renderMarketplace();
      if (state.route === 'admin.dashboard') renderDashboard();
      if (state.route === 'admin.products') renderAdminProducts();
      if (state.route === 'admin.purchases') renderPurchases();
      if (state.route === 'admin.promos') renderPromos();
      if (state.route === 'admin.shipping') renderShipping();
      if (state.route === 'admin.transactions') renderTransactions();
      if (state.route === 'customer.shipping') renderCustomerShipping();
    }

    /**********************
     * Events
     **********************/
    function bindEvents() {
      document.querySelectorAll('[data-route]').forEach(btn => {
        btn.addEventListener('click', () => routeTo(btn.dataset.route));
      });

      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          document.getElementById('mobileNav')?.classList.toggle('hidden');
        });
      }

      // (Sidebar admin sudah dihapus; menu admin sekarang ada di footer untuk role admin)

      // Marketplace filters
      document.getElementById('categoryFilter').addEventListener('change', (e) => {
        state.categoryFilter = e.target.value;
        renderMarketplace();
      });
      document.querySelectorAll('.cat-pill').forEach(btn => {
        btn.addEventListener('click', () => {
          state.categoryFilter = btn.dataset.cat;
          document.getElementById('categoryFilter').value = state.categoryFilter;
          renderMarketplace();
        });
      });
      document.getElementById('searchInput').addEventListener('input', (e) => {
        state.search = e.target.value;
        renderMarketplace();
      });
      document.getElementById('resetSearchBtn').addEventListener('click', () => {
        state.search = '';
        document.getElementById('searchInput').value = '';
        renderMarketplace();
      });
      // Hero CTA handled by applyHeroToMarketplace() so it can be configurable
      // (no direct binding here)

      // Cloud Sync modal open
      const cloudNavStatusBtn = document.getElementById('cloudNavStatus');
      const openCloudSyncBtnReports = document.getElementById('openCloudSyncBtnReports');

      function openCloudSyncModal() {
        const modal = document.getElementById('cloudSyncModal');
        if (!modal) return;

        // hydrate saved settings (ensure defaults exist first)
        try { ensureCloudDefaults({ enable: false }); } catch {}
        const shop = String(load(LS.cloudShopId, '') || '').trim();
        const cfg = String(load(LS.cloudConfig, '') || '').trim();
        const shopEl = document.getElementById('cloudShopId');
        const cfgEl = document.getElementById('cloudConfigJson');
        if (shopEl && !shopEl.value) shopEl.value = shop;
        if (cfgEl && !cfgEl.value) cfgEl.value = cfg;

        // show modal
        modal.classList.remove('hidden');

        // update status text inside modal
        if (cloud.connected) updateCloudStatusUI(`Connected ‚Ä¢ projectId=${cloud.projectId} ‚Ä¢ shop=${cloud.shopId}`);
        else {
          const hasCfg = !!cfg;
          const hasShop = !!shop;
          updateCloudStatusUI((hasCfg && hasShop) ? 'Ready (saved config)' : 'Offline');
        }
      }

      if (cloudNavStatusBtn && !cloudNavStatusBtn._boundOpen) {
        cloudNavStatusBtn.addEventListener('click', openCloudSyncModal);
        cloudNavStatusBtn._boundOpen = true;
      }
      if (openCloudSyncBtnReports && !openCloudSyncBtnReports._boundOpen) {
        openCloudSyncBtnReports.addEventListener('click', openCloudSyncModal);
        openCloudSyncBtnReports._boundOpen = true;
      }

      // Hidden access: double click logo -> Maintain Profile (Admin + kode referensi)
      const brandBtn = document.getElementById('brandBtn');
      if (brandBtn && !brandBtn._boundDbl) {
        brandBtn.addEventListener('dblclick', async () => {
          if (!isAdmin()) {
            toast('Akses ditolak. Khusus Admin.');
            return;
          }
          const code = prompt('Masukkan Kode Referensi Admin untuk akses Maintain Profile:');
          if (code === null) return;
          try {
            // must match admin reference hash (same as in authRegister)
            const ADMIN_REF_HASH = 'e12d51b1';
            if (simpleHash(String(code).trim()) !== ADMIN_REF_HASH) {
              toast('Kode referensi tidak valid.');
              return;
            }
            routeTo('admin.profile');
          } catch (e) {
            console.warn(e);
            toast('Gagal membuka Maintain Profile.');
          }
        });
        brandBtn._boundDbl = true;
      }

      // Auth
      const openAuthBtn = document.getElementById('openAuthBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const authTabLogin = document.getElementById('authTabLogin');
      const authTabRegister = document.getElementById('authTabRegister');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');

      function openAuthModal(tab = 'login') {
        document.getElementById('authModal').classList.remove('hidden');
        setAuthTab(tab);
        if (tab === 'login') document.getElementById('loginEmail')?.focus();
        else document.getElementById('regName')?.focus();
      }

      function setAuthTab(tab) {
        const isLogin = tab === 'login';
        if (loginForm) loginForm.classList.toggle('hidden', !isLogin);
        if (registerForm) registerForm.classList.toggle('hidden', isLogin);
        if (authTabLogin) {
          authTabLogin.classList.toggle('bg-white', isLogin);
          authTabLogin.classList.toggle('border', isLogin);
          authTabLogin.classList.toggle('hover:bg-white/60', !isLogin);
        }
        if (authTabRegister) {
          authTabRegister.classList.toggle('bg-white', !isLogin);
          authTabRegister.classList.toggle('border', !isLogin);
          authTabRegister.classList.toggle('hover:bg-white/60', isLogin);
        }
      }

      if (openAuthBtn) openAuthBtn.addEventListener('click', () => openAuthModal('login'));
      if (authTabLogin) authTabLogin.addEventListener('click', () => setAuthTab('login'));
      if (authTabRegister) authTabRegister.addEventListener('click', () => setAuthTab('register'));

      const logoutBtnCustomer = document.getElementById('logoutBtnCustomer');

      async function doLogout() {
        try {
          if (cloud?.connected) await cloudDisconnect({ silent: true });
        } catch {}
        authLogout();
        toast('Berhasil keluar.');
        applyRoleUI();
        routeTo('market');
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', doLogout);
      }
      if (logoutBtnCustomer) {
        logoutBtnCustomer.addEventListener('click', doLogout);
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            authLogin({
              email: document.getElementById('loginEmail').value,
              password: document.getElementById('loginPassword').value
            });
            closeModal('authModal');
            applyRoleUI();

            // Ensure default Firebase config + Shop ID exist, then auto-connect + pull
            try {
              ensureCloudDefaults({ enable: true });
              updateCloudStatusUI('Connecting...');
              const res = await cloudEnsureConnected({ silent: true, forceConnect: true });
              if (res?.ok && res?.shopId) await cloudAutoPullIfNeeded('login');
            } catch {}

            toast('Login berhasil.');
            // route based on role
            routeTo(isAdmin() ? 'admin.dashboard' : 'market');
          } catch (err) {
            toast(err?.message || 'Login gagal.');
          }
        });
      }

      if (registerForm) {
        // Toggle admin ref code field
        const regRoleEl = document.getElementById('regRole');
        const adminRefWrap = document.getElementById('adminRefWrap');
        const regAdminCode = document.getElementById('regAdminCode');

        function syncAdminRefVisibility() {
          const isAdm = (regRoleEl?.value === 'admin');
          if (adminRefWrap) adminRefWrap.classList.toggle('hidden', !isAdm);
          if (!isAdm && regAdminCode) regAdminCode.value = '';

          const waEl = document.getElementById('regWhatsApp');
          if (waEl) {
            // WA wajib untuk customer, opsional untuk admin
            waEl.disabled = isAdm;
            waEl.classList.toggle('bg-slate-100', isAdm);
            waEl.classList.toggle('cursor-not-allowed', isAdm);
            if (isAdm) waEl.value = '';
          }
        }

        if (regRoleEl && !regRoleEl._boundAdminRef) {
          regRoleEl.addEventListener('change', syncAdminRefVisibility);
          regRoleEl._boundAdminRef = true;
        }
        // initial
        syncAdminRefVisibility();

        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            authRegister({
              name: document.getElementById('regName').value,
              email: document.getElementById('regEmail').value,
              whatsApp: document.getElementById('regWhatsApp')?.value,
              password: document.getElementById('regPassword').value,
              role: document.getElementById('regRole').value,
              adminCode: document.getElementById('regAdminCode')?.value
            });
            closeModal('authModal');
            applyRoleUI();

            // Ensure default Firebase config + Shop ID exist, then auto-connect + pull
            try {
              ensureCloudDefaults({ enable: true });
              updateCloudStatusUI('Connecting...');
              const res = await cloudEnsureConnected({ silent: true, forceConnect: true });
              if (res?.ok && res?.shopId) await cloudAutoPullIfNeeded('register');
            } catch {}

            toast('Registrasi berhasil.');
            routeTo(isAdmin() ? 'admin.dashboard' : 'market');
          } catch (err) {
            toast(err?.message || 'Registrasi gagal.');
          }
        });
      }

      // Reload (pull from cloud if available)
      const reloadBtn = document.getElementById('reloadBtn');
      if (reloadBtn) {
        reloadBtn.addEventListener('click', async () => {
          try {
            reloadBtn.disabled = true;
            reloadBtn.classList.add('opacity-60');

            // Try connect + pull (if config exists). If cloud empty, push local baseline.
            const res = await cloudEnsureConnected({ silent: true, forceConnect: true });
            if (res.ok && res.shopId) {
              const pullRes = await cloudPull(res.shopId, { silent: true, noRoute: true, noToastEmpty: true });
              if (pullRes?.empty) {
                await cloudPush(res.shopId, { silent: true });
                toast('Cloud kosong. Data lokal dikirim ke Cloud.');
              } else {
                toast('Reload selesai (Cloud Sync).');
              }
              hideCloudError();
            } else {
              toast('Reload selesai.');
            }

            rerenderAll();
          } catch (e) {
            console.warn(e);
            toast('Reload gagal. Cek Cloud Sync.');
            showCloudError(e);
          } finally {
            reloadBtn.disabled = false;
            reloadBtn.classList.remove('opacity-60');
          }
        });
      }

      // Cart
      document.getElementById('openCartBtn').addEventListener('click', openCart);
      document.getElementById('closeCartBtn').addEventListener('click', closeCart);
      document.getElementById('closeCartArea').addEventListener('click', closeCart);
      document.getElementById('clearCartBtn').addEventListener('click', clearCart);
      document.getElementById('checkoutBtn').addEventListener('click', openCheckout);

      // Modals close (use closest so clicking SVG inside button still closes)
      document.body.addEventListener('click', (e) => {
        const t = e.target;
        const closer = t?.closest ? t.closest('[data-close]') : null;
        if (closer?.dataset?.close) closeModal(closer.dataset.close);
      });

      // Checkout submit (Order - tanpa kirim WA)
      document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('buyerName').value.trim();
        const whatsApp = document.getElementById('buyerWhatsApp').value.trim();
        const address = document.getElementById('buyerAddress').value.trim();
        const note = document.getElementById('buyerNote')?.value?.trim() || '';
        if (!name || !whatsApp || !address) return;

        // Buat order & catat transaksi (akan push ke cloud jika Cloud Sync aktif)
        await doCheckout({ name, whatsApp, address, note });
      });

      // Product modal open
      document.getElementById('addProductBtn').addEventListener('click', () => openProductModal(null));

      // Product image upload
      const uploadBtn = document.getElementById('uploadProductImageBtn');
      if (uploadBtn && !uploadBtn._bound) {
        uploadBtn.addEventListener('click', async () => {
          const fileEl = document.getElementById('productImageFile');
          const urlEl = document.getElementById('productImage');
          const idEl = document.getElementById('productId');
          const file = fileEl?.files?.[0];

          // if creating new product, create a stable temp id so filename doesn't change
          let pid = (idEl?.value || '').trim();
          if (!pid) {
            pid = uid('PRD');
            if (idEl) idEl.value = pid;
          }

          try {
            uploadBtn.disabled = true;
            uploadBtn.classList.add('opacity-60');
            uploadBtn.textContent = 'Uploading...';
            const { url, bucket } = await uploadProductImageToCloud({ file, productId: pid });
            if (urlEl) urlEl.value = url;
            updateProductImagePreview(url);
            if (bucket) updateCloudStatusUI(`Connected ‚Ä¢ projectId=${cloud.projectId} ‚Ä¢ bucket=${bucket} ‚Ä¢ shop=${cloud.shopId}`);
            toast('Upload gambar berhasil.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal upload gambar.');
            // Also show detail in the Cloud Sync troubleshooting panel (useful for Storage errors)
            showCloudError(e);
          } finally {
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('opacity-60');
            uploadBtn.textContent = 'Upload';
          }
        });
        uploadBtn._bound = true;
      }

      // Product form submit
      document.getElementById('productForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = {
          id: document.getElementById('productId').value,
          name: document.getElementById('productName').value,
          category: document.getElementById('productCategory').value,
          stock: document.getElementById('productStock').value,
          priceBuy: document.getElementById('productBuy').value,
          priceSell: document.getElementById('productSell').value,
          image: document.getElementById('productImage').value
        };
        upsertProduct(data);
      });

      // Maintain Profile (Store)
      const applyProfilePreviewBtn = document.getElementById('applyProfilePreviewBtn');
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      const resetProfileBtn = document.getElementById('resetProfileBtn');
      const uploadProfileLogoBtn = document.getElementById('uploadProfileLogoBtn');
      const saveProfileLogoBtn = document.getElementById('saveProfileLogoBtn');
      const profileLogoUrlEl = document.getElementById('profileLogoUrl');

      if (applyProfilePreviewBtn && !applyProfilePreviewBtn._bound) {
        applyProfilePreviewBtn.addEventListener('click', applyProfilePreviewFromInputs);
        applyProfilePreviewBtn._bound = true;
      }
      if (profileLogoUrlEl && !profileLogoUrlEl._boundPreview) {
        profileLogoUrlEl.addEventListener('input', () => applyProfilePreviewFromInputs());
        profileLogoUrlEl._boundPreview = true;
      }

      if (uploadProfileLogoBtn && !uploadProfileLogoBtn._bound) {
        uploadProfileLogoBtn.addEventListener('click', async () => {
          const fileEl = document.getElementById('profileLogoFile');
          const urlEl = document.getElementById('profileLogoUrl');
          const file = fileEl?.files?.[0];
          try {
            uploadProfileLogoBtn.disabled = true;
            uploadProfileLogoBtn.classList.add('opacity-60');
            uploadProfileLogoBtn.textContent = 'Uploading...';
            const { url } = await uploadStoreLogoToCloud(file);
            if (urlEl) urlEl.value = url;
            applyProfilePreviewFromInputs();
            toast('Upload logo berhasil. Klik Simpan untuk menerapkan.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal upload logo.');
            showCloudError(e);
          } finally {
            uploadProfileLogoBtn.disabled = false;
            uploadProfileLogoBtn.classList.remove('opacity-60');
            uploadProfileLogoBtn.textContent = 'Upload';
          }
        });
        uploadProfileLogoBtn._bound = true;
      }

      if (saveProfileLogoBtn && !saveProfileLogoBtn._bound) {
        saveProfileLogoBtn.addEventListener('click', async () => {
          const url = String(document.getElementById('profileLogoUrl')?.value || '').trim();
          if (!url) return toast('URL Logo masih kosong. Upload atau isi URL dulu.');
          try {
            saveProfileLogoBtn.disabled = true;
            saveProfileLogoBtn.classList.add('opacity-60');
            saveProfileLogoBtn.textContent = 'Menyimpan...';

            await cloudSyncWrite(() => {
              const p = getStoreProfile();
              p.logoUrl = url;
              setStoreProfile(p);
            }, { reason: 'saveProfileLogo' });

            applyStoreProfileToUI();
            applyProfilePreviewFromInputs();
            toast('Logo tersimpan.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal simpan logo.');
          } finally {
            saveProfileLogoBtn.disabled = false;
            saveProfileLogoBtn.classList.remove('opacity-60');
            saveProfileLogoBtn.textContent = 'Simpan Logo';
          }
        });
        saveProfileLogoBtn._bound = true;
      }

      if (saveProfileBtn && !saveProfileBtn._bound) {
        saveProfileBtn.addEventListener('click', async () => {
          const payload = {
            storeName: String(document.getElementById('profileStoreName')?.value || '').trim(),
            tagline: String(document.getElementById('profileTagline')?.value || '').trim(),
            address: String(document.getElementById('profileAddress')?.value || '').trim(),
            bankName: String(document.getElementById('profileBankName')?.value || '').trim(),
            bankAccount: String(document.getElementById('profileBankAccount')?.value || '').trim(),
            bankHolder: String(document.getElementById('profileBankHolder')?.value || '').trim(),
            logoUrl: String(document.getElementById('profileLogoUrl')?.value || '').trim()
          };

          try {
            saveProfileBtn.disabled = true;
            saveProfileBtn.classList.add('opacity-60');
            saveProfileBtn.textContent = 'Menyimpan...';

            await cloudSyncWrite(() => {
              setStoreProfile(payload);
            }, { reason: 'saveProfile' });

            applyStoreProfileToUI();
            toast('Profile toko disimpan.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal simpan profile.');
          } finally {
            saveProfileBtn.disabled = false;
            saveProfileBtn.classList.remove('opacity-60');
            saveProfileBtn.textContent = 'Simpan';
          }
        });
        saveProfileBtn._bound = true;
      }

      if (resetProfileBtn && !resetProfileBtn._bound) {
        resetProfileBtn.addEventListener('click', async () => {
          if (!confirm('Reset profile toko ke default?')) return;
          try {
            await cloudSyncWrite(() => {
              setStoreProfile(DEFAULT_PROFILE);
            }, { reason: 'resetProfile' });
            // clear inputs so renderAdminProfile can re-fill
            ['profileStoreName','profileTagline','profileAddress','profileBankName','profileBankAccount','profileBankHolder','profileLogoUrl'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = '';
            });
            applyStoreProfileToUI();
            renderAdminProfile();
            toast('Profile direset.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal reset profile.');
          }
        });
        resetProfileBtn._bound = true;
      }

      // Maintain Hero
      const applyHeroPreviewBtn = document.getElementById('applyHeroPreviewBtn');
      const saveHeroBtn = document.getElementById('saveHeroBtn');
      const resetHeroBtn = document.getElementById('resetHeroBtn');

      if (applyHeroPreviewBtn && !applyHeroPreviewBtn._bound) {
        applyHeroPreviewBtn.addEventListener('click', applyHeroPreviewFromInputs);
        applyHeroPreviewBtn._bound = true;
      }

      if (saveHeroBtn && !saveHeroBtn._bound) {
        saveHeroBtn.addEventListener('click', async () => {
          const next = {
            badge: document.getElementById('heroBadgeInput')?.value || DEFAULT_HERO.badge,
            headlineHtml: document.getElementById('heroHeadlineInput')?.value || DEFAULT_HERO.headlineHtml,
            subheadline: document.getElementById('heroSubheadlineInput')?.value || DEFAULT_HERO.subheadline,
            ctaLabel: document.getElementById('heroCtaLabelInput')?.value || DEFAULT_HERO.ctaLabel,
            ctaAction: document.getElementById('heroCtaActionInput')?.value || DEFAULT_HERO.ctaAction
          };
          try {
            saveHeroBtn.disabled = true;
            saveHeroBtn.classList.add('opacity-60');
            saveHeroBtn.textContent = 'Menyimpan...';

            await cloudSyncWrite(() => {
              setHeroSettings(next);
            }, { reason: 'saveHero' });

            applyHeroToMarketplace();
            toast('Hero disimpan.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal simpan hero.');
          } finally {
            saveHeroBtn.disabled = false;
            saveHeroBtn.classList.remove('opacity-60');
            saveHeroBtn.textContent = 'Simpan';
          }
        });
        saveHeroBtn._bound = true;
      }

      if (resetHeroBtn && !resetHeroBtn._bound) {
        resetHeroBtn.addEventListener('click', async () => {
          if (!confirm('Reset hero ke default?')) return;
          try {
            await cloudSyncWrite(() => {
              setHeroSettings(DEFAULT_HERO);
            }, { reason: 'resetHero' });
            // clear inputs so renderAdminHero re-fill
            ['heroBadgeInput','heroHeadlineInput','heroSubheadlineInput','heroCtaLabelInput'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = '';
            });
            const act = document.getElementById('heroCtaActionInput');
            if (act) act.value = DEFAULT_HERO.ctaAction;
            renderAdminHero();
            applyHeroToMarketplace();
            toast('Hero direset.');
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Gagal reset hero.');
          }
        });
        resetHeroBtn._bound = true;
      }

      // Admin products filters
      document.getElementById('adminProductSearch').addEventListener('input', (e) => {
        state.adminProductSearch = e.target.value;
        renderAdminProducts();
      });
      document.getElementById('adminProductSearchClear').addEventListener('click', () => {
        state.adminProductSearch = '';
        document.getElementById('adminProductSearch').value = '';
        renderAdminProducts();
      });
      document.getElementById('adminCategoryFilter').addEventListener('change', (e) => {
        state.adminCategoryFilter = e.target.value;
        renderAdminProducts();
      });
      document.getElementById('seedStockLowBtn').addEventListener('click', () => {
        state.stockLowOnly = !state.stockLowOnly;
        document.getElementById('seedStockLowBtn').textContent = state.stockLowOnly ? 'Tampilkan Semua' : 'Filter Stok < 10';
        renderAdminProducts();
      });

      // Purchases
      document.getElementById('purchaseForm').addEventListener('submit', (e) => {
        e.preventDefault();
        addPurchase({
          productId: document.getElementById('purchaseProduct').value,
          qty: document.getElementById('purchaseQty').value,
          buyPrice: document.getElementById('purchaseBuyPrice').value,
          sellPrice: document.getElementById('purchaseSellPrice').value
        });
        document.getElementById('purchaseBuyPrice').value = '';
        document.getElementById('purchaseSellPrice').value = '';
        document.getElementById('purchaseQty').value = 1;
      });
      document.getElementById('purchaseFormReset').addEventListener('click', () => {
        document.getElementById('purchaseQty').value = 1;
        document.getElementById('purchaseBuyPrice').value = '';
        document.getElementById('purchaseSellPrice').value = '';
      });
      document.getElementById('exportPurchasesCsv').addEventListener('click', exportPurchasesReport);

      // Promos
      document.getElementById('promoForm').addEventListener('submit', (e) => {
        e.preventDefault();
        savePromo({
          productId: document.getElementById('promoProduct').value,
          discountPct: document.getElementById('promoDiscount').value,
          start: document.getElementById('promoStart').value,
          end: document.getElementById('promoEnd').value,
          active: document.getElementById('promoActive').checked
        });
      });
      document.getElementById('clearPromoBtn').addEventListener('click', () => {
        const id = document.getElementById('promoProduct').value;
        if (!id) return;
        if (!confirm('Hapus promo untuk produk ini?')) return;
        clearPromo(id);
      });
      document.getElementById('refreshPromoBtn').addEventListener('click', renderPromos);

      // Dashboard period select
      document.getElementById('periodSelect').addEventListener('change', (e) => {
        const v = e.target.value;
        if (v !== 'custom') {
          const r = getRangeFromPeriod(v);
          document.getElementById('dateFrom').value = r.from;
          document.getElementById('dateTo').value = r.to;
        }
      });

      document.getElementById('applyPeriodBtn').addEventListener('click', () => {
        const period = document.getElementById('periodSelect').value;
        let r;
        if (period !== 'custom') r = getRangeFromPeriod(period);
        else r = { from: document.getElementById('dateFrom').value, to: document.getElementById('dateTo').value };
        state.dashboardRange = r;
        renderDashboard();
      });
      document.getElementById('resetDemoDataBtn').addEventListener('click', () => {
        if (!confirm('Reset data demo? Ini akan menghapus transaksi/pembelian dan mengganti produk.') ) return;
        resetDemoData();
      });

      // Shipping filters
      const shipSearchEl = document.getElementById('shipSearch');
      const shipSearchResetEl = document.getElementById('shipSearchReset');
      const shipStatusFilterEl = document.getElementById('shipStatusFilter');
      const exportShippingCsvEl = document.getElementById('exportShippingCsv');

      if (shipSearchEl) {
        shipSearchEl.addEventListener('input', (e) => {
          state.shipSearch = e.target.value;
          renderShipping();
        });
      }
      if (shipSearchResetEl) {
        shipSearchResetEl.addEventListener('click', () => {
          state.shipSearch = '';
          if (shipSearchEl) shipSearchEl.value = '';
          renderShipping();
        });
      }
      if (shipStatusFilterEl) {
        shipStatusFilterEl.addEventListener('change', (e) => {
          state.shipStatus = e.target.value;
          renderShipping();
        });
      }
      if (exportShippingCsvEl) {
        exportShippingCsvEl.addEventListener('click', exportShippingReport);
      }

      // Customer shipping status filters
      const custShipLoginBtn = document.getElementById('custShipLoginBtn');
      if (custShipLoginBtn && !custShipLoginBtn._bound) {
        custShipLoginBtn.addEventListener('click', () => {
          document.getElementById('authModal')?.classList.remove('hidden');
        });
        custShipLoginBtn._bound = true;
      }

      const custShipSearchEl = document.getElementById('custShipSearch');
      const custShipResetEl = document.getElementById('custShipSearchReset');
      const custShipStatusEl = document.getElementById('custShipStatusFilter');

      if (custShipSearchEl) {
        custShipSearchEl.addEventListener('input', (e) => {
          state.custShipSearch = e.target.value;
          renderCustomerShipping();
        });
      }
      if (custShipResetEl) {
        custShipResetEl.addEventListener('click', () => {
          state.custShipSearch = '';
          if (custShipSearchEl) custShipSearchEl.value = '';
          renderCustomerShipping();
        });
      }
      if (custShipStatusEl) {
        custShipStatusEl.addEventListener('change', (e) => {
          state.custShipStatus = e.target.value;
          renderCustomerShipping();
        });
      }

      // Transactions filters
      document.getElementById('txSearch').addEventListener('input', (e) => {
        state.txSearch = e.target.value;
        renderTransactions();
      });
      document.getElementById('txSearchReset').addEventListener('click', () => {
        state.txSearch = '';
        document.getElementById('txSearch').value = '';
        renderTransactions();
      });
      document.getElementById('txApply').addEventListener('click', () => {
        state.txRange = { from: document.getElementById('txFrom').value, to: document.getElementById('txTo').value };
        renderTransactions();
      });
      document.getElementById('exportSalesCsv').addEventListener('click', exportSalesReport);
      document.getElementById('clearTransactionsBtn').addEventListener('click', () => {
        if (!confirm('Hapus semua transaksi?')) return;
        setTransactions([]);
        toast('Semua transaksi dihapus.');
        rerenderAll();
      });

      // Reports buttons
      document.getElementById('reportSalesBtn').addEventListener('click', exportSalesReport);
      document.getElementById('reportPurchasesBtn').addEventListener('click', exportPurchasesReport);
      document.getElementById('reportStockBtn').addEventListener('click', exportStockReport);

      // Backup / Restore
      const exportBtn = document.getElementById('exportAllDataBtn');
      const importBtn = document.getElementById('importAllDataBtn');
      const importInput = document.getElementById('importDataInput');
      if (exportBtn && importBtn && importInput) {
        exportBtn.addEventListener('click', exportAllData);
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', async () => {
          const file = importInput.files && importInput.files[0];
          if (!file) return;
          if (!confirm('Import backup akan menimpa data di gadget ini. Lanjutkan?')) {
            importInput.value = '';
            return;
          }
          await importAllDataFromFile(file);
          importInput.value = '';
        });
      }

      // Order Webhook (alternative)
      const orderWebhookEnabledEl = document.getElementById('orderWebhookEnabled');
      const orderWebhookUrlEl = document.getElementById('orderWebhookUrl');
      const saveOrderWebhookBtn = document.getElementById('saveOrderWebhookBtn');
      const testOrderWebhookBtn = document.getElementById('testOrderWebhookBtn');

      // Admin WhatsApp (for Checkout -> Kirim WA)
      const adminWhatsAppInput = document.getElementById('adminWhatsAppInput');
      const saveAdminWhatsAppBtn = document.getElementById('saveAdminWhatsAppBtn');
      const clearAdminWhatsAppBtn = document.getElementById('clearAdminWhatsAppBtn');

      if (orderWebhookEnabledEl) orderWebhookEnabledEl.checked = !!load(LS.orderWebhookEnabled, false);
      if (orderWebhookUrlEl) orderWebhookUrlEl.value = load(LS.orderWebhookUrl, '') || '';
      updateOrderWebhookStatusUI();

      // Load WA admin setting
      if (adminWhatsAppInput) adminWhatsAppInput.value = String(load(LS.adminWhatsApp, '') || '').trim();

      if (saveOrderWebhookBtn) {
        saveOrderWebhookBtn.addEventListener('click', () => {
          const enabled = !!orderWebhookEnabledEl?.checked;
          const url = String(orderWebhookUrlEl?.value || '').trim();
          save(LS.orderWebhookEnabled, enabled);
          save(LS.orderWebhookUrl, url);
          updateOrderWebhookStatusUI();
          toast('Setting webhook disimpan.');
        });
      }

      if (testOrderWebhookBtn) {
        testOrderWebhookBtn.addEventListener('click', async () => {
          try {
            const enabled = !!orderWebhookEnabledEl?.checked;
            const url = String(orderWebhookUrlEl?.value || '').trim();
            save(LS.orderWebhookEnabled, enabled);
            save(LS.orderWebhookUrl, url);
            updateOrderWebhookStatusUI('Testing...');
            await testOrderWebhook();
            toast('Test webhook sukses.');
            updateOrderWebhookStatusUI('OK');
            setTimeout(() => updateOrderWebhookStatusUI(), 1200);
          } catch (e) {
            console.warn(e);
            toast(e?.message || 'Test webhook gagal.');
            updateOrderWebhookStatusUI('Gagal');
            setTimeout(() => updateOrderWebhookStatusUI(), 1600);
          }
        });
      }

      // Save / clear WA admin
      if (saveAdminWhatsAppBtn) {
        saveAdminWhatsAppBtn.addEventListener('click', () => {
          const v = String(adminWhatsAppInput?.value || '').trim();
          save(LS.adminWhatsApp, v);
          toast('Nomor WA Admin disimpan.');
        });
      }
      if (clearAdminWhatsAppBtn) {
        clearAdminWhatsAppBtn.addEventListener('click', () => {
          save(LS.adminWhatsApp, '');
          if (adminWhatsAppInput) adminWhatsAppInput.value = '';
          toast('Nomor WA Admin dihapus.');
        });
      }

      // Cloud Sync (Firebase) - now in header modal
      const cloudConnectBtn = document.getElementById('cloudConnectBtn');
      const cloudDisconnectBtn = document.getElementById('cloudDisconnectBtn');
      const cloudPullBtn = document.getElementById('cloudPullBtn');
      const cloudPushBtn = document.getElementById('cloudPushBtn');
      const cloudFillDefaultBtn = document.getElementById('cloudFillDefaultBtn');
      const cloudClearConfigBtn = document.getElementById('cloudClearConfigBtn');
      const cloudShopId = document.getElementById('cloudShopId');
      const cloudConfigJson = document.getElementById('cloudConfigJson');

      if (cloudFillDefaultBtn && cloudConfigJson && !cloudFillDefaultBtn._bound) {
        cloudFillDefaultBtn.addEventListener('click', () => {
          cloudConfigJson.value = JSON.stringify(DEFAULT_FIREBASE_CONFIG, null, 2);
          toast('Config default diisi.');
        });
        cloudFillDefaultBtn._bound = true;
      }
      if (cloudClearConfigBtn && cloudConfigJson && !cloudClearConfigBtn._bound) {
        cloudClearConfigBtn.addEventListener('click', () => {
          cloudConfigJson.value = '';
          toast('Config dikosongkan.');
        });
        cloudClearConfigBtn._bound = true;
      }

      if (cloudConnectBtn && !cloudConnectBtn._bound) {
        cloudConnectBtn.addEventListener('click', async () => {
          const shopId = (cloudShopId?.value || '').trim();
          const configText = (cloudConfigJson?.value || '').trim();
          if (!shopId) return toast('Shop ID harus diisi.');
          if (!configText) return toast('Firebase config JSON harus diisi.');
          try {
            await cloudConnect({ configText, shopId });
            hideCloudError();
            toast('Cloud sync tersambung.');
          } catch (e) {
            console.warn(e);
            toast('Gagal connect cloud. Buka Cloud Sync untuk lihat detail.');
            updateCloudStatusUI('Offline');
            showCloudError(e);
          }
        });
        cloudConnectBtn._bound = true;
      }
      if (cloudDisconnectBtn && !cloudDisconnectBtn._bound) {
        cloudDisconnectBtn.addEventListener('click', async () => {
          await cloudDisconnect();
          hideCloudError();
        });
        cloudDisconnectBtn._bound = true;
      }
      if (cloudPullBtn && !cloudPullBtn._bound) {
        cloudPullBtn.addEventListener('click', async () => {
          const shopId = (cloudShopId?.value || load(LS.cloudShopId, '')).trim();
          if (!shopId) return toast('Shop ID harus diisi.');
          if (!cloud.connected) return toast('Silakan Connect dulu.');
          if (!confirm('Pull akan menimpa data di gadget ini dengan data cloud. Lanjutkan?')) return;
          try {
            await cloudPull(shopId);
            hideCloudError();
          } catch (e) {
            console.warn(e);
            toast('Gagal pull. Buka Cloud Sync untuk lihat detail.');
            showCloudError(e);
          }
        });
        cloudPullBtn._bound = true;
      }
      if (cloudPushBtn && !cloudPushBtn._bound) {
        cloudPushBtn.addEventListener('click', async () => {
          const shopId = (cloudShopId?.value || load(LS.cloudShopId, '')).trim();
          if (!shopId) return toast('Shop ID harus diisi.');
          if (!cloud.connected) return toast('Silakan Connect dulu.');
          if (!confirm('Push akan menimpa data cloud dengan data gadget ini. Lanjutkan?')) return;
          try {
            await cloudPush(shopId);
            hideCloudError();
          } catch (e) {
            console.warn(e);
            toast('Gagal push. Buka Cloud Sync untuk lihat detail.');
            showCloudError(e);
          }
        });
        cloudPushBtn._bound = true;
      }

      // GitHub Pages helper: copy rules
      const copyFirestoreRulesBtn = document.getElementById('copyFirestoreRulesBtn');
      const copyStorageRulesBtn = document.getElementById('copyStorageRulesBtn');

      async function copyText(text) {
        const t = (text || '').trim();
        if (!t) return;
        try {
          await navigator.clipboard.writeText(t);
          toast('Tersalin ke clipboard.');
        } catch {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = t;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          toast('Tersalin ke clipboard.');
        }
      }

      function copyTextFromEl(el) {
        return copyText((el?.textContent || ''));
      }

      if (copyFirestoreRulesBtn) {
        copyFirestoreRulesBtn.addEventListener('click', () => copyTextFromEl(document.getElementById('firestoreRulesSample')));
      }
      if (copyStorageRulesBtn) {
        copyStorageRulesBtn.addEventListener('click', () => copyTextFromEl(document.getElementById('storageRulesSample')));
      }

      // Deployment helper (domain / url)
      const hostEl = document.getElementById('currentHost');
      const originEl = document.getElementById('currentOrigin');
      const warnEl = document.getElementById('fileProtocolWarn');
      if (hostEl) hostEl.textContent = window.location.host || '(no host)';
      if (originEl) originEl.textContent = window.location.origin || window.location.href;
      if (warnEl) warnEl.classList.toggle('hidden', window.location.protocol !== 'file:');

      const copyDomainBtn = document.getElementById('copyAuthorizedDomainBtn');
      const copyUrlBtn = document.getElementById('copySiteUrlBtn');
      if (copyDomainBtn) {
        copyDomainBtn.addEventListener('click', () => {
          const domain = window.location.host || '';
          if (!domain) return toast('Domain tidak tersedia.');
          copyText(domain);
        });
      }
      if (copyUrlBtn) {
        copyUrlBtn.addEventListener('click', () => {
          const url = window.location.origin || window.location.href;
          copyText(url);
        });
      }
    }

    /**********************
     * Init
     **********************/
    ensureData();
    ensureDefaultAccounts();
    bindEvents();
    applyRoleUI();
    // Apply store profile (logo/name) early
    try { applyStoreProfileToUI(); } catch {}

    // Ensure Firebase config default is always set (without overriding existing settings)
    ensureCloudDefaults({ enable: false });

    // seed dashboard range
    const initRange = getRangeFromPeriod('month');
    state.dashboardRange = initRange;
    document.getElementById('dateFrom').value = initRange.from;
    document.getElementById('dateTo').value = initRange.to;

    // initial renders
    fillProductSelects();
    renderCart();
    renderCustomerShipping();
    routeTo('market');

    // update header indicator from saved setting
    const hasCfg = !!String(load(LS.cloudConfig, '') || '').trim();
    const hasShop = !!String(load(LS.cloudShopId, '') || '').trim();
    updateCloudStatusUI((hasCfg && hasShop) ? 'Ready (saved config)' : 'Offline');

    // Auto-connect on open if config exists (per request)
    // If connected, do an initial pull (and push if cloud empty)
    (async () => {
      try {
        // Always ensure defaults exist, then auto-connect on open
        ensureCloudDefaults({ enable: false });
        const res = await cloudEnsureConnected({ silent: true, forceConnect: true });
        if (res.ok && res.shopId) {
          await cloudAutoPullIfNeeded('init');
        }
      } catch (e) {
        console.warn(e);
      }
    })();
  </script>
</body>
</html>
